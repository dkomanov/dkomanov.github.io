{"componentChunkName":"component---src-templates-blog-post-js","path":"/p/java-exploring-jni-performance-via-decoding-base64/","result":{"data":{"markdownRemark":{"id":"c17f770a-421a-516a-8923-1597d0fbc5cb","excerpt":"It’s time to consolidate my Base64 findings: take the best of JVM world, the best of Rust world and benchmark it together from within the JVM. In this article I…","html":"<p>It’s time to consolidate my <a href=\"https://en.wikipedia.org/wiki/Base64\">Base64</a> findings: take the best of <a href=\"/p/base64-encoding-performance-jdk-vs-apache-commons\">JVM</a> world, the best of <a href=\"/p/base64-encoding-performance-java-vs-rust\">Rust</a> world and benchmark it together from <a href=\"/p/java-native-access-performance\">within</a> the JVM.</p>\n<p>In this article I’m going to benchmark Base64 encoding/decoding performance of <a href=\"https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Base64.html\">java.util.Base64</a> versus <a href=\"https://crates.io/crates/base64\">base64</a> and <a href=\"https://github.com/Nugine/simd\">base64-simd</a> crates via <a href=\"https://docs.oracle.com/en/java/javase/17/docs/specs/jni/index.html\">JNI</a>. Along the way we will explore intricacies of calling native libraries from JVM and ways to improve its performance.</p>\n<p>Let’s start from beginning…</p>\n<h2 id=\"how-to-jni\" style=\"position:relative;\"><a href=\"#how-to-jni\" aria-label=\"how to jni permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How to JNI?</h2>\n<p>There are multiple resources on how to work with JNI. For example this <a href=\"https://www.baeldung.com/jni\">guide</a>. Because I’m going to use Rust, the relevant guide is on the <a href=\"https://docs.rs/jni/latest/jni/\">jni crate</a> documentation itself. Basically, we start with something simple:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>komanov<span class=\"token punctuation\">.</span>jwt<span class=\"token punctuation\">.</span>base64<span class=\"token punctuation\">.</span>jni</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">NativeBazel</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">static</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">loadLibrary</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"base64_lib\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">native</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token function\">decodeConfigUrlSafe1</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> encoded<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Then we need to generate a C-header file for it:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">java -h NativeBazel.java</code></pre></div>\n<p>In return we get file <code class=\"language-text\">com_komanov_jwt_base64_jni_NativeBazel.h</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">/* DO NOT EDIT THIS FILE - it is machine generated */</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;jni.h></span></span>\n<span class=\"token comment\">/* Header for class com_komanov_jwt_base64_jni_NativeBazel */</span>\n\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifndef</span> <span class=\"token expression\">_Included_com_komanov_jwt_base64_jni_NativeBazel</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">_Included_com_komanov_jwt_base64_jni_NativeBazel</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">__cplusplus</span></span>\n<span class=\"token keyword\">extern</span> <span class=\"token string\">\"C\"</span> <span class=\"token punctuation\">{</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span>\n<span class=\"token comment\">/*\n * Class:     com_komanov_jwt_base64_jni_NativeBazel\n * Method:    decodeConfigUrlSafe1\n * Signature: ([B)[B\n */</span>\nJNIEXPORT jbyteArray JNICALL\n  <span class=\"token function\">Java_com_komanov_jwt_base64_jni_NativeBazel_decodeConfigUrlSafe1</span>\n  <span class=\"token punctuation\">(</span>JNIEnv <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> jclass<span class=\"token punctuation\">,</span> jbyteArray<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">__cplusplus</span></span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></code></pre></div>\n<p>And for Rust we need to create a file (we need to use a generated function name <code class=\"language-text\">Java_com_komanov_jwt_base64_jni_NativeBazel_decodeConfigUrlSafe1</code>, but it’s very long, so I cut it just for the post to look good):</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">use</span> base64<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">jni<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">JNIEnv</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">jni<span class=\"token punctuation\">::</span>objects<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">JClass</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">jni<span class=\"token punctuation\">::</span>sys<span class=\"token punctuation\">::</span></span>jbyteArray<span class=\"token punctuation\">;</span>\n\n<span class=\"token attribute attr-name\">#[no_mangle]</span>\n<span class=\"token keyword\">pub</span> <span class=\"token keyword\">extern</span> <span class=\"token string\">\"system\"</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">decodeConfigUrlSafe1</span><span class=\"token punctuation\">(</span>\n  env<span class=\"token punctuation\">:</span> <span class=\"token class-name\">JNIEnv</span><span class=\"token punctuation\">,</span>\n  _class<span class=\"token punctuation\">:</span> <span class=\"token class-name\">JClass</span><span class=\"token punctuation\">,</span>\n  payload<span class=\"token punctuation\">:</span> jbyteArray<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> jbyteArray <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token namespace\">base64<span class=\"token punctuation\">::</span></span><span class=\"token function\">decode_config</span><span class=\"token punctuation\">(</span>\n    env<span class=\"token punctuation\">.</span><span class=\"token function\">convert_byte_array</span><span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token namespace\">base64<span class=\"token punctuation\">::</span></span><span class=\"token constant\">URL_SAFE_NO_PAD</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> env<span class=\"token punctuation\">.</span><span class=\"token function\">byte_array_from_slice</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This would be our first and the simplest implementation using <a href=\"https://docs.rs/base64/latest/base64/\">base64</a> crate.</p>\n<p>Also, don’t forget to make your native library (libbase64_lib.so in case of Linux) discoverable to JVM by specifying it’s location via command line argument <code class=\"language-text\">-Djava.library.path=</code>.</p>\n<h2 id=\"the-first-benchmark\" style=\"position:relative;\"><a href=\"#the-first-benchmark\" aria-label=\"the first benchmark permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The First Benchmark</h2>\n<p>Next thing is to write a benchmark Java vs Rust via JNI. Easy, right? First results:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark              (length)      Score       Error  Units\n\njdk_url_decode              100    232.112 ±     3.565  ns/op\njni_url_decodeConfig1       100    662.213 ±    30.668  ns/op\n\njdk_url_decode            10000  19530.268 ±   590.507  ns/op\njni_url_decodeConfig1     10000  12403.311 ±    99.469  ns/op</code></pre></div>\n<p>And the chart for all payload sizes (openjdk-17, for previous versions JDK implementation performs slightly worse):</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b4b020794b28f08d13a5caa32a62c6ea/e1190/decode1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25.945945945945947%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAoklEQVQY021QCQ7DMAjr/59bLeEwxBN06Q4tkiGRsGNzrLVoZsxMRsQb9f5BfmJd8ypGAISD53nyUNX/QsCNDDBfJDejTaHOSXlMmlz8MlbnGGMQW8yUYcJQoYsQKjQRytiYlCmEe6M4O1n1Ej2qeA2UfQNFrNF3A82DQNCx3cd3IkRHLsF2WGX/UqJNdnBlEnBmE3E72vuu3rsDWGsrY+XwCW18ib3OKX1tAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Performance of JDK vs base64::decode_config ver. 1\"\n        title=\"Performance of JDK vs base64::decode_config ver. 1\"\n        src=\"/static/b4b020794b28f08d13a5caa32a62c6ea/50383/decode1.png\"\n        srcset=\"/static/b4b020794b28f08d13a5caa32a62c6ea/1d79a/decode1.png 185w,\n/static/b4b020794b28f08d13a5caa32a62c6ea/1efb2/decode1.png 370w,\n/static/b4b020794b28f08d13a5caa32a62c6ea/50383/decode1.png 740w,\n/static/b4b020794b28f08d13a5caa32a62c6ea/73caa/decode1.png 1110w,\n/static/b4b020794b28f08d13a5caa32a62c6ea/536c7/decode1.png 1480w,\n/static/b4b020794b28f08d13a5caa32a62c6ea/e1190/decode1.png 2203w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Somewhere between payload size of 500 and 1000 performance converges and then Rust via JNI starts to perform better. However… If we take a look on the Rust performance without JNI, we would see <a href=\"/data/charts/base64-rust/base64_decode_config/index.html\">this</a>:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/702723c701b6bae20b511fcae0f7689b/260cd/decode1_rust.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 57.83783783783784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA8ElEQVQoz41Tiw6DMAjs//+rMat9AspyxHaNq3MklyLQE050tVYloimQW9fVsCyLhhCUmae1fNY7POz7fovjOAwwnC0uQx4ni2jOWZ2I6C9rhCNGI2ZNOWspxdAJZxfviOBXIo0paS7FuoUZITR5ItRhZOgEolKrjdrinXDU6a4j1KAYRCAcNR1rjfAu2YhyIyL6GntKOGrYDDEIDSI6JXmU5aohjM8vBvCfRNOR0UX/YpM1mq3LzGyxX95riNG23S5iaUU+CyzSl7fFcV591KSU1HnvLRBjtJYxKn4xvA2AjxoANSZLSt1HPp8Sbdumb/rAs49TqfCHAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Performance of base64::decode_config ver. 1 without JNI\"\n        title=\"Performance of base64::decode_config ver. 1 without JNI\"\n        src=\"/static/702723c701b6bae20b511fcae0f7689b/50383/decode1_rust.png\"\n        srcset=\"/static/702723c701b6bae20b511fcae0f7689b/1d79a/decode1_rust.png 185w,\n/static/702723c701b6bae20b511fcae0f7689b/1efb2/decode1_rust.png 370w,\n/static/702723c701b6bae20b511fcae0f7689b/50383/decode1_rust.png 740w,\n/static/702723c701b6bae20b511fcae0f7689b/73caa/decode1_rust.png 1110w,\n/static/702723c701b6bae20b511fcae0f7689b/536c7/decode1_rust.png 1480w,\n/static/702723c701b6bae20b511fcae0f7689b/260cd/decode1_rust.png 1845w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>It’s actually pretty close: 12.4 μs (microseconds) with JNI vs 10.2 μs without JNI. Approximately 20% overhead of JNI. Let’s try to decrease it.</p>\n<h2 id=\"optimize-it\" style=\"position:relative;\"><a href=\"#optimize-it\" aria-label=\"optimize it permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Optimize It!</h2>\n<p><strong>Disclaimer 1</strong>: I didn’t save actual results from all different runs, so I’m going to use the final results, but I’m going to describe everything in the more or less the same order as I proceeded during my research.</p>\n<p><strong>Disclaimer 2</strong>: micro-optimizations aren’t simple, the benchmarking results are not <a href=\"http://wiki.jvmlangsummit.com/images/1/1d/PerformanceAnxiety2010.pdf\">that simple</a>, beware of it — you need to benchmark your system yourself, sometimes successful benchmark of a smaller thing may not be visible after integration to a bigger system.</p>\n<p>Let’s take a look at the implementation again:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token attribute attr-name\">#[no_mangle]</span>\n<span class=\"token keyword\">pub</span> <span class=\"token keyword\">extern</span> <span class=\"token string\">\"system\"</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">decodeConfigUrlSafe1</span><span class=\"token punctuation\">(</span>\n  env<span class=\"token punctuation\">:</span> <span class=\"token class-name\">JNIEnv</span><span class=\"token punctuation\">,</span>\n  _class<span class=\"token punctuation\">:</span> <span class=\"token class-name\">JClass</span><span class=\"token punctuation\">,</span>\n  payload<span class=\"token punctuation\">:</span> jbyteArray<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> jbyteArray <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token namespace\">base64<span class=\"token punctuation\">::</span></span><span class=\"token function\">decode_config</span><span class=\"token punctuation\">(</span>\n    env<span class=\"token punctuation\">.</span><span class=\"token function\">convert_byte_array</span><span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token namespace\">base64<span class=\"token punctuation\">::</span></span><span class=\"token constant\">URL_SAFE_NO_PAD</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> env<span class=\"token punctuation\">.</span><span class=\"token function\">byte_array_from_slice</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Here we perform 3 operations:</p>\n<ol>\n<li><a href=\"https://docs.rs/jni/latest/jni/struct.JNIEnv.html#method.convert_byte_array\">env.convert_byte_array</a> converts <code class=\"language-text\">byte[]</code> to <code class=\"language-text\">Vec&lt;u8></code>: we can’t access directly byte array, because it’s in a managed heap of JVM and may be moved.</li>\n<li><a href=\"https://docs.rs/base64/latest/base64/fn.decode_config.html\">decode_config</a> decodes Base64.</li>\n<li><a href=\"https://docs.rs/jni/latest/jni/struct.JNIEnv.html#method.byte_array_from_slice\">env.byte_array_from_slice</a> converts <code class=\"language-text\">[u8]</code> (byte slice) back to <code class=\"language-text\">byte[]</code>.</li>\n</ol>\n<p>Let’s try to replace certain parts and see how it affects the performance.</p>\n<h3 id=\"use-get_byte_array_elements-instead-of-convert_byte_array\" style=\"position:relative;\"><a href=\"#use-get_byte_array_elements-instead-of-convert_byte_array\" aria-label=\"use get_byte_array_elements instead of convert_byte_array permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use get_byte_array_elements instead of convert_byte_array</h3>\n<p>There are few methods for working with array, one of them is <a href=\"https://docs.rs/jni/latest/jni/struct.JNIEnv.html#method.get_byte_array_elements\">get_byte_array_elements</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token attribute attr-name\">#[no_mangle]</span>\n<span class=\"token keyword\">pub</span> <span class=\"token keyword\">extern</span> <span class=\"token string\">\"system\"</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">decodeConfigUrlSafe2</span><span class=\"token punctuation\">(</span>\n  env<span class=\"token punctuation\">:</span> <span class=\"token class-name\">JNIEnv</span><span class=\"token punctuation\">,</span>\n  _class<span class=\"token punctuation\">:</span> <span class=\"token class-name\">JClass</span><span class=\"token punctuation\">,</span>\n  payload<span class=\"token punctuation\">:</span> jbyteArray<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> jbyteArray <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> arr <span class=\"token operator\">=</span> env<span class=\"token punctuation\">.</span><span class=\"token function\">get_byte_array_elements</span><span class=\"token punctuation\">(</span>\n    payload<span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\">ReleaseMode</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">NoCopyBack</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> sl <span class=\"token operator\">=</span> <span class=\"token keyword\">unsafe</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">from_raw_parts</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">.</span><span class=\"token function\">as_ptr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token operator\">*</span><span class=\"token keyword\">mut</span> <span class=\"token keyword\">u8</span><span class=\"token punctuation\">,</span> arr<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">usize</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token namespace\">base64<span class=\"token punctuation\">::</span></span><span class=\"token function\">decode_config</span><span class=\"token punctuation\">(</span>sl<span class=\"token punctuation\">,</span> <span class=\"token namespace\">base64<span class=\"token punctuation\">::</span></span><span class=\"token constant\">URL_SAFE_NO_PAD</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> env<span class=\"token punctuation\">.</span><span class=\"token function\">byte_array_from_slice</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And the benchmark:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark              (length)      Score       Error  Units\n\njni_url_decodeConfig1       100    662.213 ±    30.668  ns/op\njni_url_decodeConfig2       100    538.772 ±     4.381  ns/op\n\njni_url_decodeConfig1     10000  12403.311 ±    99.469  ns/op\njni_url_decodeConfig2     10000  12355.233 ±   620.308  ns/op</code></pre></div>\n<p>Slightly better.</p>\n<h3 id=\"passing-array-size-explicitly\" style=\"position:relative;\"><a href=\"#passing-array-size-explicitly\" aria-label=\"passing array size explicitly permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Passing array size explicitly</h3>\n<p>Under the hood of <code class=\"language-text\">arr.size()</code> is another call to <code class=\"language-text\">JNIEnv</code> object to <a href=\"https://docs.rs/jni/latest/jni/struct.JNIEnv.html#method.get_array_length\">get_array_length</a> method. Instead of that we can pass array’s length via arguments (and hope that marshalling of <code class=\"language-text\">int</code> is very cheap):</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token attribute attr-name\">#[no_mangle]</span>\n<span class=\"token keyword\">pub</span> <span class=\"token keyword\">extern</span> <span class=\"token string\">\"system\"</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">decodeConfigUrlSafe3</span><span class=\"token punctuation\">(</span>\n  env<span class=\"token punctuation\">:</span> <span class=\"token class-name\">JNIEnv</span><span class=\"token punctuation\">,</span>\n  _class<span class=\"token punctuation\">:</span> <span class=\"token class-name\">JClass</span><span class=\"token punctuation\">,</span>\n  payload<span class=\"token punctuation\">:</span> jbyteArray<span class=\"token punctuation\">,</span>\n  size<span class=\"token punctuation\">:</span> <span class=\"token keyword\">usize</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> jbyteArray <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> arr <span class=\"token operator\">=</span> env<span class=\"token punctuation\">.</span><span class=\"token function\">get_byte_array_elements</span><span class=\"token punctuation\">(</span>\n    payload<span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\">ReleaseMode</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">NoCopyBack</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> sl <span class=\"token operator\">=</span> <span class=\"token keyword\">unsafe</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">from_raw_parts</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">.</span><span class=\"token function\">as_ptr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token operator\">*</span><span class=\"token keyword\">mut</span> <span class=\"token keyword\">u8</span><span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token namespace\">base64<span class=\"token punctuation\">::</span></span><span class=\"token function\">decode_config</span><span class=\"token punctuation\">(</span>sl<span class=\"token punctuation\">,</span> <span class=\"token namespace\">base64<span class=\"token punctuation\">::</span></span><span class=\"token constant\">URL_SAFE_NO_PAD</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> env<span class=\"token punctuation\">.</span><span class=\"token function\">byte_array_from_slice</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And the benchmark:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark              (length)      Score       Error  Units\n\njni_url_decodeConfig2       100    538.772 ±     4.381  ns/op\njni_url_decodeConfig3       100    505.095 ±    44.893  ns/op\n\njni_url_decodeConfig2     10000  12355.233 ±   620.308  ns/op\njni_url_decodeConfig3     10000  12252.848 ±    40.396  ns/op</code></pre></div>\n<p>Slightly better.</p>\n<h3 id=\"use-get_primitive_array_critical-instead-of-get_byte_array_elements\" style=\"position:relative;\"><a href=\"#use-get_primitive_array_critical-instead-of-get_byte_array_elements\" aria-label=\"use get_primitive_array_critical instead of get_byte_array_elements permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use get_primitive_array_critical instead of get_byte_array_elements</h3>\n<p>Yet another way of accessing <code class=\"language-text\">byte[]</code> is by using <a href=\"https://docs.rs/jni/latest/jni/struct.JNIEnv.html#method.get_primitive_array_critical\">get_primitive_array_critical</a>. There’s <a href=\"https://stackoverflow.com/questions/23258357/whats-the-trade-off-between-using-getprimitivearraycritical-and-getprimitivety\">caveat</a> of using this method: it may prevent Garbage Collector from running, so it’s assumed that this method should be accessed for a short period of time, without any extra calls to JNI.</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">pub</span> <span class=\"token keyword\">extern</span> <span class=\"token string\">\"system\"</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">decodeConfigUrlSafe4</span><span class=\"token punctuation\">(</span>\n  env<span class=\"token punctuation\">:</span> <span class=\"token class-name\">JNIEnv</span><span class=\"token punctuation\">,</span>\n  _class<span class=\"token punctuation\">:</span> <span class=\"token class-name\">JClass</span><span class=\"token punctuation\">,</span>\n  payload<span class=\"token punctuation\">:</span> jbyteArray<span class=\"token punctuation\">,</span>\n  size<span class=\"token punctuation\">:</span> <span class=\"token keyword\">usize</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> jbyteArray <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> arr <span class=\"token operator\">=</span> env<span class=\"token punctuation\">.</span><span class=\"token function\">get_primitive_array_critical</span><span class=\"token punctuation\">(</span>\n    payload<span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\">ReleaseMode</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">NoCopyBack</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">let</span> sl <span class=\"token operator\">=</span> <span class=\"token keyword\">unsafe</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">from_raw_parts</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">.</span><span class=\"token function\">as_ptr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token operator\">*</span><span class=\"token keyword\">mut</span> <span class=\"token keyword\">u8</span><span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token namespace\">base64<span class=\"token punctuation\">::</span></span><span class=\"token function\">decode_config</span><span class=\"token punctuation\">(</span>sl<span class=\"token punctuation\">,</span> <span class=\"token namespace\">base64<span class=\"token punctuation\">::</span></span><span class=\"token constant\">URL_SAFE_NO_PAD</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> env<span class=\"token punctuation\">.</span><span class=\"token function\">byte_array_from_slice</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And the benchmark:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark              (length)      Score       Error  Units\n\njni_url_decodeConfig3       100    505.095 ±    44.893  ns/op\njni_url_decodeConfig4       100    455.117 ±     3.990  ns/op\n\njni_url_decodeConfig3     10000  12252.848 ±    40.396  ns/op\njni_url_decodeConfig4     10000  11942.370 ±   330.573  ns/op</code></pre></div>\n<p>Slightly better :)</p>\n<h3 id=\"use-base64decode_config_slice\" style=\"position:relative;\"><a href=\"#use-base64decode_config_slice\" aria-label=\"use base64decode_config_slice permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use base64::decode_config_slice</h3>\n<p>At the time of this benchmark, there was a <a href=\"https://github.com/marshallpierce/rust-base64/issues/195\">bug</a> that allocated more memory then needed in <code class=\"language-text\">decode_config</code> method, so I tried to allocate memory by myself:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token attribute attr-name\">#[no_mangle]</span>\n<span class=\"token keyword\">pub</span> <span class=\"token keyword\">extern</span> <span class=\"token string\">\"system\"</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">decodeConfigSliceUrlSafe1</span><span class=\"token punctuation\">(</span>\n  env<span class=\"token punctuation\">:</span> <span class=\"token class-name\">JNIEnv</span><span class=\"token punctuation\">,</span>\n  _class<span class=\"token punctuation\">:</span> <span class=\"token class-name\">JClass</span><span class=\"token punctuation\">,</span>\n  payload<span class=\"token punctuation\">:</span> jbyteArray<span class=\"token punctuation\">,</span>\n  size<span class=\"token punctuation\">:</span> <span class=\"token keyword\">usize</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> jbyteArray <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> buffer <span class=\"token operator\">=</span> <span class=\"token class-name\">Vec</span><span class=\"token punctuation\">::</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">u8</span><span class=\"token operator\">></span><span class=\"token punctuation\">::</span><span class=\"token function\">with_capacity</span><span class=\"token punctuation\">(</span>size <span class=\"token operator\">*</span> <span class=\"token number\">3</span> <span class=\"token operator\">/</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> arr <span class=\"token operator\">=</span> env<span class=\"token punctuation\">.</span><span class=\"token function\">get_byte_array_elements</span><span class=\"token punctuation\">(</span>\n    payload<span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\">ReleaseMode</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">NoCopyBack</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> <span class=\"token punctuation\">(</span>input_slice<span class=\"token punctuation\">,</span> <span class=\"token keyword\">mut</span> output_slice<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">unsafe</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">(</span>\n      <span class=\"token function\">from_raw_parts</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">.</span><span class=\"token function\">as_ptr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token operator\">*</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">u8</span><span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token function\">from_raw_parts_mut</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">.</span><span class=\"token function\">as_mut_ptr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> buffer<span class=\"token punctuation\">.</span><span class=\"token function\">capacity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">let</span> size <span class=\"token operator\">=</span> <span class=\"token namespace\">base64<span class=\"token punctuation\">::</span></span><span class=\"token function\">decode_config_slice</span><span class=\"token punctuation\">(</span>\n    input_slice<span class=\"token punctuation\">,</span>\n    <span class=\"token namespace\">base64<span class=\"token punctuation\">::</span></span><span class=\"token constant\">URL_SAFE_NO_PAD</span><span class=\"token punctuation\">,</span>\n    <span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> output_slice<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// simplified assert, correct probably only for benchmark data.</span>\n  <span class=\"token macro property\">assert_eq!</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">,</span> buffer<span class=\"token punctuation\">.</span><span class=\"token function\">capacity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">unsafe</span> <span class=\"token punctuation\">{</span>\n    buffer<span class=\"token punctuation\">.</span><span class=\"token function\">set_len</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> env<span class=\"token punctuation\">.</span><span class=\"token function\">byte_array_from_slice</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And the benchmark:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark               (length)      Score       Error  Units\n\njni_url_decodeConfig2        100    538.772 ±     4.381  ns/op\njni_url_decodeConfig4        100    455.117 ±     3.990  ns/op\njni_url_decodeConfigSlice1   100    506.076 ±     5.490  ns/op\n\njni_url_decodeConfig2      10000  12355.233 ±   620.308  ns/op\njni_url_decodeConfig4      10000  11942.370 ±   330.573  ns/op\njni_url_decodeConfigSlice1 10000  12318.419 ±   283.668  ns/op</code></pre></div>\n<p>Here we can see, that it performs slightly better than <code class=\"language-text\">decode_config</code> with passing size explicitly optimization. So, we could probably add all other optimizations and it will be slightly better. But what are the next possible optimizations here?</p>\n<p>Actually, we have 2 things going here:</p>\n<ol>\n<li>Marshalling of encoded <code class=\"language-text\">byte[]</code> as input argument.</li>\n<li>Marshalling of decoded result as <code class=\"language-text\">byte[]</code> as returned value.</li>\n</ol>\n<p>Could it be that JVM’s marshalling mechanism isn’t the most robust for our specific problem?</p>\n<h3 id=\"allocate-off-heap-memory-for-the-output\" style=\"position:relative;\"><a href=\"#allocate-off-heap-memory-for-the-output\" aria-label=\"allocate off heap memory for the output permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Allocate off-heap memory for the output</h3>\n<p>For off-heap allocation we can use <a href=\"https://github.com/openjdk/jdk/blob/jdk-19+36/src/java.base/share/classes/jdk/internal/misc/Unsafe.java#L621\">Unsafe</a> class. Method <code class=\"language-text\">allocateMemory</code> will return a <code class=\"language-text\">long</code> value, which represents an address in off-heap memory, which we need to pass via JNI.</p>\n<p>In Java it would look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">native</span> <span class=\"token keyword\">int</span> <span class=\"token function\">decodeConfigSliceUrlSafe2</span><span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> encoded<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">int</span> size<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">long</span> address<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">int</span> outputSize\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>And the Rust implementation:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token attribute attr-name\">#[no_mangle]</span>\n<span class=\"token keyword\">pub</span> <span class=\"token keyword\">extern</span> <span class=\"token string\">\"system\"</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">decodeConfigSliceUrlSafe2</span><span class=\"token punctuation\">(</span>\n  env<span class=\"token punctuation\">:</span> <span class=\"token class-name\">JNIEnv</span><span class=\"token punctuation\">,</span>\n  _class<span class=\"token punctuation\">:</span> <span class=\"token class-name\">JClass</span><span class=\"token punctuation\">,</span>\n  payload<span class=\"token punctuation\">:</span> jbyteArray<span class=\"token punctuation\">,</span>\n  size<span class=\"token punctuation\">:</span> <span class=\"token keyword\">usize</span><span class=\"token punctuation\">,</span>\n  output<span class=\"token punctuation\">:</span> <span class=\"token operator\">*</span><span class=\"token keyword\">mut</span> <span class=\"token keyword\">u8</span><span class=\"token punctuation\">,</span>\n  output_size<span class=\"token punctuation\">:</span> <span class=\"token keyword\">usize</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token keyword\">usize</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> arr <span class=\"token operator\">=</span> env<span class=\"token punctuation\">.</span><span class=\"token function\">get_byte_array_elements</span><span class=\"token punctuation\">(</span>\n    payload<span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\">ReleaseMode</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">NoCopyBack</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">let</span> <span class=\"token punctuation\">(</span>input_slice<span class=\"token punctuation\">,</span> output_slice<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">unsafe</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">(</span>\n      <span class=\"token namespace\">std<span class=\"token punctuation\">::</span>slice<span class=\"token punctuation\">::</span></span><span class=\"token function\">from_raw_parts</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">.</span><span class=\"token function\">as_ptr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token operator\">*</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">u8</span><span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token namespace\">std<span class=\"token punctuation\">::</span>slice<span class=\"token punctuation\">::</span></span><span class=\"token function\">from_raw_parts_mut</span><span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">,</span> output_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token namespace\">base64<span class=\"token punctuation\">::</span></span><span class=\"token function\">decode_config_slice</span><span class=\"token punctuation\">(</span>\n    input_slice<span class=\"token punctuation\">,</span>\n    <span class=\"token namespace\">base64<span class=\"token punctuation\">::</span></span><span class=\"token constant\">URL_SAFE_NO_PAD</span><span class=\"token punctuation\">,</span>\n    output_slice<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>As a result we return an actual number of decoded bytes. And then in Java we need to <a href=\"https://github.com/dkomanov/stuff/blob/7f808056d53fd891bacb83e53f559614c675e693/src/com/komanov/jwt/base64/jni/NativeHelper.java#L10-L14\">create a byte array</a> (by using <a href=\"https://github.com/openjdk/jdk/blob/jdk-19+36/src/jdk.unsupported/share/classes/sun/misc/Unsafe.java#L570\">copyMemory</a>):</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token function\">toByteArray</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> address<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span>length<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">copyMemory</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    address<span class=\"token punctuation\">,</span>\n    result<span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\">Unsafe</span><span class=\"token punctuation\">.</span>ARRAY_BYTE_BASE_OFFSET<span class=\"token punctuation\">,</span>\n    length\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And also the next optimization for it — cache in thread local an off-heap memory, so we don’t need to allocate/release it for each JNI call.</p>\n<p>And the benchmark:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark                      (length)      Score       Error  Units\n\njni_url_decodeConfig2               100    538.772 ±     4.381  ns/op\njni_url_decodeConfig4               100    455.117 ±     3.990  ns/op\njni_url_decodeConfigSlice1          100    506.076 ±     5.490  ns/op\njni_url_decodeConfigSlice1NoCache   100    378.639 ±     3.030  ns/op\njni_url_decodeConfigSlice2Cache     100    292.331 ±     4.535  ns/op\n\njni_url_decodeConfig2             10000  12355.233 ±   620.308  ns/op\njni_url_decodeConfig4             10000  11942.370 ±   330.573  ns/op\njni_url_decodeConfigSlice1        10000  12318.419 ±   283.668  ns/op\njni_url_decodeConfigSlice1NoCache 10000  12322.464 ±    91.313  ns/op\njni_url_decodeConfigSlice2Cache   10000  12071.756 ±   134.344  ns/op</code></pre></div>\n<p>We can see that for smaller payloads performance improvement is pretty much significant. For larger not so much, but still slightly better.</p>\n<h3 id=\"allocate-off-heap-memory-for-both-input-and-output\" style=\"position:relative;\"><a href=\"#allocate-off-heap-memory-for-both-input-and-output\" aria-label=\"allocate off heap memory for both input and output permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Allocate off-heap memory for both input and output</h3>\n<p>So, the next and (almost) the last step is to use off-heap buffers for both input and output data. This way we completely eliminate marshalling of <code class=\"language-text\">byte[]</code> from JVM to native.</p>\n<p>In Java it looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">native</span> <span class=\"token keyword\">int</span> <span class=\"token function\">decodeConfigSliceUrlSafe3</span><span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">long</span> inputAddress<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">int</span> inputSize<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">long</span> outputAddress<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">int</span> outputSize\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>And in Rust:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token attribute attr-name\">#[no_mangle]</span>\n<span class=\"token keyword\">pub</span> <span class=\"token keyword\">extern</span> <span class=\"token string\">\"system\"</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">decodeConfigSliceUrlSafe3</span><span class=\"token punctuation\">(</span>\n  _env<span class=\"token punctuation\">:</span> <span class=\"token class-name\">JNIEnv</span><span class=\"token punctuation\">,</span>\n  _class<span class=\"token punctuation\">:</span> <span class=\"token class-name\">JClass</span><span class=\"token punctuation\">,</span>\n  input<span class=\"token punctuation\">:</span> <span class=\"token operator\">*</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">u8</span><span class=\"token punctuation\">,</span>\n  input_size<span class=\"token punctuation\">:</span> <span class=\"token keyword\">usize</span><span class=\"token punctuation\">,</span>\n  output<span class=\"token punctuation\">:</span> <span class=\"token operator\">*</span><span class=\"token keyword\">mut</span> <span class=\"token keyword\">u8</span><span class=\"token punctuation\">,</span>\n  output_size<span class=\"token punctuation\">:</span> <span class=\"token keyword\">usize</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token keyword\">usize</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> <span class=\"token punctuation\">(</span>input_slice<span class=\"token punctuation\">,</span> output_slice<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">unsafe</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">(</span>\n      <span class=\"token namespace\">std<span class=\"token punctuation\">::</span>slice<span class=\"token punctuation\">::</span></span><span class=\"token function\">from_raw_parts</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">,</span> input_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token namespace\">std<span class=\"token punctuation\">::</span>slice<span class=\"token punctuation\">::</span></span><span class=\"token function\">from_raw_parts_mut</span><span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">,</span> output_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token namespace\">base64<span class=\"token punctuation\">::</span></span><span class=\"token function\">decode_config_slice</span><span class=\"token punctuation\">(</span>\n    input_slice<span class=\"token punctuation\">,</span>\n    <span class=\"token namespace\">base64<span class=\"token punctuation\">::</span></span><span class=\"token constant\">URL_SAFE_NO_PAD</span><span class=\"token punctuation\">,</span>\n    output_slice<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>To copy input <code class=\"language-text\">byte[]</code> to off-heap we may use <a href=\"https://github.com/dkomanov/stuff/blob/7f808056d53fd891bacb83e53f559614c675e693/src/com/komanov/jwt/base64/jni/NativeHelper.java#L16-L18\">this code</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">void</span> <span class=\"token function\">copyFromByteArray</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> address<span class=\"token punctuation\">,</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> input<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> inputSize<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">copyMemory</span><span class=\"token punctuation\">(</span>\n    input<span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\">Unsafe</span><span class=\"token punctuation\">.</span>ARRAY_BYTE_BASE_OFFSET<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    address<span class=\"token punctuation\">,</span>\n    inputSize\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And the benchmark:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark                               (length)      Score       Error  Units\n\njdk_url_decode                               100    232.112 ±     3.565  ns/op\njni_url_decodeConfig1                        100    662.213 ±    30.668  ns/op\njni_url_decodeConfig4                        100    455.117 ±     3.990  ns/op\njni_url_decodeConfigSlice1                   100    506.076 ±     5.490  ns/op\njni_url_decodeConfigSlice1NoCache            100    378.639 ±     3.030  ns/op\njni_url_decodeConfigSlice2Cache              100    292.331 ±     4.535  ns/op\njni_url_decodeConfigSlice3CacheInputOutput   100    182.863 ±    26.261  ns/op\n\njdk_url_decode                             10000  19530.268 ±   590.507  ns/op\njni_url_decodeConfig1                      10000  12403.311 ±    99.469  ns/op\njni_url_decodeConfig4                      10000  11942.370 ±   330.573  ns/op\njni_url_decodeConfigSlice1                 10000  12318.419 ±   283.668  ns/op\njni_url_decodeConfigSlice1NoCache          10000  12322.464 ±    91.313  ns/op\njni_url_decodeConfigSlice2Cache            10000  12071.756 ±   134.344  ns/op\njni_url_decodeConfigSlice3CacheInputOutput 10000  11841.998 ±    60.984  ns/op</code></pre></div>\n<p>And a final chart for different payload sizes:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/343f0c9eaf8ac47aad6a61a70b8226f6/780d5/decode_final.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24.864864864864867%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAApklEQVQY002QiQ7EIAhE/f9/3SbdKoegswGtWZIXDccwocw5oaoYY8Dd4fG++M5l3rNnMRMVgTJn/bo+aEQovBOJ2cIXw/3g5jAVaGtQauDnhtQb1peZMBYUIoKZLxGhpPOGag7y890CD7o0mNIR8u36jRKqZpaIMIQDSlTl1HLhOcPYJhzWe74R6XB91q0sGvfdYmsMRVOtFboHl7ij9549cf9/wR/8A4lcjyN87wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Performance of JDK vs base64::decode_config vs base64::decode_config_slice final version\"\n        title=\"Performance of JDK vs base64::decode_config vs base64::decode_config_slice final version\"\n        src=\"/static/343f0c9eaf8ac47aad6a61a70b8226f6/50383/decode_final.png\"\n        srcset=\"/static/343f0c9eaf8ac47aad6a61a70b8226f6/1d79a/decode_final.png 185w,\n/static/343f0c9eaf8ac47aad6a61a70b8226f6/1efb2/decode_final.png 370w,\n/static/343f0c9eaf8ac47aad6a61a70b8226f6/50383/decode_final.png 740w,\n/static/343f0c9eaf8ac47aad6a61a70b8226f6/73caa/decode_final.png 1110w,\n/static/343f0c9eaf8ac47aad6a61a70b8226f6/536c7/decode_final.png 1480w,\n/static/343f0c9eaf8ac47aad6a61a70b8226f6/780d5/decode_final.png 2306w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2 id=\"the-ultimate-optimization\" style=\"position:relative;\"><a href=\"#the-ultimate-optimization\" aria-label=\"the ultimate optimization permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Ultimate Optimization</h2>\n<p>As I mentioned in update to my <a href=\"/p/base64-encoding-performance-java-vs-rust\">post</a> about Base64 encoding in Rust, the fastest libraries isn’t <a href=\"https://docs.rs/base64/latest/base64/\">base64</a> crate, but <a href=\"https://docs.rs/base64-simd/latest/base64_simd/\">base64-simd</a> crate. Let’s check out what would be if we use it. Also, knowing all these optimizations with off-heap memory and stuff:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token attribute attr-name\">#[no_mangle]</span>\n<span class=\"token keyword\">pub</span> <span class=\"token keyword\">extern</span> <span class=\"token string\">\"system\"</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">decodeSimdNative</span><span class=\"token punctuation\">(</span>\n  _env<span class=\"token punctuation\">:</span> <span class=\"token class-name\">JNIEnv</span><span class=\"token punctuation\">,</span>\n  _class<span class=\"token punctuation\">:</span> <span class=\"token class-name\">JClass</span><span class=\"token punctuation\">,</span>\n  input<span class=\"token punctuation\">:</span> <span class=\"token operator\">*</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">u8</span><span class=\"token punctuation\">,</span>\n  input_size<span class=\"token punctuation\">:</span> <span class=\"token keyword\">usize</span><span class=\"token punctuation\">,</span>\n  output<span class=\"token punctuation\">:</span> <span class=\"token operator\">*</span><span class=\"token keyword\">mut</span> <span class=\"token keyword\">u8</span><span class=\"token punctuation\">,</span>\n  output_size<span class=\"token punctuation\">:</span> <span class=\"token keyword\">usize</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token keyword\">usize</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> <span class=\"token punctuation\">(</span>input_slice<span class=\"token punctuation\">,</span> output_slice<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">unsafe</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">(</span>\n      <span class=\"token function\">from_raw_parts</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">,</span> input_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token function\">from_raw_parts_mut</span><span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">,</span> output_size<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token namespace\">base64_simd<span class=\"token punctuation\">::</span></span><span class=\"token constant\">URL_SAFE_NO_PAD</span><span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>\n    input_slice<span class=\"token punctuation\">,</span>\n    <span class=\"token namespace\">base64_simd<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">OutRef</span><span class=\"token punctuation\">::</span><span class=\"token function\">from_slice</span><span class=\"token punctuation\">(</span>output_slice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  result<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And benchmark results:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark                               (length)      Score       Error  Units\n\njdk_url_decode                               100    232.112 ±     3.565  ns/op\njni_url_decodeConfigSlice3CacheInputOutput   100    182.863 ±    26.261  ns/op\njni_url_decodeSimdCargo                      100     76.619 ±     1.512  ns/op\n\njdk_url_decode                             10000  19530.268 ±   590.507  ns/op\njni_url_decodeConfigSlice3CacheInputOutput 10000  11841.998 ±    60.984  ns/op\njni_url_decodeSimdCargo                    10000   2918.582 ±   196.564  ns/op</code></pre></div>\n<p>Yup, it’s that epic of a difference! Basically, 19 μs vs 3 μs on 10K payload!</p>\n<h3 id=\"sidenote-bazel-vs-cargo\" style=\"position:relative;\"><a href=\"#sidenote-bazel-vs-cargo\" aria-label=\"sidenote bazel vs cargo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Sidenote: bazel vs cargo</h3>\n<p>I generally use <a href=\"https://bazel.build/\">bazel</a> for all my <a href=\"https://github.com/dkomanov/stuff\">stuff</a> that I benchmark and test. But here I stumbled upon bad <a href=\"https://github.com/bazelbuild/rules_rust/\">support</a> for Rust: <a href=\"https://github.com/bazelbuild/intellij/issues/675\">zero support</a> in IntelliJ (there is a Rust plugin <a href=\"https://github.com/vaticle/bazel-intellij-rust-example\">fork</a> with the support, but it includes both bazel BUILD files and cargo files, which confuses me a bit). And the second thing is inability (well, maybe it’s just me) to configure it in a way so the base64-simd implementation would work with optimizations enabled. Here is the comparison of base64-simd built by bazel and by cargo:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1b0a1000b437ae6c710c65495b3d46aa/17fba/bazel-vs-cargo.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.891891891891895%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABZUlEQVQY012Qu0pcURSG9zvEFzBFII2NgRSagJjONo+QVmwCCpqgokJewUYUYsIMgYgWKk7MxTsK47UYFC0Sh0y8zMw5++yzb+cLc+YYgj+s5l+Lj48lrmqa07LhvOIIVQIkJEmCdqAsxI2JY7z33E/im/fOeYyxOOcQua2YjuGQFxMhq8cmPWws9FEv8VY3+uAVOJ3216Uqa8NFvvbvcVG4zKCgY0W1eouUEvF+LaJ9MODZaMDKYRNorUUWHlLPCcKlBzgdpv2vjd/Mdi4y1TbP/mQp7bz1GOfR2mC0RnxcVzx9G9A1FvAlM7TOEv1oJ5gTyNVHeC3TvrxT4VNPgQ/PFzmaOfsHbLzoLmL6u+Lx6zpPhkIWdkNwEdpoZKGVel4gl1vwmeHP/wyLmaHLgHcjNkuGN/mI8c+K4mmAlzVUGKBOBlC7L5EHfUQqwJLwp3TD9rtD1keKXHwr4wBlHM43DRvAvxy7qUG6kNjaAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Bazel vs Cargo performance for base64-simd\"\n        title=\"Bazel vs Cargo performance for base64-simd\"\n        src=\"/static/1b0a1000b437ae6c710c65495b3d46aa/50383/bazel-vs-cargo.png\"\n        srcset=\"/static/1b0a1000b437ae6c710c65495b3d46aa/1d79a/bazel-vs-cargo.png 185w,\n/static/1b0a1000b437ae6c710c65495b3d46aa/1efb2/bazel-vs-cargo.png 370w,\n/static/1b0a1000b437ae6c710c65495b3d46aa/50383/bazel-vs-cargo.png 740w,\n/static/1b0a1000b437ae6c710c65495b3d46aa/73caa/bazel-vs-cargo.png 1110w,\n/static/1b0a1000b437ae6c710c65495b3d46aa/536c7/bazel-vs-cargo.png 1480w,\n/static/1b0a1000b437ae6c710c65495b3d46aa/17fba/bazel-vs-cargo.png 2456w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Yup, it’s 400+ μs vs 3 μs. Very sad. I spent few hours aligning configuration between my cargo project and bazel project, but without success. Other stuff works well: I managed to apply <code class=\"language-text\">--codegen=opt-level=3</code> in bazel, and the performance of <a href=\"https://github.com/dkomanov/stuff/blob/7f808056d53fd891bacb83e53f559614c675e693/src/com/komanov/jwt/base64/jni/jmh/BazelVsCargoBenchmarks.scala#L10\">other stuff</a> is more or less the same, but not base64-simd.</p>\n<p>Of course it’s inconvenient to have a separate Rust project, but this way IntelliJ and optimizations work well.</p>\n<h2 id=\"jni-cost\" style=\"position:relative;\"><a href=\"#jni-cost\" aria-label=\"jni cost permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>JNI Cost</h2>\n<p>Let’s compare JNI call (optimized) vs raw call (for both <a href=\"/data/charts/base64-rust/base64_decode_config/index.html\">base64</a> and <a href=\"/data/charts/base64-rust/base64_simd_decode_type/index.html\">base64-simd</a>):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Method          payload         Raw        JNI\n\nbase64              100      167 ns     182 ns\nbase64-simd         100       46 ns      76 ns\n\nbase64            10000     10.2 μs    11.8 μs\nbase64-simd       10000      1.3 μs     2.9 μs</code></pre></div>\n<p>My guess that these ~30 ns difference (for 100 bytes payload) and ~1.6 μs difference (for 10K payload) is approximate time to do 2 memory copy operations. So, I <a href=\"https://github.com/dkomanov/stuff/commit/817dd679066abc00ad735b083df36ca9b28c4efc\">checked</a> it, and it seems so:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark                   (length)     Score     Error  Units\nfrom_encoded_to_decoded          100    29.547 ±   3.860  ns/op\nfrom_encoded_to_decoded        10000  1664.824 ±  39.950  ns/op</code></pre></div>\n<p>At the end, the overhead of using JNI is marshalling data to and from JNI plus some constant of accessing native code (I got something around 20 ns in a <a href=\"/charts/native-access/\">previous benchmark</a>).</p>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>There are two main outcomes of these benchmarks:</p>\n<ul>\n<li>Native outperforms Java (no surprise).</li>\n<li>There are ways to improve Java-Native interop.</li>\n</ul>\n<p>I’d like to reiterate optimizations:</p>\n<ul>\n<li>Less JNI calls from the Rust (or whatever else native language you use) — the better. We saw slight performance improvement, for example, by removal <code class=\"language-text\">get_array_length</code> call.</li>\n<li>Marshalling works well, but if you don’t need to marshall anything — the better performance would be. Even with double copying (input and output) it’s better. We don’t know if JNI actually copies data or just spends a lot of time ensuring safety with GC, but it’s faster to do 2 extra memory copy operations than marshalling data via JNI API.</li>\n</ul>\n<p>I hope it was interesting enough! In my previous post about <a href=\"/p/java-native-access-performance\">native access performance</a> the example was too simple to assess JNI cost, and here is more real-world-ish example with clear. The cost of going to native is noticeable, but it may be still worth it as in this particular case.</p>\n<p>Play with charts <a href=\"/charts/base64-jni\">here</a>. Source code is on <a href=\"https://github.com/dkomanov/stuff/tree/7f808056d53fd891bacb83e53f559614c675e693/src/com/komanov/jwt/base64/jni/jmh\">GitHub</a>. Originally posted on <a href=\"https://dkomanov.medium.com/a-java-exploring-jni-performance-via-decoding-base64-4388683102a2\">Medium</a>. <a href=\"https://pixabay.com/illustrations/white-male-3d-model-whole-body-1748797/\">Cover image</a> by <a href=\"https://pixabay.com/users/peggy_marco-1553824\">Peggy und Marco Lachmann-Anke</a> with my madskillz from <a href=\"https://pixabay.com/\">Pixabay</a>.</p>","fields":{"slug":"/p/java-exploring-jni-performance-via-decoding-base64/"},"frontmatter":{"rawDate":"2022-10-27T00:00:00.000Z","date":"October 27, 2022","title":"Java: Exploring JNI performance via Decoding Base64","description":"What is the overhead of calling native libraries via JNI? A performance benchmark on a more or less real-world example of decoding Base64.","tags":["java","base64","jni","rust","cargo","bazel","benchmark","performance"],"canonicalUrl":"https://dkomanov.medium.com/a-java-exploring-jni-performance-via-decoding-base64-4388683102a2","cover":{"publicURL":"/static/87c7c7445604fd8fc31dc226ae4694c4/cover.jpg"}}}},"pageContext":{"slug":"/p/java-exploring-jni-performance-via-decoding-base64/","previous":{"fields":{"slug":"/p/java-native-access-performance/"}},"next":null}},"staticQueryHashes":["3675711862"]}