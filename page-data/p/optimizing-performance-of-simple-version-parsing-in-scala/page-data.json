{"componentChunkName":"component---src-templates-blog-post-js","path":"/p/optimizing-performance-of-simple-version-parsing-in-scala/","result":{"data":{"markdownRemark":{"id":"3cbd4d2e-2a04-5034-9a0a-bbfa18e3fb8e","excerpt":"For some time I wanted to write a blog post about performance optimizations: a step by step guide how to improve performance of some small portion of code…","html":"<p>For some time I wanted to write a blog post about performance optimizations: a step by step guide how to improve performance of some small portion of code. Something like I did in the past — <a href=\"/p/micro-optimization-for-uuid-fromstring-in-7-steps\">Micro-optimization for UUID.fromString in 7 steps</a>. And recently I finally found an example from the actual production code, so it won’t be a made up challenge to improve something bad, but something potentially useful :)</p>\n<p>Here I want to demonstrate on a fairly simple example many different aspects of code and how it’s possible to optimize it as much as possible, step by step improving performance by rewriting, redesigning and rewriting again. Without further ado, let’s start!</p>\n<h2 id=\"what-are-we-benchmarking\" style=\"position:relative;\"><a href=\"#what-are-we-benchmarking\" aria-label=\"what are we benchmarking permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What Are We Benchmarking?</h2>\n<p>Use case is very simple, we have this data structure:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">case</span> <span class=\"token keyword\">class</span> Version<span class=\"token punctuation\">(</span>major<span class=\"token operator\">:</span> <span class=\"token builtin\">Int</span><span class=\"token punctuation\">,</span> minor<span class=\"token operator\">:</span> <span class=\"token builtin\">Int</span><span class=\"token punctuation\">,</span> fix<span class=\"token operator\">:</span> <span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">override</span> <span class=\"token keyword\">def</span> toString<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span> <span class=\"token operator\">=</span> <span class=\"token string-interpolation\"><span class=\"token id function\">s</span><span class=\"token string\">\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token expression\">major</span></span><span class=\"token string\">.</span><span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token expression\">minor</span></span><span class=\"token string\">$.fix\"</span></span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Each part of Version is a number between 0 and 10000. A string representation of <code class=\"language-text\">Version(1, 0, 0)</code> would be <code class=\"language-text\">\"1.0.0\"</code>. No semantic versioning, no hyphens etc. Just 2 dots and 3 numbers. And there’s a code for parsing this string representation:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">def</span> parse<span class=\"token punctuation\">(</span>v<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Option<span class=\"token punctuation\">[</span>Version<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> Try <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">val</span> numbers<span class=\"token annotation punctuation\">@Array</span><span class=\"token punctuation\">(</span>major<span class=\"token punctuation\">,</span> minor<span class=\"token punctuation\">,</span> fix<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> v<span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token char\">'.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>map<span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">.</span>toInt<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>numbers<span class=\"token punctuation\">.</span>exists<span class=\"token punctuation\">(</span>num <span class=\"token keyword\">=></span> num <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> num <span class=\"token operator\">></span> MaxVersionSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> RuntimeException<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  Version<span class=\"token punctuation\">(</span>major<span class=\"token punctuation\">,</span> minor<span class=\"token punctuation\">,</span> fix<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span>toOption</code></pre></div>\n<h2 id=\"lets-optimize\" style=\"position:relative;\"><a href=\"#lets-optimize\" aria-label=\"lets optimize permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Let’s Optimize!</h2>\n<p>First, we need to benchmark this code with different inputs:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark       (encoded)  Mode  Cnt     Score     Error  Units\nyolo        200.200.99999  avgt    5  2133.263 ± 218.761  ns/op\nyolo                1.0.0  avgt    5   163.856 ±  12.370  ns/op</code></pre></div>\n<h3 id=\"step-1-exceptions-are-expensive\" style=\"position:relative;\"><a href=\"#step-1-exceptions-are-expensive\" aria-label=\"step 1 exceptions are expensive permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 1. Exceptions Are Expensive</h3>\n<p>In the code above we have <code class=\"language-text\">Try(...).toOption</code>, which means that we ignore all exceptions. If there’s any exception we consider this version invalid — <code class=\"language-text\">None</code>. But we know that exceptions are <a href=\"https://shipilev.net/blog/2014/exceptional-performance/\">very expensive</a>. And the depth of the stack trace makes it more and more expensive. In this case stack trace is very small: it’s a JMH benchmark, so depth is smaller than 20, in a real application it would be significantly larger, meaning even slower. Let’s get rid of a <code class=\"language-text\">throw</code> statement, which is easy:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\">Try <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">val</span> numbers<span class=\"token annotation punctuation\">@Array</span><span class=\"token punctuation\">(</span>major<span class=\"token punctuation\">,</span> minor<span class=\"token punctuation\">,</span> fix<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> v<span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token char\">'.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>map<span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">.</span>toInt<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>numbers<span class=\"token punctuation\">.</span>exists<span class=\"token punctuation\">(</span>num <span class=\"token keyword\">=></span> num <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> num <span class=\"token operator\">></span> MaxVersionSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    None\n  <span class=\"token keyword\">else</span>\n    Some<span class=\"token punctuation\">(</span>Version<span class=\"token punctuation\">(</span>major<span class=\"token punctuation\">,</span> minor<span class=\"token punctuation\">,</span> fix<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span>toOption<span class=\"token punctuation\">.</span>flatten</code></pre></div>\n<p>This version’s benchmarks improved quite a bit for this particular case:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark       (encoded)  Mode  Cnt     Score     Error  Units\nyolo        200.200.99999  avgt    5  2133.263 ± 218.761  ns/op\nyoloNoThrow 200.200.99999  avgt    5   192.138 ±   1.144  ns/op\nyolo                1.0.0  avgt    5   163.856 ±  12.370  ns/op\nyoloNoThrow         1.0.0  avgt    5   163.308 ±  10.761  ns/op</code></pre></div>\n<h3 id=\"step-15-more-issues-to-solve\" style=\"position:relative;\"><a href=\"#step-15-more-issues-to-solve\" aria-label=\"step 15 more issues to solve permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 1.5. More Issues To Solve</h3>\n<p>Well, we solved one case, but it’s not the only one. Let’s see what we actually do here. All the relevant pieces in this single line of code:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">val</span> numbers<span class=\"token annotation punctuation\">@Array</span><span class=\"token punctuation\">(</span>major<span class=\"token punctuation\">,</span> minor<span class=\"token punctuation\">,</span> fix<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> v<span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token char\">'.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>map<span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">.</span>toInt<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Let’s break it down.</p>\n<ol>\n<li><code class=\"language-text\">v.split('.')</code> iterates over entire String, finds dots and creates an array of Strings. To create array it uses intermediate <code class=\"language-text\">ArrayList</code>. So, it allocates at least 2 times more memory than needed.</li>\n<li><code class=\"language-text\">.map(_.toInt)</code> creates an Array of Int, parses all the split parts (meaning, iterates over each String again). <code class=\"language-text\">toInt</code> (which is just <code class=\"language-text\">Integer.parseInt</code>) may throw an exception.</li>\n<li><code class=\"language-text\">numbers@Array(major, minor, fix)</code> extracts 3 elements from an array, if array length is not 3 — throws an exception.</li>\n<li>Also, there is <code class=\"language-text\">Try(...).toOption</code>…</li>\n</ol>\n<h3 id=\"step-3-remove-scalautiltry\" style=\"position:relative;\"><a href=\"#step-3-remove-scalautiltry\" aria-label=\"step 3 remove scalautiltry permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 3. Remove scala.util.Try</h3>\n<p>It’s a simple one, just replace <code class=\"language-text\">scala.util.Try</code> with a regular <code class=\"language-text\">try</code> and <code class=\"language-text\">catch</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">val</span> numbers<span class=\"token annotation punctuation\">@Array</span><span class=\"token punctuation\">(</span>major<span class=\"token punctuation\">,</span> minor<span class=\"token punctuation\">,</span> fix<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> v<span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token char\">'.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>map<span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">.</span>toInt<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>numbers<span class=\"token punctuation\">.</span>exists<span class=\"token punctuation\">(</span>num <span class=\"token keyword\">=></span> num <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> num <span class=\"token operator\">></span> MaxVersionSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    None\n  <span class=\"token keyword\">else</span>\n    Some<span class=\"token punctuation\">(</span>Version<span class=\"token punctuation\">(</span>major<span class=\"token punctuation\">,</span> minor<span class=\"token punctuation\">,</span> fix<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">case</span> _<span class=\"token operator\">:</span> Throwable <span class=\"token keyword\">=></span> None\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And a benchmark for it:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark       (encoded)  Mode  Cnt     Score     Error  Units\nyolo                1.0.0  avgt    5   163.856 ±  12.370  ns/op\nyoloNoTry           1.0.0  avgt    5   164.512 ±   5.407  ns/op\nyoloNoThrow         1.0.0  avgt    5   163.308 ±  10.761  ns/op\nyoloNoThrowNoTry    1.0.0  avgt    5   166.721 ±   1.802  ns/op</code></pre></div>\n<p>It’s slightly slower, but error is smaller (less deviations).</p>\n<h3 id=\"step-4-regex\" style=\"position:relative;\"><a href=\"#step-4-regex\" aria-label=\"step 4 regex permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 4. Regex</h3>\n<p>Any parsing problem (especially for <a href=\"https://stackoverflow.com/questions/590747/using-regular-expressions-to-parse-html-why-not\">HTML</a>) could be solved with regular expressions!</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> MyRegex <span class=\"token operator\">=</span> Pattern<span class=\"token punctuation\">.</span>compile<span class=\"token punctuation\">(</span><span class=\"token string\">\"(\\\\d{1,5})\\\\.(\\\\d{1,5})\\\\.(\\\\d{1,5})\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">val</span> m <span class=\"token operator\">=</span> MyRegex<span class=\"token punctuation\">.</span>matcher<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">.</span>matches<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">val</span> major <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>group<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>toInt\n  <span class=\"token keyword\">val</span> minor <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>group<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>toInt\n  <span class=\"token keyword\">val</span> fix <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>group<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>toInt\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>major <span class=\"token operator\">></span> MaxVersionSize <span class=\"token operator\">||</span> minor <span class=\"token operator\">></span> MaxVersionSize <span class=\"token operator\">||</span> fix <span class=\"token operator\">></span> MaxVersionSize<span class=\"token punctuation\">)</span>\n    None\n  <span class=\"token keyword\">else</span>\n    Some<span class=\"token punctuation\">(</span>Version<span class=\"token punctuation\">(</span>major<span class=\"token punctuation\">,</span> minor<span class=\"token punctuation\">,</span> fix<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  None\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This solution is also quite readable, it doesn’t throw exceptions as regular expression validates correct non-negative numbers, so <code class=\"language-text\">toInt</code> won’t fail.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark       (encoded)  Mode  Cnt     Score     Error  Units\nyoloNoThrow     200.200.a  avgt    5  3156.323 ± 219.461  ns/op\nregex           200.200.a  avgt    5   251.237 ±  13.064  ns/op\nyoloNoThrow         1.0.0  avgt    5   163.308 ±  10.761  ns/op\nregex               1.0.0  avgt    5   216.829 ±   0.991  ns/op</code></pre></div>\n<p>For errors this version does the trick — no exceptions, so errors aren’t as slow, but the happy flow is slower! Not good!</p>\n<h3 id=\"step-5-searching-for-dots-use-indexof\" style=\"position:relative;\"><a href=\"#step-5-searching-for-dots-use-indexof\" aria-label=\"step 5 searching for dots use indexof permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 5. Searching For Dots (use indexOf)</h3>\n<p>The code is straight-forward, but verbose a bit:</p>\n<ul>\n<li>indexOf 3 times to find <code class=\"language-text\">.</code> character (the 3rd one to verify there isn’t more).</li>\n<li>Check that 3 regions are numbers.</li>\n<li>parseInteger for 3 regions.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">def</span> parseOptimized1<span class=\"token punctuation\">(</span>v<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Option<span class=\"token punctuation\">[</span>Version<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">val</span> index1 <span class=\"token operator\">=</span> v<span class=\"token punctuation\">.</span>indexOf<span class=\"token punctuation\">(</span><span class=\"token char\">'.'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>index1 <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> None\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">val</span> index2 <span class=\"token operator\">=</span> v<span class=\"token punctuation\">.</span>indexOf<span class=\"token punctuation\">(</span><span class=\"token char\">'.'</span><span class=\"token punctuation\">,</span> index1 <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>index2 <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> None\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">.</span>indexOf<span class=\"token punctuation\">(</span><span class=\"token char\">'.'</span><span class=\"token punctuation\">,</span> index2 <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> None\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isNumber3<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> index1<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span>\n      <span class=\"token operator\">!</span>isNumber3<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> index1 <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> index2<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span>\n      <span class=\"token operator\">!</span>isNumber3<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> index2 <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> None\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">val</span> majorStr <span class=\"token operator\">=</span> v<span class=\"token punctuation\">.</span>substring<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> index1<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">val</span> minorStr <span class=\"token operator\">=</span> v<span class=\"token punctuation\">.</span>substring<span class=\"token punctuation\">(</span>index1 <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> index2<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">val</span> fixStr <span class=\"token operator\">=</span> v<span class=\"token punctuation\">.</span>substring<span class=\"token punctuation\">(</span>index2 <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">val</span> major <span class=\"token operator\">=</span> majorStr<span class=\"token punctuation\">.</span>toInt\n  <span class=\"token keyword\">val</span> minor <span class=\"token operator\">=</span> minorStr<span class=\"token punctuation\">.</span>toInt\n  <span class=\"token keyword\">val</span> fix <span class=\"token operator\">=</span> fixStr<span class=\"token punctuation\">.</span>toInt\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>major <span class=\"token operator\">></span> MaxVersionSize <span class=\"token operator\">||</span> minor <span class=\"token operator\">></span> MaxVersionSize <span class=\"token operator\">||</span> fix <span class=\"token operator\">></span> MaxVersionSize<span class=\"token punctuation\">)</span>\n    None\n  <span class=\"token keyword\">else</span>\n    Some<span class=\"token punctuation\">(</span>Version<span class=\"token punctuation\">(</span>major<span class=\"token punctuation\">,</span> minor<span class=\"token punctuation\">,</span> fix<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And benchmarks:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark       (encoded)  Mode  Cnt     Score     Error  Units\nyoloNoThrow     200.200.a  avgt    5  3156.323 ± 219.461  ns/op\nregex           200.200.a  avgt    5   251.237 ±  13.064  ns/op\noptimized1      200.200.a  avgt    5    34.619 ±   0.116  ns/op\nyoloNoThrow         1.0.0  avgt    5   163.308 ±  10.761  ns/op\nregex               1.0.0  avgt    5   216.829 ±   0.991  ns/op\noptimized1          1.0.0  avgt    5   100.512 ±   4.974  ns/op</code></pre></div>\n<p>Good! Finally, we improved both error flow and success flow. Can we improve it more, though?</p>\n<h3 id=\"step-6-replace-substring\" style=\"position:relative;\"><a href=\"#step-6-replace-substring\" aria-label=\"step 6 replace substring permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 6. Replace substring</h3>\n<p>The problematic part is this:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">val</span> majorStr <span class=\"token operator\">=</span> v<span class=\"token punctuation\">.</span>substring<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> index1<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> major <span class=\"token operator\">=</span> majorStr<span class=\"token punctuation\">.</span>toInt</code></pre></div>\n<p>Here we do <code class=\"language-text\">substring</code> and then calling <code class=\"language-text\">parseInteger</code>. If you use JDK 9 or higher, you may use a new overload that takes <code class=\"language-text\">beginIndex</code> and <code class=\"language-text\">endIndex</code> arguments, so you can bypass creating a redundant <code class=\"language-text\">String</code> instance. The fix looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">val</span> major <span class=\"token operator\">=</span> Integer<span class=\"token punctuation\">.</span>parseUnsignedInt<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> index1<span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> minor <span class=\"token operator\">=</span> Integer<span class=\"token punctuation\">.</span>parseUnsignedInt<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> index1 <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> index2<span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> fix <span class=\"token operator\">=</span> Integer<span class=\"token punctuation\">.</span>parseUnsignedInt<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> index2 <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> len<span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>And the benchmark (only for happy flows):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark           (encoded)  Mode  Cnt     Score     Error  Units\n\nyoloNoThrow             1.0.0  avgt    5   163.308 ±  10.761  ns/op\nregex                   1.0.0  avgt    5   216.829 ±   0.991  ns/op\noptimized1              1.0.0  avgt    5   100.512 ±   4.974  ns/op\noptimized2              1.0.0  avgt    5    63.764 ±   4.887  ns/op\n\nyoloNoThrow 10000.10000.10000  avgt    5   209.066 ±   1.968  ns/op\nregex       10000.10000.10000  avgt    5   384.005 ±   1.439  ns/op\noptimized1  10000.10000.10000  avgt    5   156.005 ±   5.058  ns/op\noptimized2  10000.10000.10000  avgt    5   115.824 ±   5.485  ns/op</code></pre></div>\n<p>It’s quite significant: 25%-35% faster.</p>\n<h3 id=\"step-7-almost-there\" style=\"position:relative;\"><a href=\"#step-7-almost-there\" aria-label=\"step 7 almost there permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 7. Almost There?</h3>\n<p>However, we still have a problem - we actually go over initial string 3 times:</p>\n<ol>\n<li>Find all dots.</li>\n<li>Check that there are only digits between dots.</li>\n<li>Parse numbers.</li>\n</ol>\n<p>My first approach to eliminate one of these redundant passes failed miserably: I tried to go over String using pattern matching for each character, and ended up with slightly less performant solution:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark           (encoded)  Mode  Cnt     Score     Error  Units\noptimized1  10000.10000.10000  avgt    5   156.005 ±   5.058  ns/op\noptimized2  10000.10000.10000  avgt    5   115.824 ±   5.485  ns/op\noptimized3  10000.10000.10000  avgt    5   120.257 ±   0.252  ns/op</code></pre></div>\n<p>As it goes, I rewrote it to Java and got expected performance boost:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark           (encoded)  Mode  Cnt     Score     Error  Units\noptimized1  10000.10000.10000  avgt    5   156.005 ±   5.058  ns/op\noptimized2  10000.10000.10000  avgt    5   115.824 ±   5.485  ns/op\noptimized3  10000.10000.10000  avgt    5   120.257 ±   0.252  ns/op\noptimd3Java 10000.10000.10000  avgt    5   107.327 ±   3.675  ns/op</code></pre></div>\n<p>Here is the loop (in Java):</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> len <span class=\"token operator\">=</span> v<span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> major <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> minor <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> lastDotIndex <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> len<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">char</span> ch <span class=\"token operator\">=</span> v<span class=\"token punctuation\">.</span><span class=\"token function\">charAt</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>ch<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> <span class=\"token char\">'0'</span><span class=\"token operator\">:</span> <span class=\"token keyword\">case</span> <span class=\"token char\">'1'</span><span class=\"token operator\">:</span> <span class=\"token keyword\">case</span> <span class=\"token char\">'2'</span><span class=\"token operator\">:</span> <span class=\"token keyword\">case</span> <span class=\"token char\">'3'</span><span class=\"token operator\">:</span> <span class=\"token keyword\">case</span> <span class=\"token char\">'4'</span><span class=\"token operator\">:</span>\n        <span class=\"token keyword\">case</span> <span class=\"token char\">'5'</span><span class=\"token operator\">:</span> <span class=\"token keyword\">case</span> <span class=\"token char\">'6'</span><span class=\"token operator\">:</span> <span class=\"token keyword\">case</span> <span class=\"token char\">'7'</span><span class=\"token operator\">:</span> <span class=\"token keyword\">case</span> <span class=\"token char\">'8'</span><span class=\"token operator\">:</span> <span class=\"token keyword\">case</span> <span class=\"token char\">'9'</span><span class=\"token operator\">:</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>lastDotIndex <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// longer than MaxVersionSize</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">case</span> <span class=\"token char\">'.'</span><span class=\"token operator\">:</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>major <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">int</span> parsed <span class=\"token operator\">=</span> <span class=\"token function\">parseIntSafeEmpty</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>parsed <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span> parsed <span class=\"token operator\">></span> <span class=\"token class-name\">MaxVersionSize</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                major <span class=\"token operator\">=</span> parsed<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>minor <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">int</span> parsed <span class=\"token operator\">=</span> <span class=\"token function\">parseIntSafeEmpty</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> lastDotIndex <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>parsed <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span> parsed <span class=\"token operator\">></span> <span class=\"token class-name\">MaxVersionSize</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                minor <span class=\"token operator\">=</span> parsed<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 3rd dot</span>\n            <span class=\"token punctuation\">}</span>\n            lastDotIndex <span class=\"token operator\">=</span> i<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">default</span><span class=\"token operator\">:</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// invalid character</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Here we validate digits and find dots in a single pass. Parsing is still requires the second pass over the same characters.</p>\n<h3 id=\"step-8-dont-use-switch\" style=\"position:relative;\"><a href=\"#step-8-dont-use-switch\" aria-label=\"step 8 dont use switch permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 8. Don’t use switch</h3>\n<p>Inside for loop we can try to use <code class=\"language-text\">if..else</code> instead of <code class=\"language-text\">switch</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">char</span> ch <span class=\"token operator\">=</span> v<span class=\"token punctuation\">.</span><span class=\"token function\">charAt</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ch <span class=\"token operator\">>=</span> <span class=\"token char\">'0'</span> <span class=\"token operator\">&amp;&amp;</span> ch <span class=\"token operator\">&lt;=</span> <span class=\"token char\">'9'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>lastDotIndex <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// longer than MaxVersionSize</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ch <span class=\"token operator\">==</span> <span class=\"token char\">'.'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>major <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">int</span> parsed <span class=\"token operator\">=</span> <span class=\"token function\">parseIntSafeEmpty</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>parsed <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span> parsed <span class=\"token operator\">></span> <span class=\"token class-name\">MaxVersionSize</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        major <span class=\"token operator\">=</span> parsed<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>minor <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">int</span> parsed <span class=\"token operator\">=</span> <span class=\"token function\">parseIntSafeEmpty</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> lastDotIndex <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>parsed <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span> parsed <span class=\"token operator\">></span> <span class=\"token class-name\">MaxVersionSize</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        minor <span class=\"token operator\">=</span> parsed<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 3rd dot</span>\n    <span class=\"token punctuation\">}</span>\n    lastDotIndex <span class=\"token operator\">=</span> i<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// invalid character</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And it actually gives another performance boost!</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark                       (encoded)  Mode  Cnt     Score     Error  Units\noptimized3Java          10000.10000.10000  avgt    5   107.327 ±   3.675  ns/op\noptimized3JavaNoSwitch  10000.10000.10000  avgt    5    97.115 ±   4.890  ns/op</code></pre></div>\n<h3 id=\"step-9-single-pass\" style=\"position:relative;\"><a href=\"#step-9-single-pass\" aria-label=\"step 9 single pass permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 9. Single pass!</h3>\n<p>Finally, instead of parsing integers from String we need to accumulate digits as we read them. It adds some complexity, but not really much. Here is the final code for parsing version:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> len <span class=\"token operator\">=</span> v<span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">int</span> major <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> minor <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">int</span> current <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> dots <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> lastDotIndex <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> len<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> <span class=\"token keyword\">char</span> ch <span class=\"token operator\">=</span> v<span class=\"token punctuation\">.</span><span class=\"token function\">charAt</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> digit <span class=\"token operator\">=</span> ch <span class=\"token operator\">-</span> <span class=\"token number\">48</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>digit <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lastDotIndex <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token operator\">==</span> i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> current <span class=\"token operator\">></span> <span class=\"token class-name\">MaxVersionSize</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>dots<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">case</span> <span class=\"token number\">0</span><span class=\"token operator\">:</span>\n                major <span class=\"token operator\">=</span> current<span class=\"token punctuation\">;</span>\n                dots <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">case</span> <span class=\"token number\">1</span><span class=\"token operator\">:</span>\n                minor <span class=\"token operator\">=</span> current<span class=\"token punctuation\">;</span>\n                dots <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">default</span><span class=\"token operator\">:</span>\n                <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        lastDotIndex <span class=\"token operator\">=</span> i<span class=\"token punctuation\">;</span>\n        current <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>digit <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> digit <span class=\"token operator\">></span> <span class=\"token number\">9</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// overflow is possible!</span>\n        current <span class=\"token operator\">=</span> current <span class=\"token operator\">*</span> <span class=\"token number\">10</span> <span class=\"token operator\">+</span> digit<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dots <span class=\"token operator\">!=</span> <span class=\"token number\">2</span> <span class=\"token operator\">||</span> lastDotIndex <span class=\"token operator\">==</span> len <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> current <span class=\"token operator\">></span> <span class=\"token class-name\">MaxVersionSize</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Version</span><span class=\"token punctuation\">(</span>major<span class=\"token punctuation\">,</span> minor<span class=\"token punctuation\">,</span> current<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>And the benchmark:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark                       (encoded)  Mode  Cnt     Score     Error  Units\nyoloNoThrow             10000.10000.10000  avgt    5   209.066 ±   1.968  ns/op\nregex                   10000.10000.10000  avgt    5   384.005 ±   1.439  ns/op\noptimized1              10000.10000.10000  avgt    5   156.005 ±   5.058  ns/op\noptimized2              10000.10000.10000  avgt    5   115.824 ±   5.485  ns/op\noptimized3Java          10000.10000.10000  avgt    5   107.327 ±   3.675  ns/op\noptimized3JavaNoSwitch  10000.10000.10000  avgt    5    97.115 ±   4.890  ns/op\noptimized6              10000.10000.10000  avgt    5    57.729 ±   1.709  ns/op</code></pre></div>\n<p>4 times faster from the initial implementation!</p>\n<h2 id=\"the-end-lets-talk-about-memory\" style=\"position:relative;\"><a href=\"#the-end-lets-talk-about-memory\" aria-label=\"the end lets talk about memory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The End? Let’s Talk About Memory</h2>\n<p>I mentioned at the beginning of this journey memory allocations that we have in <code class=\"language-text\">split</code> method — to for Array of strings and for the intermediate <code class=\"language-text\">ArrayList</code>. I ran JMH benchmark with profiler of GC (<code class=\"language-text\">-prof gc</code>) to see how much memory different implementations allocate.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cd7f186a65e395db94fe3bacc41fd00c/53f1b/memory.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.270270270270274%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABVklEQVQY04WQzSusUQDG361/RSndrY9ieWNlycIGKTao6x+wVIqELYrcvL6mWxaXoVmNj1GGBfIx75Axw505M+ecOeOcn16uFfLUs3p6fj09XvAgWdq5J18y5HZ3ePJ/I2IRTHoRa/I4B85ZnHOfOpRWBiUV1lq8rUSWmt44f0/L7Hf1cFb3g5v+RsSax7M4Jaw4+/wlMMwrZUGpJDDG4G0nMtQPJmifVvzpHCDV0kTq10+KkSqsvHotWFv5ALL/DQ6lyxQKBbTWeNEQOJSgfeod2ExquOUVqA474N8B30mbCkIIpJR40aMc1T1xWscUq23dXNfXct3XQGHZo7jukTmfJNAVMiJH8UGhs5psXnMjNffhb08ZXFm9LQ4/vLyTjPkpZmOGk3mfx5kJHtdmkMeDuPMRNpNzjCc38ZMxTlauCCJpNvYCRi/TLFwE6KgP2du3qc7xAqwbpdmzyKjUAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Normalized Memory Allocations Per Single Call, bytes\"\n        title=\"Normalized Memory Allocations Per Single Call, bytes\"\n        src=\"/static/cd7f186a65e395db94fe3bacc41fd00c/50383/memory.png\"\n        srcset=\"/static/cd7f186a65e395db94fe3bacc41fd00c/1d79a/memory.png 185w,\n/static/cd7f186a65e395db94fe3bacc41fd00c/1efb2/memory.png 370w,\n/static/cd7f186a65e395db94fe3bacc41fd00c/50383/memory.png 740w,\n/static/cd7f186a65e395db94fe3bacc41fd00c/73caa/memory.png 1110w,\n/static/cd7f186a65e395db94fe3bacc41fd00c/536c7/memory.png 1480w,\n/static/cd7f186a65e395db94fe3bacc41fd00c/53f1b/memory.png 2453w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Original and Regex versions allocate similar amount of memory — around 400 bytes per call (for a happy flow, obviously, for exceptions we need to allocate significantly more). First optimized version (Step 5) allocates 184 bytes and other optimized implementations allocate 40 bytes.</p>\n<p>40 bytes is what we need for <code class=\"language-text\">Option[Version]</code>. According to <a href=\"https://github.com/openjdk/jol\">JOL</a>:</p>\n<ul>\n<li><code class=\"language-text\">scala.Some</code> takes 16 bytes: 12 bytes for header + 4 bytes for a reference.</li>\n<li><code class=\"language-text\">Version</code> takes 24 bytes: 12 bytes for header + 12 bytes for 3 integers.</li>\n</ul>\n<h3 id=\"step-10-get-rid-of-optionversion\" style=\"position:relative;\"><a href=\"#step-10-get-rid-of-optionversion\" aria-label=\"step 10 get rid of optionversion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 10. Get Rid of Option[Version]</h3>\n<p>Because each version part is limited to 10000, each integer needs only 14 bits (2^14 = 16384 = 16K). One <code class=\"language-text\">long</code> can hold even 4 such integers! So, let’s try to pack everything into <code class=\"language-text\">long</code>! We can even put a bit for “invalid” (to simulate <code class=\"language-text\">None</code>).</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> BitsPerValue <span class=\"token operator\">=</span> MaxVersionSize<span class=\"token punctuation\">.</span>toBinaryString<span class=\"token punctuation\">.</span>length\nrequire<span class=\"token punctuation\">(</span>BitsPerValue <span class=\"token operator\">*</span> <span class=\"token number\">3</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token operator\">&lt;=</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"not enough bits\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> InvalidBit <span class=\"token operator\">=</span> <span class=\"token number\">1L</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token punctuation\">(</span><span class=\"token number\">3</span> <span class=\"token operator\">*</span> BitsPerValue <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">val</span> Invalid<span class=\"token operator\">:</span> <span class=\"token builtin\">Long</span> <span class=\"token operator\">=</span> InvalidBit\n\n<span class=\"token keyword\">def</span> version<span class=\"token punctuation\">(</span>major<span class=\"token operator\">:</span> <span class=\"token builtin\">Int</span><span class=\"token punctuation\">,</span> minor<span class=\"token operator\">:</span> <span class=\"token builtin\">Int</span><span class=\"token punctuation\">,</span> fix<span class=\"token operator\">:</span> <span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Long</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>major <span class=\"token operator\">&amp;</span> <span class=\"token number\">16383</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>toLong <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">28</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span>\n    <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>minor <span class=\"token operator\">&amp;</span> <span class=\"token number\">16383</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>toLong <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">14</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span>\n    <span class=\"token punctuation\">(</span>fix<span class=\"token punctuation\">.</span>toLong <span class=\"token operator\">&amp;</span> <span class=\"token number\">16383</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And now instead of returning <code class=\"language-text\">Option[Version]</code> we need to return <code class=\"language-text\">long</code> and just replace <code class=\"language-text\">None</code> or <code class=\"language-text\">null</code> with <code class=\"language-text\">Invalid</code> and <code class=\"language-text\">Some(Version(...))</code> with <code class=\"language-text\">version(...)</code>!</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6b4183a82cc444597a94b80a7912f881/53f1b/memory-no-alloc.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.270270270270274%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABLUlEQVQY042QvS9DUQDF3+xPMRlYmoqwqkjMSCTSQTSRIl1MYsFSYmosIlZVHzEYRMWEqI9KOvh4eREE1bzbvvvebe/7yaswCI2TnPH8cs4xTgol+mfzvAoPa26Gh6lJ7OwG6n4ZrUr4gO9rfN//1YFcqZCORGuNkb0s0ho7ZXHP43A4xm1HG+ZICJEx0CL/L2DVE1QqAqUUxv7ZM6F4jt4FyfbAGFakEyvRTXmnCe0+fQJ1tSFQuh62beO6Lkb2/IXweI7BlGR3KI4V6cJKROpA72YeXTEbtqxP9hRClHEcB+Pg4o3m6DE9SUmmL4oZbsEcbUesG4gtA2Wt1EO+Vn+2DBz8V//w7tEhmbZYPVJcr6UpppYobqaQVxO4hWnUe46aHwBr36Gf/moa6AM/16rXKL+SMAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Allocated Memory Per Single Call without Option[Version], bytes\"\n        title=\"Allocated Memory Per Single Call without Option[Version], bytes\"\n        src=\"/static/6b4183a82cc444597a94b80a7912f881/50383/memory-no-alloc.png\"\n        srcset=\"/static/6b4183a82cc444597a94b80a7912f881/1d79a/memory-no-alloc.png 185w,\n/static/6b4183a82cc444597a94b80a7912f881/1efb2/memory-no-alloc.png 370w,\n/static/6b4183a82cc444597a94b80a7912f881/50383/memory-no-alloc.png 740w,\n/static/6b4183a82cc444597a94b80a7912f881/73caa/memory-no-alloc.png 1110w,\n/static/6b4183a82cc444597a94b80a7912f881/536c7/memory-no-alloc.png 1480w,\n/static/6b4183a82cc444597a94b80a7912f881/53f1b/memory-no-alloc.png 2453w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Yes, now we see that after <a href=\"#step-5-searching-for-dots-use-indexof\">Step 5</a> we managed to remove allocations completely! And what’s about performance without any allocations?</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark                       (encoded)  Mode  Cnt     Score     Error  Units\n\nyolo                    10000.10000.10000  avgt    5   218.728 ±   2.026  ns/op\nyolo NO ALLOC           10000.10000.10000  avgt    5   211.766 ±  19.489  ns/op\n\noptimized1              10000.10000.10000  avgt    5   156.005 ±   5.058  ns/op\noptimized1 NO ALLOC     10000.10000.10000  avgt    5   146.182 ±   0.199  ns/op\n\noptimized6              10000.10000.10000  avgt    5    57.729 ±   1.709  ns/op\noptimized6 NO ALLOC     10000.10000.10000  avgt    5    46.327 ±   0.065  ns/op</code></pre></div>\n<p>As expected, it improved performance even more. By the way, it’s as significant for the short string:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark                       (encoded)  Mode  Cnt     Score     Error  Units\n\nyolo                                1.0.0  avgt    5   163.856 ±  12.370  ns/op\nyolo NO ALLOC                       1.0.0  avgt    5   164.106 ±  17.569  ns/op\n\noptimized1                          1.0.0  avgt    5   100.512 ±   4.974  ns/op\noptimized1 NO ALLOC                 1.0.0  avgt    5    91.981 ±   3.188  ns/op\n\noptimized6                          1.0.0  avgt    5    22.198 ±   0.051  ns/op\noptimized6 NO ALLOC                 1.0.0  avgt    5    20.232 ±   0.054  ns/op</code></pre></div>\n<h3 id=\"valhalla-ftw\" style=\"position:relative;\"><a href=\"#valhalla-ftw\" aria-label=\"valhalla ftw permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Valhalla FTW!</h3>\n<p>Project <a href=\"https://jdk.java.net/valhalla/\">Valhalla</a> is going to help us greatly with this zero-allocation solution as it will enable to not pay for allocations for such simple data structures, but also it will make it convenient to use. With the current approach we return <code class=\"language-text\">long</code>, and it’s not really clear for a code reader to understand what this long actually means.</p>\n<p>With value-classes it will be possible to define version like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">value <span class=\"token keyword\">class</span> <span class=\"token class-name\">Version</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">long</span> value<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Version</span> INVALID <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Version</span><span class=\"token punctuation\">(</span><span class=\"token number\">1L</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token punctuation\">(</span><span class=\"token number\">3</span> <span class=\"token operator\">*</span> <span class=\"token number\">14</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">private</span> <span class=\"token class-name\">Version</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">Version</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> major<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> minor<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> fix<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">(</span><span class=\"token function\">asValue</span><span class=\"token punctuation\">(</span>major<span class=\"token punctuation\">,</span> minor<span class=\"token punctuation\">,</span> fix<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Version</span> <span class=\"token function\">fromString</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> v<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// our implementation</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isInvalid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> value <span class=\"token operator\">==</span> INVALID<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">major</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">>></span> <span class=\"token number\">28</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">16383</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">minor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">>></span> <span class=\"token number\">14</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">16383</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">fix</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>value <span class=\"token operator\">&amp;</span> <span class=\"token number\">16383</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">long</span> <span class=\"token function\">asValue</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> major<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> minor<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> fix<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>major <span class=\"token operator\">&amp;</span> <span class=\"token number\">16383</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">28</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span>\n      <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>minor <span class=\"token operator\">&amp;</span> <span class=\"token number\">16383</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">14</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span>\n      <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>fix <span class=\"token operator\">&amp;</span> <span class=\"token number\">16383</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Effectively it will be 8 bytes in memory, not in heap, passing by value, as effective as <code class=\"language-text\">long</code>, but with the convenience of the normal class. We just need to patiently wait for Valhalla :)</p>\n<h3 id=\"back-to-scala\" style=\"position:relative;\"><a href=\"#back-to-scala\" aria-label=\"back to scala permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Back to Scala</h3>\n<p>I was carried away by worse performance of pattern matching in Scala comparing to basic <code class=\"language-text\">switch</code> in Java. But to be fair, the final solution doesn’t require pattern matching. I <a href=\"https://github.com/dkomanov/stuff/commit/e8602ee396d2a930f22bb3e976de4f603ab36154\">ported</a> the final version back to Scala. Unsurprisingly, the performance is more or less the same.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark                         (encoded)  Mode  Cnt   Score    Error Units\n\noptimized6                            1.0.0  avgt    5  22.995 ±  1.303 ns/op\noptimized6Scala                       1.0.0  avgt    5  24.780 ±  3.820 ns/op\n\noptimized6                10000.10000.10000  avgt    5  60.070 ±  3.753 ns/op\noptimized6Scala           10000.10000.10000  avgt    5  60.828 ± 27.522 ns/op\n\noptimized6      NO ALLOC              1.0.0  avgt    5  21.713 ±  2.534 ns/op\noptimized6Scala NO ALLOC              1.0.0  avgt    5  20.101 ±  1.469 ns/op\n\noptimized6      NO ALLOC  10000.10000.10000  avgt    5  48.535 ±  1.351 ns/op\noptimized6Scala NO ALLOC  10000.10000.10000  avgt    5  48.259 ±  1.484 ns/op</code></pre></div>\n<h2 id=\"final-thoughts\" style=\"position:relative;\"><a href=\"#final-thoughts\" aria-label=\"final thoughts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Final Thoughts</h2>\n<p>Clearly, the initial code is concise and simple. And sometimes we pay for the simplicity and the ease of maintenance. Do we even need to optimize it? If it works — no need to touch it. In my case, my attention was brought to this code because of the exceptions. By chance I profiled service with <a href=\"https://github.com/async-profiler/async-profiler\">async-profiler</a> and at that point of time we received significant amount of requests with invalid versions, so exceptions thrown by this validation were visible in hot spots.</p>\n<p>It’s still may not be a reason for optimizations. If we are just concerned with exceptions, we may as well use <a href=\"#step-4-regex\">Regex</a> implementation. It’s not as robust on happy flow, but still good enough. And it has more or less the same readability.</p>\n<p>My internal perfectionist screams: “What’s about efficiency?!” But it’s always a trade off between maintenance cost and actual production impact of code changes. <a href=\"#step-6-replace-substring\">Step 6</a> actually may be a good compromise between readability and performance, as <code class=\"language-text\">indexOf</code> solution is not that complicated and still provides visible performance benefit (no garbage also!)</p>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>I had a lot of fun conducting this benchmark and doing all these optimizations step by step. I hope you enjoyed it as well. To sum up optimization efforts:</p>\n<ul>\n<li>As always, <a href=\"http://wiki.jvmlangsummit.com/images/1/1d/PerformanceAnxiety2010.pdf\">beware</a> of premature optimizations!</li>\n<li>Use as less exceptions as possible. If you need to use exceptions, consider using <a href=\"https://stackoverflow.com/questions/11434431/exception-without-stack-trace-in-java\">stack-traceless</a> ones.</li>\n<li>Reduce number of intermediate allocations to minimum. It will not only improve performance of the task, but will reduce pressure on Garbage Collector, which is a good thing for the application in general.</li>\n<li>CPU cycles do matter. Iterating over a string has its price. More iterations you do, more you pay.</li>\n<li>Consider maintenance cost of the optimization. It could be detrimental in a long run.</li>\n</ul>\n<p>But more than anything, optimization and benchmarking are always a fun exercise — have fun! ;-)</p>\n<p>Play with charts <a href=\"/charts/version-parsing\">here</a>. Source code is on <a href=\"https://github.com/dkomanov/stuff/commit/85e5845688922ecce4ccc88818c9e283174f8705\">GitHub</a>. Originally posted on <a href=\"https://dkomanov.medium.com/optimizing-performance-of-simple-version-parsing-in-scala-aeff8bc133a5\">Medium</a>. <a href=\"https://pixabay.com/illustrations/matrix-code-computer-pc-data-356024/\">Cover image</a> by <a href=\"https://pixabay.com/users/51581-51581/\">51581</a> from <a href=\"https://pixabay.com/\">Pixabay</a> + <a href=\"https://excalidraw.com/\">Excalidraw</a>.</p>","fields":{"slug":"/p/optimizing-performance-of-simple-version-parsing-in-scala/"},"frontmatter":{"rawDate":"2023-09-12T00:00:00.000Z","date":"September 12, 2023","title":"Optimizing Performance of Simple Version Parsing in Scala","description":"A step by step guide how code optimization is done: what to look for during optimization process, how to win nanoseconds and have fun!","tags":["scala","java","string","benchmark","performance","optimization"],"canonicalUrl":"https://dkomanov.medium.com/optimizing-performance-of-simple-version-parsing-in-scala-aeff8bc133a5","cover":{"publicURL":"/static/ac7cbf764cf6c6ea8c34a821239aaffc/cover.jpg"}}}},"pageContext":{"slug":"/p/optimizing-performance-of-simple-version-parsing-in-scala/","previous":{"fields":{"slug":"/p/mysql-blob-fetch-performance-in-java/"}},"next":null}},"staticQueryHashes":["3675711862"]}