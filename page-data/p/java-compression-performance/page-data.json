{"componentChunkName":"component---src-templates-blog-post-js","path":"/p/java-compression-performance/","result":{"data":{"markdownRemark":{"id":"164c6420-9ca7-5941-9da2-cd4f0ff7afa1","excerpt":"Data compression is a very broad topic, we may find lots of materials on this topic on Internet. There are amazing benchmarks for all kinds of compression…","html":"<p><a href=\"https://en.wikipedia.org/wiki/Data_compression\">Data compression</a> is a very broad topic, we may find lots of materials on this topic on Internet. There are <a href=\"https://quixdb.github.io/squash-benchmark/\">amazing</a> <a href=\"http://mattmahoney.net/dc/text.html\">benchmarks</a> for all kinds of compression algorithms. Benchmarks <sup><a href=\"https://github.com/ning/jvm-compressor-benchmark\">1</a> <a href=\"https://github.com/torao/benchmark.compression\">2</a> <a href=\"http://web.archive.org/web/20180715083420/http://java-performance.info/performance-general-compression/\">3</a></sup> for Java exist, but it seems to be a little bit outdated (not using JMH, for example) as it was written a long time ago.</p>\n<p>Compression effectiveness (both performance and size) is dependent on the actual data. Therefore, it made sense to me to redo benchmarks to determine which algorithm (if any) will fit the most, and just learn a bit more about data compression in Java.</p>\n<h2 id=\"what-data-do-we-benchmark\" style=\"position:relative;\"><a href=\"#what-data-do-we-benchmark\" aria-label=\"what data do we benchmark permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What data do we benchmark</h2>\n<p>We are going to benchmark on two sets of data: our internal data structure of different sizes and a set of artificial randomly generated data with different compression ratios and sizes.</p>\n<p>An internal data structure is a kind of <a href=\"https://en.wikipedia.org/wiki/Trie\">trie</a> with URLs, UUIDs and some other binary information (encoded as <a href=\"https://developers.google.com/protocol-buffers/\">protobuf</a> messages). We can’t share the data itself as may contain some user data.</p>\n<p>Random dataset is just random characters of different character sets. Here is the function to <a href=\"https://github.com/dkomanov/stuff/blob/4e7dd1ff5ffc3354115b90f29ef3c14ec2ebd96b/src/com/komanov/compression/BlobCompressionRatio.java\">generate data</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span>Random</span> rnd <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token function\">generateImpl</span><span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> alphabet<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">int</span> length<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span>length<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> result<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      result<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> alphabet<span class=\"token punctuation\">[</span>rnd<span class=\"token punctuation\">.</span><span class=\"token function\">nextInt</span><span class=\"token punctuation\">(</span>alphabet<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>For different alphabets I calculated compression ratios for <a href=\"https://en.wikipedia.org/wiki/Deflate\">deflate</a> compression algorithm and called different sets according to its compression ratio:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">low (1.3) -> \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789\"\nmedium (2.1) -> \"0123456789\"\nhigh (3.4) -> \"0123\"\nextra high (6.2) -> \"01\"</code></pre></div>\n<h2 id=\"compression-algorithms\" style=\"position:relative;\"><a href=\"#compression-algorithms\" aria-label=\"compression algorithms permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Compression Algorithms</h2>\n<p>I picked a few popular compression algorithms:</p>\n<ul>\n<li><a href=\"https://en.wikipedia.org/wiki/Gzip\">gzip</a> via <a href=\"https://commons.apache.org/proper/commons-compress/\">Apache Commons Compress</a></li>\n<li><a href=\"https://en.wikipedia.org/wiki/Deflate\">deflate</a> also via commons-compress.</li>\n<li><a href=\"https://dev.mysql.com/doc/refman/8.0/en/encryption-functions.html#function_compress\">MySQL compression</a>: basically, it’s uses deflate algorithm, but also prefixes with 4 bytes of the original data length (which helps allocating buffer for decompression). Via <a href=\"https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/zip/Deflater.html\">java.util.zip.Deflater</a>.</li>\n<li><a href=\"https://github.com/facebook/zstd\">zstd</a>: Facebook’s compression algorithm that’s supposedly faster and has better compression ratio than deflate.</li>\n<li><a href=\"https://github.com/google/snappy\">snappy</a>: Google’s compression algorithm that was designed to be very fast with reasonable compression ratios. Via <a href=\"https://github.com/xerial/snappy-java\">snappy-java</a>.</li>\n<li><a href=\"https://github.com/google/brotli\">brotli</a>: Another Google’s compression algorithm that aims for the better compression ratio and comparable performance with deflate. For brotli we will use 3 compression levels: 0, 6 and 11 (default, maximum). Via <a href=\"https://github.com/hyperxpro/Brotli4j\">Brotli4j</a>.</li>\n<li><a href=\"https://lz4.github.io/lz4/\">lz4</a>: a compression algorithm that aims for the best decoding performance. For lz4 we will use 3 compression levels: fast, 9 (default), 17 (maximum). Via <a href=\"https://github.com/lz4/lz4-java\">lz4-java</a>.</li>\n</ul>\n<h2 id=\"compression-ratios\" style=\"position:relative;\"><a href=\"#compression-ratios\" aria-label=\"compression ratios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Compression Ratios</h2>\n<p>For the Real dataset the best compression ratio had brotli, the worst snappy and lz4 fast:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d944ac225e6a3d5cba450d98bd9d4dee/82f58/real-compression-ratios.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.810810810810814%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACTElEQVQozx2RS47jVAAAfVCOgLgBOw4AS9ggjcQGDYhk+kfTnWQcO45/z59nv4+f7diZnmHJaLpRdxikQuQAJVWpvI9/feThzw+oqcfMI7Uz2ONIOzqc1XSqpR977OgQtqHsNXtdop3GNpJudMj/mWmkthrv38+fmR6ObOuYXZuxFiGRzrnLA2QjyNMdVSOIypj7OuJORiyLt0TVnjIOETJjmwVkSrBJfLx/Tiemh5mg2rNvc96KHYkWbPIdMvIpVrdURUxcxGxkzKZJuKl2xOkW8ccVRRkTZCFCCfwkwDudTrz/8B7VG/TYUesGPVhEW+G2a5qrJToOkSKmOCcrYitpkgC5+BVXZhQiwZkGkcd4z8/PTMeZttN000BjFfrgSFXFWBeYaMdoDdoqMluTmIpQCdoyQ6/u6U1L1VT0o6OSFd7p5YXp3Ywwkma0CF2T9JJrsaVLI4y/oRs6Cqe4rUJ+r0KWhU+2W2He/IZuS1It0XNP0hR4zy8vHKcDnSwZVIMuctSgzxZ96GNuLunz5Gy0VwV7U+JrQb3fot8sOIgUlSXMStLEEd7fT09M84weunOy6gzZ0HIpfEwaYQOffnCUneKmDrkofX4R6/MUfXfL0GlaZxmPE7Vu8Z4eHxnnCTkY2oOjMA1533JfRThVY0XONPbUtuW6DListrzO70llissz3NBRmhb37kDe1niPnz7ROMMiW3NZblkma77fLfj66gfirqY2ilUT89P+mq8W3/Hl8lu++PkbfowuUM5yVQe8Ci94Xax4FVzwH9Xxr3EiFp0+AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Compression Ratios for Real Data\"\n        title=\"Compression Ratios for Real Data\"\n        src=\"/static/d944ac225e6a3d5cba450d98bd9d4dee/50383/real-compression-ratios.png\"\n        srcset=\"/static/d944ac225e6a3d5cba450d98bd9d4dee/1d79a/real-compression-ratios.png 185w,\n/static/d944ac225e6a3d5cba450d98bd9d4dee/1efb2/real-compression-ratios.png 370w,\n/static/d944ac225e6a3d5cba450d98bd9d4dee/50383/real-compression-ratios.png 740w,\n/static/d944ac225e6a3d5cba450d98bd9d4dee/73caa/real-compression-ratios.png 1110w,\n/static/d944ac225e6a3d5cba450d98bd9d4dee/82f58/real-compression-ratios.png 1387w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>For the Stub dataset (random) the best is brotli and the worst consistently lz4 fast.</p>\n<p>A spreadsheet with all compression ratios is available <a href=\"https://docs.google.com/spreadsheets/d/1pFOAgxVYsos38oraeva1_RHC9P4J3oN2Oj2fQ65L8OI\">here</a>.</p>\n<h2 id=\"benchmarks\" style=\"position:relative;\"><a href=\"#benchmarks\" aria-label=\"benchmarks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Benchmarks</h2>\n<p><a href=\"https://github.com/dkomanov/stuff/blob/4e7dd1ff5ffc3354115b90f29ef3c14ec2ebd96b/src/com/komanov/compression/jmh/CompressionBenchmark.scala\">Benchmarks</a> were performed using <a href=\"https://github.com/openjdk/jmh\">JMH</a> for 3 JDKs: openjdk-8, openjdk-11 and openjdk-17. If not mentioned separately, the charts are for openjdk-17.</p>\n<h3 id=\"decoding-on-real-data\" style=\"position:relative;\"><a href=\"#decoding-on-real-data\" aria-label=\"decoding on real data permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Decoding on Real Data</h3>\n<p>First, let’s see the performance of decoding for the Real Data (data length is between 600KB and 4MB):</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f60c34c5b5f85e663a344fbf4b778b4b/5eb90/real-decode-performance.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.94594594594595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABJUlEQVQoz52R224jMQxD8/+fWaBB03TGV0m+jU/hyW66wL60FcAH2yJF0ZfjOFiYc/4MwOydkpU+JiUFTJXLr8TmZCl2FYplYBBzQFV+KfjHnWaPjMEBxJiotXIxM1Z9S+R0Ns/+Jolo8vdI9u6x8hJ8kL6c/lfraozzrR2TVisheuqojL4MHcQsqNpj5X95C6UW1ITSGpodyd8IwbG7Defu7O6OiGd2oxVltPbUuJxTa8Y0oBaR/IH6KyXesPhGlY1WMsUio0SoGUahVz1zi0FobTxjOx2+367cXl+4X1/Y3l4JPp6NwQW8S+xB2H1kW3CR+xZ43wLOZ2LI1NK+BMdYX26EZLiFqPg1WTIhCXtKbN6jZqgVRJQsdua1uGN0eu/P7D8BS13A7/aO+eAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Decoding Performance in microseconds for Real Data (600KB-4MB)\"\n        title=\"Decoding Performance in microseconds for Real Data (600KB-4MB)\"\n        src=\"/static/f60c34c5b5f85e663a344fbf4b778b4b/50383/real-decode-performance.png\"\n        srcset=\"/static/f60c34c5b5f85e663a344fbf4b778b4b/1d79a/real-decode-performance.png 185w,\n/static/f60c34c5b5f85e663a344fbf4b778b4b/1efb2/real-decode-performance.png 370w,\n/static/f60c34c5b5f85e663a344fbf4b778b4b/50383/real-decode-performance.png 740w,\n/static/f60c34c5b5f85e663a344fbf4b778b4b/73caa/real-decode-performance.png 1110w,\n/static/f60c34c5b5f85e663a344fbf4b778b4b/536c7/real-decode-performance.png 1480w,\n/static/f60c34c5b5f85e663a344fbf4b778b4b/5eb90/real-decode-performance.png 1612w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Another view for this chart would be throughput in bytes per second:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/29366b2c9a2e8da0cfba340fb806f986/d004c/real-decode-throughput.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.94594594594595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABTElEQVQoz4WS244cIQxE+/9/M9JosplRN41tMOA+CczenrIllQSoKJcN2xgDLxW3QrVK1MYVQVwX1w+MqYtgopwHxYxtHnjvL46OlsLwxgU/Gn5w4swHZsrWe/88nOgxMDUYsUwj/p9wtL7upTPj7mwiwpiXv1ezyrEL8S7+juhj6UYEIoqYvdbpPaFIpvfAfdBH4G2sfW2dIymSbVUuVsnZOA4hJeVMQozBmEmviyyKWWFrrdFGx1vHS8e9U4cv9gisOlkM0UKd2qsvfWuDWl+cY/nAFlfgtVNqo7RGqf5K2y+s+EpaI6i9U5qvwtN4FpotqwjN2zKbo1iPUmRH9tsnLT2wtKPpgTzf0Ocb6XHn+HMnP39zPu+Lab/xfPxCNX0ZzpeyMlsSVDOiGdU54ITYicjO8bghklBTRE+sCKaZVpRqhea+fgT/DP8CsyHAcdE/UEIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Decoding Throughput in bytes for Real Data (600KB-4MB)\"\n        title=\"Decoding Throughput in bytes for Real Data (600KB-4MB)\"\n        src=\"/static/29366b2c9a2e8da0cfba340fb806f986/50383/real-decode-throughput.png\"\n        srcset=\"/static/29366b2c9a2e8da0cfba340fb806f986/1d79a/real-decode-throughput.png 185w,\n/static/29366b2c9a2e8da0cfba340fb806f986/1efb2/real-decode-throughput.png 370w,\n/static/29366b2c9a2e8da0cfba340fb806f986/50383/real-decode-throughput.png 740w,\n/static/29366b2c9a2e8da0cfba340fb806f986/73caa/real-decode-throughput.png 1110w,\n/static/29366b2c9a2e8da0cfba340fb806f986/536c7/real-decode-throughput.png 1480w,\n/static/29366b2c9a2e8da0cfba340fb806f986/d004c/real-decode-throughput.png 1611w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>From these charts it’s clear that lz4 (all 3 levels) outperforms significantly all other algorithms. The next after lz4 fast are zstd and snappy.</p>\n<h3 id=\"encoding-of-real-data\" style=\"position:relative;\"><a href=\"#encoding-of-real-data\" aria-label=\"encoding of real data permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Encoding of Real Data</h3>\n<p>Next, let’s check encoding performance for the Real Data (data length is between 600KB and 4MB):</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9935e60c4ed386da6885ec58d82575bd/d004c/real-encode-performance-brotli11.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.94594594594595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAz0lEQVQoz52R227EIAxE+f+P3TTgGxgyK4eElVq11a6lIx7QHHkgjTEQHMfxFjGtKXLe0LzByg4VQfpUGBl3A/M+xbSDhZHeFU2AMRy9V1zLYs8FtVYkEfmorruuZjH0tUFiw/+F+FbVz6rBfReTiSGif1eODaLWFCjcBd0rem8/3v2eNEMNvdtijAjUk+NwAK/Ab3OLT6FVg9W2iO8XZqgoVOxEiMELuU4ClfkZt/QSVqgZ1CpUDcJTGFAhPB7bGZwQiBglE0ouKDlDVZfwCfGBxW4Ij8+IAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Encoding Performance in microseconds for Real Data (600KB-4MB)\"\n        title=\"Encoding Performance in microseconds for Real Data (600KB-4MB)\"\n        src=\"/static/9935e60c4ed386da6885ec58d82575bd/50383/real-encode-performance-brotli11.png\"\n        srcset=\"/static/9935e60c4ed386da6885ec58d82575bd/1d79a/real-encode-performance-brotli11.png 185w,\n/static/9935e60c4ed386da6885ec58d82575bd/1efb2/real-encode-performance-brotli11.png 370w,\n/static/9935e60c4ed386da6885ec58d82575bd/50383/real-encode-performance-brotli11.png 740w,\n/static/9935e60c4ed386da6885ec58d82575bd/73caa/real-encode-performance-brotli11.png 1110w,\n/static/9935e60c4ed386da6885ec58d82575bd/536c7/real-encode-performance-brotli11.png 1480w,\n/static/9935e60c4ed386da6885ec58d82575bd/d004c/real-encode-performance-brotli11.png 1611w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Wow! Brotli with level 11 took 13 seconds to encode 4MB of data… At first I didn’t believe it, thought that I must be use the library incorrectly. But then I ran original native binary:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">time</span> brotli ~/1/bins/total_4072805_with_34010_items.bin\n\nreal\t0m12.945s\nuser\t0m12.878s\nsys\t0m0.064s</code></pre></div>\n<p>Indeed, compression level 11 is extremely slow. Let’s exclude it to see normally performance of other algorithms:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c5ea49f6ee620b7690b314eade684511/5eb90/real-encode-performance.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.94594594594595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABFElEQVQoz5WS227DIAyG8/7vOalrmiaADeH4TabrtotpWo1+zAV8PrHUWum9M8Z4TUA/C+FwlFI4gyPFyNJaew3Ip++dngvJCy0XvDhiVBaDvQSs7dvXRh+WKzgfyDmzxBj/DyuVkcuUlWs2RrcdOXZUhUVV/4ZYSwxgIAPa89aNQZYDuV2ppdBLo5b6Sw9t9UGv1qPKKO2RiQ1hMEu0c06K3leqBWuPO2YTOCM+bj90npAVRmHUk5qELG5OsqiniCO7Oz/tmdAcimwr/vJGWN/x7xfu1wvbdmNfrxzbyr5vHMeB8w4/dRBUsP6nqPPbPKETGGNCRAmi00uMeI1ITARVbgaTgBOZ8qq4EBARoirpTF/ADxFlwunpaRqgAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Encoding Performance without brotli_11 for Real Data (600KB-4MB)\"\n        title=\"Encoding Performance without brotli_11 for Real Data (600KB-4MB)\"\n        src=\"/static/c5ea49f6ee620b7690b314eade684511/50383/real-encode-performance.png\"\n        srcset=\"/static/c5ea49f6ee620b7690b314eade684511/1d79a/real-encode-performance.png 185w,\n/static/c5ea49f6ee620b7690b314eade684511/1efb2/real-encode-performance.png 370w,\n/static/c5ea49f6ee620b7690b314eade684511/50383/real-encode-performance.png 740w,\n/static/c5ea49f6ee620b7690b314eade684511/73caa/real-encode-performance.png 1110w,\n/static/c5ea49f6ee620b7690b314eade684511/536c7/real-encode-performance.png 1480w,\n/static/c5ea49f6ee620b7690b314eade684511/5eb90/real-encode-performance.png 1612w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>And the corresponding chart for the throughput (bytes per second):</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4a1cb772d0e1e7a613df36b38ec36354/d004c/real-encode-throughput.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.94594594594595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABQ0lEQVQoz12Si27sIAxE8/+futXebIAAfnGuAmladaKRgYwHsNncjYsTYzAm+RV55u6K6Um4MaZ+5Vxo6UOrlc3dUa2YKxrjTuyYVdxlmbhg1uZcw+c4XBFTqnUGQSoHZz2XYVZhb5mmldRPmnU8nAidiSN8nqS70kwWtXH0k1JP1J2UMyLCVkrBb3F3oZrwEaGokLST7pi1U0xpHhQz9t5pVZGuxBiUY+cshS3nvMrnA9dgeEyBRCB+M4KujoozYhAWWHOIVb8LLoapsZkZLj55CZ+xOt6dkJ/4/NdlPL+7kd+YNYwInqaxNr6XnvW/WA2+TX8Zb9f1+tXy9xd1/1D3RDsyLSX6saP5QEtCjn0x5cm+v2n/XtT3C2v1fnWXYQQmHRfFLnZBz7JMzkxNB+nrRUsHvRR6qfTa0FandlL0ufZ/8dLC0lsUoSoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Encoding Throughput without brotli_11 for Real Data (600KB-4MB)\"\n        title=\"Encoding Throughput without brotli_11 for Real Data (600KB-4MB)\"\n        src=\"/static/4a1cb772d0e1e7a613df36b38ec36354/50383/real-encode-throughput.png\"\n        srcset=\"/static/4a1cb772d0e1e7a613df36b38ec36354/1d79a/real-encode-throughput.png 185w,\n/static/4a1cb772d0e1e7a613df36b38ec36354/1efb2/real-encode-throughput.png 370w,\n/static/4a1cb772d0e1e7a613df36b38ec36354/50383/real-encode-throughput.png 740w,\n/static/4a1cb772d0e1e7a613df36b38ec36354/73caa/real-encode-throughput.png 1110w,\n/static/4a1cb772d0e1e7a613df36b38ec36354/536c7/real-encode-throughput.png 1480w,\n/static/4a1cb772d0e1e7a613df36b38ec36354/d004c/real-encode-throughput.png 1611w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>4 leaders here are: lz4 fast (500+MBps), brotli_0 (450+MBps), snappy (400+MBps) and zstd (250+MBps). The worst is lz4_high17 with 13-30MBps.</p>\n<h3 id=\"comparing-performance-for-different-jdks\" style=\"position:relative;\"><a href=\"#comparing-performance-for-different-jdks\" aria-label=\"comparing performance for different jdks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Comparing Performance for different JDKs</h3>\n<p>And comparing performance in different JDKs we may see that performance is more or less the same as most libraries use JNI under the hood:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/780a9d2a5ce5a7bf58960cd31b8549b7/5eb90/real-decode-jdks.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.94594594594595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB8ElEQVQoz0WRW08TURDH95v5BfwGvvjomw9GwWtipDExBuUixAcSRC2VAtr0Eq0NCVZa5YkHQZNuS9tdettCt7ftZffsT3dPqZNM5pz/zPznpriAU6vgWEO8t+u6UgExGiLsMeISu1ThIMYeDkIIPBl0TAaWheIA5UQMUVV9hyuEr37QryPGWuk/7roSbxh0DzMSdxzfdromltVH6bjw6cVLbDVMy/MIZxqU3U7Q/LFGz08c4ziyUCaro4ce0MZmOJax7U6X0WiEYgwhubyMfrxJ7FwmOI7t2+RGBDUVIG76X+wJYXJfp/H+Jh+NOsZAYl2zJUf2CL8sLaEfb/FBr4LdRQg52t67KOreM3aaFqN+nckmSH3TaQRvsds4o2CUJiP3sawBStuFzwsLXBQSrB5GGJsqkg5SGxH0g2VCRZVSLsalfN0vY4bvsqOf8PMoLHc5yVK8/UQW59mOBlhdD2C3877Da+b7ZoKd7du82lrnohCdEqYPqqRfX+d5/C0n6ZXpcbyjKT0XwotPmZ29RuDJDLtvgtTNjl8vE4pz79FVZh7OsRecp9joS8JsjbU7V7jxeI7wyn3yp4bs0CN0XDivVSiXVTStSClXpN2TiZ1mC037Q65wyllOpdJsTS46wij/Jq9p6HkVXa/Lgf8R/gWPt42WCp98RAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Decoding Performance in different JDKs for 4MB input\"\n        title=\"Decoding Performance in different JDKs for 4MB input\"\n        src=\"/static/780a9d2a5ce5a7bf58960cd31b8549b7/50383/real-decode-jdks.png\"\n        srcset=\"/static/780a9d2a5ce5a7bf58960cd31b8549b7/1d79a/real-decode-jdks.png 185w,\n/static/780a9d2a5ce5a7bf58960cd31b8549b7/1efb2/real-decode-jdks.png 370w,\n/static/780a9d2a5ce5a7bf58960cd31b8549b7/50383/real-decode-jdks.png 740w,\n/static/780a9d2a5ce5a7bf58960cd31b8549b7/73caa/real-decode-jdks.png 1110w,\n/static/780a9d2a5ce5a7bf58960cd31b8549b7/536c7/real-decode-jdks.png 1480w,\n/static/780a9d2a5ce5a7bf58960cd31b8549b7/5eb90/real-decode-jdks.png 1612w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>And the same for encoding:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/75e496ac432f6d75369d3beece29716b/5eb90/real-encode-jdks.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.94594594594595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB20lEQVQoz12RbW/SUBiG+Zcm/gETP/gLjF+NiTHTDyZGnYubCVHnu5LFTVxAlMEmooCIvBcESmGllK6np720pywsnuSc3Llynus87RPzPA/f9wmCgACQuonX1VUOznB/7uA1Bv/xAF94yOYQx5ziOAtiUspIGG7Aaw0RxWZUKFdcjk3cT2VQXK4eOhGIzE/M4wmLUBjKQmngS3XZa48QpbbK/hkujRlutrrkfiRdCr2DGubUxBWC2MK2o1dPt6bjlToqny7FpxYiW13y1Rm4ApmrYRkGtm0Tmwko7H3B/f1CXTquaCwKTZXLR3WM/FOV7f4UO11R+VfNop9cB1xc22OeKuM7gnAesQXw+NoDrNxVmAxIr+8y/NxQhS8fpajHL4E/4XAzQStRUvx9Uqd48zzIDu2dfb7GC6rfsGMlfL62hSjdhj81Mnd3GGZbqvDdkwzaqysgR+TvbNNMRB0mU2Mq9y5C0KHz7C35eDH8m/hBEAm3r29Q/3AZ/VuOvVtxBpnok9/E0xxtXOC4W2V/7T71198V3/2oc3DjHKP2IT82t8g+zKsOlTCc4XQwpq9V0LQ+k56GsE5UoTmZM+iWabS6jLUOziQaoDnzMLoVWloPo9fG0mfRkP4J/wLchp0+3DnGoAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Decoding Performance in different JDKs for 4MB input\"\n        title=\"Decoding Performance in different JDKs for 4MB input\"\n        src=\"/static/75e496ac432f6d75369d3beece29716b/50383/real-encode-jdks.png\"\n        srcset=\"/static/75e496ac432f6d75369d3beece29716b/1d79a/real-encode-jdks.png 185w,\n/static/75e496ac432f6d75369d3beece29716b/1efb2/real-encode-jdks.png 370w,\n/static/75e496ac432f6d75369d3beece29716b/50383/real-encode-jdks.png 740w,\n/static/75e496ac432f6d75369d3beece29716b/73caa/real-encode-jdks.png 1110w,\n/static/75e496ac432f6d75369d3beece29716b/536c7/real-encode-jdks.png 1480w,\n/static/75e496ac432f6d75369d3beece29716b/5eb90/real-encode-jdks.png 1612w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3 id=\"stub-random-data\" style=\"position:relative;\"><a href=\"#stub-random-data\" aria-label=\"stub random data permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Stub (random) Data</h3>\n<p>Even though compression ratios in the Real dataset are different, it’s mostly 2x and higher, plus the data is not all random. It’s also interesting to check how algorithms behave on more different compression ratios and more random data. So, for Stub Data let’s check performance for different compression ratios.</p>\n<h4 id=\"lz4-fast-vs-snappy\" style=\"position:relative;\"><a href=\"#lz4-fast-vs-snappy\" aria-label=\"lz4 fast vs snappy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>lz4 fast vs snappy</h4>\n<p>Looking at throughput graphs it seems that lz4 fast compressor is a very decent alternative for snappy, when compression ratio is not very important. Decoding is faster:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ae9790548f72725197ac2b941557dd49/d004c/stub-lz4-fast-vs-snappy-decode.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.94594594594595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABS0lEQVQoz42Sy44cIQxF6///NIpSVTxsYzCcqOjpnllkEUtHyBa+hgvHGIOIYM3J/E/WWgwzughdlbCG/L4QFY4ZwVyLJ9Y/eMfP/BEdqluYteix+JUMlcrh7szWiFqJnJk5EembkRL9ToQ7MTrx3MgUyQ3VidnEfXDefyilcOScaaUid8G04c1p5lRpyIM6UpR6JixXJFVqUrLMfTKPxYzFkIZ3fwk+RR+gvqi20Lbwvmi+UJtYW6gE5XasOPk0LCu9Kl6EOcbHmqO1RrOBt6B7MPp84c/kt3mLmBOP+GLs2pv1g2O/8A/7x5r0FVg4MozsSnKldiN5JbtwtcLVKhaGDGXsybwEe+/bzPO6uO6b8zo3KSVyymipmAhSCtP6h8fXkoWahdHHt+DzBbTKbtRS6GKE+uZp7NWoV8ar4WKvtdre17/y4f0j+Bet58BveRn/gQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Decoding Throughput: lz4 fast vs snappy\"\n        title=\"Decoding Throughput: lz4 fast vs snappy\"\n        src=\"/static/ae9790548f72725197ac2b941557dd49/50383/stub-lz4-fast-vs-snappy-decode.png\"\n        srcset=\"/static/ae9790548f72725197ac2b941557dd49/1d79a/stub-lz4-fast-vs-snappy-decode.png 185w,\n/static/ae9790548f72725197ac2b941557dd49/1efb2/stub-lz4-fast-vs-snappy-decode.png 370w,\n/static/ae9790548f72725197ac2b941557dd49/50383/stub-lz4-fast-vs-snappy-decode.png 740w,\n/static/ae9790548f72725197ac2b941557dd49/73caa/stub-lz4-fast-vs-snappy-decode.png 1110w,\n/static/ae9790548f72725197ac2b941557dd49/536c7/stub-lz4-fast-vs-snappy-decode.png 1480w,\n/static/ae9790548f72725197ac2b941557dd49/d004c/stub-lz4-fast-vs-snappy-decode.png 1611w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>As well as encoding:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a66b2fe4fb509157e5c8f697c97d8aff/d004c/stub-lz4-fast-vs-snappy-encode.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.94594594594595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABN0lEQVQoz5WR22okMQxE+/9/cyHLkPalbcsX2e6z2MkMyUMIaygkrFJRqI7eO/d98z9vsbUUhipjdGZT5N0iWTjGGOSc8deF8x5rTiQkShDER+qV6DFvaJBdmw+7v3VwV6Xp5HEVsiSO5TBYh388yNeFt2aLRnfhznPP7K6G5BzRGvTKJFdxp5BspZWG9YYYI0dKCZVG9YVyFTQ0kgsYY8ih7P7P3zeMdZzO4oxFkyIxUSRSJXKr0qXStHEs1dZvchuUNsg6KXq/kHVgJPOeEkYisVZqn4S67see65iv+x6qypxzB/MT1hNV2uhkrVtE2qBP6APm4nxydyi/CT5R+8CVgCuR0iuiiT71I/lP0R3KEv3N4XNhzLFd1l53X7TQZ39xtsMl+hXr74l1EhHZ9du8f997Cv4DJwXAOOnQyv4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Encoding Throughput: lz4 fast vs snappy\"\n        title=\"Encoding Throughput: lz4 fast vs snappy\"\n        src=\"/static/a66b2fe4fb509157e5c8f697c97d8aff/50383/stub-lz4-fast-vs-snappy-encode.png\"\n        srcset=\"/static/a66b2fe4fb509157e5c8f697c97d8aff/1d79a/stub-lz4-fast-vs-snappy-encode.png 185w,\n/static/a66b2fe4fb509157e5c8f697c97d8aff/1efb2/stub-lz4-fast-vs-snappy-encode.png 370w,\n/static/a66b2fe4fb509157e5c8f697c97d8aff/50383/stub-lz4-fast-vs-snappy-encode.png 740w,\n/static/a66b2fe4fb509157e5c8f697c97d8aff/73caa/stub-lz4-fast-vs-snappy-encode.png 1110w,\n/static/a66b2fe4fb509157e5c8f697c97d8aff/536c7/stub-lz4-fast-vs-snappy-encode.png 1480w,\n/static/a66b2fe4fb509157e5c8f697c97d8aff/d004c/stub-lz4-fast-vs-snappy-encode.png 1611w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>However, this benchmark doesn’t take into account the IO limit of the system: network/disk throughput is not infinite, so the compressor is not going to work on its best performance. I tried to emulate IO limit, but it doesn’t seem to depict the reality. And for that I’m going to run another benchmark soon…</p>\n<h4 id=\"gzip-vs-deflate\" style=\"position:relative;\"><a href=\"#gzip-vs-deflate\" aria-label=\"gzip vs deflate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>gzip vs deflate</h4>\n<p>Gzip and deflate have <a href=\"https://stackoverflow.com/a/68538037/426397\">12 bytes difference</a> in header/footer sizes. Apart from that gzip uses deflate to compress data. But, there is a performance difference between them!</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c85fe368e1a0aa74f28df69545500181/d004c/stub-gzip-vs-deflate-decode.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.94594594594595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABUklEQVQoz22SjY7cIAyE8/4P2t5VRwj/sQ18Fezu3aqqpclYBM3Y2IeI0HtnzskYY/PGM19nWiuS8/e/dbbvjsmYDy5/TkopHGb2IwSM3rfAO4YIo1Xsvr/vbbzMgc+rkXLmWBUukRXdDC2FOTpTldkas1YsN+4z05dBa9jqyuxRwKq2d07viDFyrM9y2WIxMFJBY6FelZqUVjulDnIx2pkZq+Ja6CliMaAhMM2wcrOK24LLwZzj9oWYO/WeyIC7Q9FJs4kOKMI20SJIEawKc3VoxisOUUHdiXMN1wZJDV8rZ05cORFLJpYH5yaEqriohGRcqeMuQ5b7802P0Y3fH55fX54UAiUEJBfulGkh0WJ+IhG8x5+O6C+unXvOL8/d5EdQVLnO8BiGdroYQ/tehfd4TZX36f6D3fJrSn0MbPHOn7xWSHXvl4qwVkzXAP6Dl+BfiePAdB0dKa0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Decoding Throughput: gzip vs deflate\"\n        title=\"Decoding Throughput: gzip vs deflate\"\n        src=\"/static/c85fe368e1a0aa74f28df69545500181/50383/stub-gzip-vs-deflate-decode.png\"\n        srcset=\"/static/c85fe368e1a0aa74f28df69545500181/1d79a/stub-gzip-vs-deflate-decode.png 185w,\n/static/c85fe368e1a0aa74f28df69545500181/1efb2/stub-gzip-vs-deflate-decode.png 370w,\n/static/c85fe368e1a0aa74f28df69545500181/50383/stub-gzip-vs-deflate-decode.png 740w,\n/static/c85fe368e1a0aa74f28df69545500181/73caa/stub-gzip-vs-deflate-decode.png 1110w,\n/static/c85fe368e1a0aa74f28df69545500181/536c7/stub-gzip-vs-deflate-decode.png 1480w,\n/static/c85fe368e1a0aa74f28df69545500181/d004c/stub-gzip-vs-deflate-decode.png 1611w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>This is very strange, because under the hood, both deflate and gzip use <code class=\"language-text\">Inflater</code>/<code class=\"language-text\">Deflater</code> classes from JDK.</p>\n<h4 id=\"deflate-vs-mysql-compress\" style=\"position:relative;\"><a href=\"#deflate-vs-mysql-compress\" aria-label=\"deflate vs mysql compress permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>deflate vs MySQL Compress</h4>\n<p>As I mentioned before, <a href=\"https://dev.mysql.com/doc/refman/8.0/en/encryption-functions.html#function_compress\">MySQL Compress</a> is deflate plus size of the uncompressed input. This size (extra 4 bytes) allows to allocate buffer precisely on decoding, which may save few allocations and memory copy. And it’s something that we actually see on a graph:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a783d977f5062f597f5b9d8c16d63a72/8c833/stub-deflate-vs-mysql-decode.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.48648648648649%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABU0lEQVQoz2WSi47dIAxE8/8/Wu2VEt4Y8zqVc5u725ZoNISBsQ0+VJU5J3tv1lo3f+a9s02r9cYyzdZ/4Fkrr4ucM8cY49sI2GO8DUTYqjcvbayc35rtefAE35uvICQztAw/hiJQK8zJ7J3RGr1WVISaCiuldxDLvI+/jC93EkLgiDHeEZDKLAUpFSlCKY3aJjI2RTepTkqujJSYOd8ZzxAY3rO1M6piyR3RooqgzpOyku1gWzSFIpNSB9IGXTfZCuimdUQ7qp1pFc7BMw5tjXp6ztBwuRFr5QqRK3hCjoQUb445klPBuYp3neAH3g/Oa9B03WZW+rHm5Ncr8PW68Jcjh4wWoWVBUr3RklBixjuPcx7vLrw7ce7iOk+ktm9D7Z0cEqMpey7WmDdMfF/5/8P64Xnhz7ffew97YevDuSbD+A+eee+dUsp94dZi9m/8Lx7D37eQwHvnz5i2AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Decoding Throughput: deflate vs deflate+size\"\n        title=\"Decoding Throughput: deflate vs deflate+size\"\n        src=\"/static/a783d977f5062f597f5b9d8c16d63a72/50383/stub-deflate-vs-mysql-decode.png\"\n        srcset=\"/static/a783d977f5062f597f5b9d8c16d63a72/1d79a/stub-deflate-vs-mysql-decode.png 185w,\n/static/a783d977f5062f597f5b9d8c16d63a72/1efb2/stub-deflate-vs-mysql-decode.png 370w,\n/static/a783d977f5062f597f5b9d8c16d63a72/50383/stub-deflate-vs-mysql-decode.png 740w,\n/static/a783d977f5062f597f5b9d8c16d63a72/73caa/stub-deflate-vs-mysql-decode.png 1110w,\n/static/a783d977f5062f597f5b9d8c16d63a72/536c7/stub-deflate-vs-mysql-decode.png 1480w,\n/static/a783d977f5062f597f5b9d8c16d63a72/8c833/stub-deflate-vs-mysql-decode.png 1609w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>This optimization indeed helps a lot.</p>\n<h4 id=\"brotli-vs-gzip\" style=\"position:relative;\"><a href=\"#brotli-vs-gzip\" aria-label=\"brotli vs gzip permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>brotli vs gzip</h4>\n<p>Brotli is supposed to be more efficient replacement for deflate/gzip. And it’s :) From the performance standpoint, brotli with compression level 6 is generally faster than gzip/deflate. After certain size (in this benchmark somewhere between 20K and 30K) brotli performs significantly better:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6adeb72b2c14d45cbaae8f4d0c037fd6/8c833/stub-brotli-vs-gzip-decode.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.48648648648649%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABW0lEQVQoz42S4Y7cIAyE8/7veT3daRMggME24avI7l7V/ipoNMEZDxi8qSpjDOacXNf15Nf34rliIlyl/GiupX9pb/igfB9Ia2zu/mM0gbnErT0hcmOI4DFiIWKt4a1jIjd8sTlfqSEibOuE947LzAyWiRtDFe/PxN46OiZohyagCu4rA9aJ3TjCTimFLZ/nszR3Zin0KtTSKLUjzeg+0QG1XyS5UB1YVSwLlio9VS4deO2YO9t5nvd9jBiR0mjr59oYsAHdBrU5ppOuk9ygrUIUmk7MJmOJX2NTMzydpJCJtRNT5tgj8Yjsj8DjETj2QAg7OUVySoSQyKmSkxBDRdVvs/UO27q//Wvn49eD78+d+MiUs1Kz0GvDpKNN6U2pVci1kmshlUTKiXBG1PSPoaoRjxPtr+A/83/Gu33uklfLrD68rsFqoYW1frOpUesqy+6Y2d/s9sx5G/4GSwDAgqg+280AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Decoding Throughput: brotli (6) vs gzip\"\n        title=\"Decoding Throughput: brotli (6) vs gzip\"\n        src=\"/static/6adeb72b2c14d45cbaae8f4d0c037fd6/50383/stub-brotli-vs-gzip-decode.png\"\n        srcset=\"/static/6adeb72b2c14d45cbaae8f4d0c037fd6/1d79a/stub-brotli-vs-gzip-decode.png 185w,\n/static/6adeb72b2c14d45cbaae8f4d0c037fd6/1efb2/stub-brotli-vs-gzip-decode.png 370w,\n/static/6adeb72b2c14d45cbaae8f4d0c037fd6/50383/stub-brotli-vs-gzip-decode.png 740w,\n/static/6adeb72b2c14d45cbaae8f4d0c037fd6/73caa/stub-brotli-vs-gzip-decode.png 1110w,\n/static/6adeb72b2c14d45cbaae8f4d0c037fd6/536c7/stub-brotli-vs-gzip-decode.png 1480w,\n/static/6adeb72b2c14d45cbaae8f4d0c037fd6/8c833/stub-brotli-vs-gzip-decode.png 1609w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>The same goes for the encoding, but threshold is even smaller (around 3K-4K):</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/152cb542025341a840066752cb147bf0/8c833/stub-brotli-vs-gzip-encode.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.48648648648649%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABSklEQVQoz22Si27bMAxF/f9fma5Y4nSzI1svSyR1Bjl2062jcEUCgg4vKA2qipnRWnuK9llbPxPFqmClPrPo31KjiRI+ZlLODCewxw5T+wZoZ0Ozb8AOEzXuLpFSYlBRtCkxefz8IC+BlgXLgva8Cc2+ON8bv9SjG5ofvwkhMIQYSSFQl7i7S5LZZNsv767V0FRfI/mPsEYNGyLC0KklCWoHoDWKFlJNFClIE1pRrCjt6/oXesSgIuSqfHghlsqmFTFDTHe3sWZ8CUgutK3PzGjVQA/ImQ7w/ihhdqwu4bwRs7FEwSchZSVmZU0bc15x0eP8oXXFr5HkM1r1EzpYJ5cNWxxlmljHieU24cYHbnQ8fk57/vU+cbuMXN9Gbm93bj/uXN/vXC5XVh9fwL6J6lMimApmiqrQ3VepxBQppeznXf1nnPWpc45/AN2mwVKAn8vsAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Encoding Throughput: brotli (6) vs gzip\"\n        title=\"Encoding Throughput: brotli (6) vs gzip\"\n        src=\"/static/152cb542025341a840066752cb147bf0/50383/stub-brotli-vs-gzip-encode.png\"\n        srcset=\"/static/152cb542025341a840066752cb147bf0/1d79a/stub-brotli-vs-gzip-encode.png 185w,\n/static/152cb542025341a840066752cb147bf0/1efb2/stub-brotli-vs-gzip-encode.png 370w,\n/static/152cb542025341a840066752cb147bf0/50383/stub-brotli-vs-gzip-encode.png 740w,\n/static/152cb542025341a840066752cb147bf0/73caa/stub-brotli-vs-gzip-encode.png 1110w,\n/static/152cb542025341a840066752cb147bf0/536c7/stub-brotli-vs-gzip-encode.png 1480w,\n/static/152cb542025341a840066752cb147bf0/8c833/stub-brotli-vs-gzip-encode.png 1609w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2 id=\"other-interesting-details\" style=\"position:relative;\"><a href=\"#other-interesting-details\" aria-label=\"other interesting details permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Other interesting details</h2>\n<h3 id=\"brotli\" style=\"position:relative;\"><a href=\"#brotli\" aria-label=\"brotli permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Brotli</h3>\n<p>There are 3 libraries for Java:</p>\n<ul>\n<li><a href=\"https://github.com/google/brotli\">org.brotli:dec</a>: an old library by Google, last updated in 2017.</li>\n<li><a href=\"https://github.com/nixxcode/jvm-brotli\">com.nixxcode.jvmbrotli:jvmbrotli</a>: also old, updated in 2019.</li>\n<li><a href=\"https://github.com/hyperxpro/Brotli4j\">com.aayushatharva.brotli4j:brotli4j</a>: the one I used in the benchmark.</li>\n</ul>\n<p><code class=\"language-text\">dec</code> library allows only decompression (it’s used for decompression only in commons-compress). I decided to benchmark it, and results are very sad:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Action   (algorithm) (ratio) (length)      Score  Units\ndecode      brotli_6  medium   102400    813.029  us/op\ndecode           dec  medium   102400   2220.280  us/op\ndecode     jvmbrotli  medium   102400   2644.517  us/op</code></pre></div>\n<h3 id=\"lz4\" style=\"position:relative;\"><a href=\"#lz4\" aria-label=\"lz4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>lz4</h3>\n<p>lz4 is supported in commons-compress. A short benchmark showed that its more than 1 order of magnitude slower than <code class=\"language-text\">org.lz4:lz4-java</code> that is used in the benchmark.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Action  (algorithm)  (length)    Score  Units\ndecode    lz4_block     62830  726.496  us/op\ndecode   lz4_framed     62830  891.120  us/op\ndecode     lz4_fast     62830   30.119  us/op\ndecode   lz4_high17     62830   22.561  us/op\ndecode    lz4_high9     62830   22.075  us/op</code></pre></div>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>Even though the results of the benchmark look promising, I am not fully convinced that I will see the same level of performance in a real-life application: I briefly mentioned that IO limit of network/disk is hard to emulate, so it’s hard to predict how it will behave.</p>\n<p>Anyway,</p>\n<ul>\n<li>lz4 looks really promising and I’m looking forward to make a more comprehensive benchmark with it!</li>\n<li>Brotli surprised that by default it uses maximum compression which is extremely slow. And what surprised me even more, that decoding speed of highly compressed data is also slower. Which makes some compression level in the middle a much better choice.</li>\n<li>Zstd stands somewhere in the middle in terms of performance and compression ratio.</li>\n</ul>\n<p>Another interesting point for me is that artificial data (random) shows more or less the same trends for compression algorithms, but the real data is decompressed faster for the same compression ratio (lz4 level 17 for real data ~69 usec vs ~88 usec for random data). So, it’s important to benchmark on the real data samples if possible.</p>\n<p>Play with charts <a href=\"/charts/java-compression\">here</a>. Source code is on <a href=\"https://github.com/dkomanov/stuff/tree/4e7dd1ff5ffc3354115b90f29ef3c14ec2ebd96b/src/com/komanov/compression\">GitHub</a>. Originally posted on <a href=\"https://dkomanov.medium.com/java-compression-performance-fb373078cfde\">Medium</a>. <a href=\"https://pixabay.com/photos/water-pump-manometer-pressure-gauge-7177350/\">Cover image</a> by <a href=\"https://pixabay.com/users/indoposter-24870892/\">indoposter</a> from <a href=\"https://pixabay.com/\">Pixabay</a>.</p>","fields":{"slug":"/p/java-compression-performance/"},"frontmatter":{"rawDate":"2023-01-10T00:00:00.000Z","date":"January 10, 2023","title":"Java Compression Performance","description":"A performance benchmark for a few compression libraries in Java","tags":["java","compression","jni","lz4","deflate","brotli","gzip","blob","benchmark","performance"],"canonicalUrl":"https://dkomanov.medium.com/java-compression-performance-fb373078cfde","cover":{"publicURL":"/static/b533fb6ce07791f6e8fd3359c5f591bb/cover.jpg"}}}},"pageContext":{"slug":"/p/java-compression-performance/","previous":{"fields":{"slug":"/p/mysql-blob-fetch-performance-in-java/"}},"next":null}},"staticQueryHashes":["3675711862"]}