<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta data-react-helmet="true" name="twitter:description" content="A step by step guide how code optimization is done: what to look for during optimization process, how to win nanoseconds and have fun!"/><meta data-react-helmet="true" name="twitter:title" content="Optimizing Performance of Simple Version Parsing in Scala"/><meta data-react-helmet="true" name="twitter:creator" content="Dmitry Komanov"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="og:type" content="website"/><meta data-react-helmet="true" name="og:description" content="A step by step guide how code optimization is done: what to look for during optimization process, how to win nanoseconds and have fun!"/><meta data-react-helmet="true" name="og:title" content="Optimizing Performance of Simple Version Parsing in Scala"/><meta data-react-helmet="true" name="description" content="A step by step guide how code optimization is done: what to look for during optimization process, how to win nanoseconds and have fun!"/><meta name="theme-color" content="#663399"/><meta name="generator" content="Gatsby 4.19.2"/><style data-href="/styles.0dc5cf8c2594c5e48801.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#000;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;text-shadow:0 1px #fff;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#b3d4fc;text-shadow:none}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{background:hsla(0,0%,100%,.5);color:#9a6e3a}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}article{border-bottom:1px solid #f2f2f0;padding:40px 0}article:last-child{border-bottom:0}article .post-title{display:block;font-size:28px;font-style:normal;font-weight:700;letter-spacing:-.02em;line-height:1.1;margin:0}article .post-teaser{float:left;height:100px;padding:0 10px 0 0;width:100px}article .post-description{color:#666665;font-size:20px;font-style:normal;font-weight:300;letter-spacing:-.02em;line-height:1.3}article .teaser-padding{margin-left:110px}article .post-meta{color:#b3b3b1;font-size:14px;line-height:30px}article .post-meta time{margin:0 1em 0 0;vertical-align:middle}ul.pagination{list-style:none;margin:1em 0 0;padding:0}ul.pagination li{color:#b3b3b1;float:left;padding:0 10px 0 0}ul.pagination li.active{font-weight:700}ul.pagination li a,ul.pagination li a:visited{color:#b3b3b1;text-decoration:none}.btn{background-color:transparent;border:none;cursor:pointer;display:inline;margin:0;outline:0;padding:0;text-decoration:underline}.btn:focus,.btn:hover{text-decoration:none}.table-toggler{text-align:center}.table-toggler a{border-bottom:1px dotted #000;cursor:pointer;font-size:.7em}.raw-data-table table{width:100%}.raw-data-table table th{background-color:rgba(0,0,0,.03)}.raw-data-table table .right{text-align:right}.markdown div.choose ul{margin:.5em 0 0;padding:0}.markdown div.choose ul li:first-child{border-radius:5px 0 0 5px}.markdown div.choose ul li:last-child{border-radius:0 5px 5px 0}.markdown div.choose ul li{background-color:rgba(0,0,0,.05);color:rgba(0,0,0,.68);cursor:pointer;line-height:1.4;margin:0;min-width:40px;padding:3px .5em;text-align:center}.markdown div.choose ul li:not(.slider):hover{background-color:rgba(0,0,0,.15)}.markdown div.choose ul li.active{background-color:rgba(0,0,0,.15);cursor:default}.markdown div.choose label{background-color:rgba(0,0,0,.05);color:rgba(0,0,0,.68);display:inline-block;font-size:23px;margin:0 .5em 0 0;padding:5px;vertical-align:bottom}.markdown div.choose li.slider input[type=range]{vertical-align:middle}body{text-rendering:optimizeLegibility;-webkit-font-feature-settings:"liga";font-feature-settings:"liga";font-family:Open Sans,MundoSans,Helvetica Neue,Arial,Helvetica,sans-serif;font-size:1.2em;margin:0;padding:0}a{color:#333332}a,a:hover{text-decoration:none}.cf:after{clear:both;content:"";display:table}ul.horizontal{display:inline-block;list-style:none;margin:0;padding:0;vertical-align:top}ul.horizontal li{float:left}.site-header{box-sizing:border-box;margin:0 auto;max-width:740px;padding:0;position:relative;top:-140px;width:100%;z-index:2}.site-header .site-logo{background-color:#fff;background-image:url(data:image/jpeg;base64,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);background-size:cover;border:3px solid #fff;border-radius:50%;box-shadow:0 1px 1px rgba(0,0,0,.3);height:120px;margin-right:-60px;position:absolute;right:50%;text-indent:-9999px;top:-60px;width:120px;z-index:99}.site-header .site-title{color:#fff;font-size:50px;font-weight:700;letter-spacing:-2px;line-height:50px;margin:0;outline:0;padding:84px 16px 8px;text-align:center;word-break:break-word}.site-header .site-description{color:#666;font-size:18px;font-weight:400;line-height:1.5;margin:0 0 20px;padding:0 32px;text-align:center}.site-content{box-sizing:border-box;margin:0 auto;max-width:740px;position:relative;top:-140px;width:100%}.wide-content{display:block;left:50%;margin-left:-48vw;margin-right:-48vw;position:relative;right:50%;width:96vw}@media only screen and (max-width:800px){.site-content{padding:0 32px}}.markdown{color:#333;width:100%}.markdown,.markdown h1,.markdown h2,.markdown h3{font-family:Linux Libertine,serif}.markdown h3,.markdown h4,.markdown h5,.markdown h6{font-family:Linux Libertine,serif;font-size:24px;font-style:normal;font-weight:700;letter-spacing:-.02em;line-height:1.3;margin:0 0 4px}.markdown h5,.markdown h6{font-family:Linux Libertine,serif;font-size:20px;font-style:normal;font-weight:500;letter-spacing:.02em;line-height:1.4;margin:0 0 3px;text-transform:uppercase}.markdown h1,.markdown h2{font-size:32px;font-style:normal;font-weight:700;letter-spacing:-.02em;line-height:1.2;margin-bottom:4px;padding-top:31px}.markdown p{color:#333;font-size:22px;font-style:normal;font-weight:400;-webkit-hyphens:auto;hyphens:auto;line-height:30px;margin:0;padding-bottom:30px}.markdown a{color:#333;text-decoration:underline}.markdown img{margin:0 auto;max-width:100%}.markdown figure{margin:0;padding:0 0 30px}.markdown figcaption{color:#666665;font-size:16px;font-style:italic;font-weight:400;line-height:1.3;outline:0;text-align:center;z-index:300}.markdown hr{border:0;border-top:1px solid #ddd;display:block;margin:30px auto;padding:0;width:15%}.markdown blockquote,.markdown li blockquote{border-left:3px solid #57ad68;margin:0 0 30px -26px;padding-left:20px}.markdown blockquote p,.markdown li blockquote p{border-left:3px solid #57ad68;font-style:italic;font-weight:400;letter-spacing:.01rem;margin-left:-26px;padding-bottom:3px;padding-left:20px}.markdown ol,.markdown ul{margin:0;padding:0 0 30px}.markdown li{font-size:23px;font-style:normal;font-weight:400;line-height:30px;margin-bottom:12px;margin-left:30px;padding:2px 0 0}.markdown li p{padding:0 0 1.618rem}.markdown ol li{list-style-type:decimal}.markdown code{font-size:18px}.markdown.tiny *{font-size:16px;line-height:1.2em}.markdown.tiny ul{padding:0}.markdown.tiny ul li{margin-bottom:0}footer{color:#999;font-size:12px;line-height:17.6px;margin:0 auto;max-width:640px;padding:22px 0;text-align:center;width:100%}footer a{color:#666;text-decoration:none}footer a:hover{color:#333}.share-buttons{display:inline-block}.share-buttons .share-button{display:inline-block;margin:0 0 0 .5em;text-align:center;vertical-align:top}.site-menu{color:#ccc;margin:0 0 50px;text-align:center}.site-menu a{color:#999;padding-left:20px;text-decoration:none}.site-menu a:hover{color:#333}.site-menu a.active{font-weight:700}.tag-cloud a{margin:6px}ul.tags{display:inline-block;list-style:none;margin:0;padding:0;vertical-align:top}ul.tags li{background-color:rgba(0,0,0,.05);border-radius:3px;float:left;line-height:1.4;margin:4px .5em 0 0;padding:3px 5px}ul.tags li:hover{background-color:rgba(0,0,0,.15)}ul.tags li.label{padding:0 .5em 0 0}ul.tags li a,ul.tags li a:visited{color:rgba(0,0,0,.68);text-decoration:none}.teaser-image{background-color:#000;height:360px;overflow:hidden;position:relative}.teaser-image_image{background-position:50%;background-size:cover;bottom:0;left:0;position:absolute;right:0;text-indent:-9999px;top:0;z-index:1}.time-units p.small{margin:0 0 10px}.time-units small{color:rgba(0,0,0,.3);font-size:11px}.site-content.no-cover{position:relative;top:0}.no-cover .post-meta{padding-top:60px}.no-cover .post-title{color:#333332;font-size:50px;font-style:normal;font-weight:700;letter-spacing:-.04em;line-height:1.1;margin-bottom:16px}.no-cover .author-image{background-image:url(/img/top-logo.jpg);background-size:cover;border-radius:100%;display:inline-block;float:left;height:30px;line-height:30px;margin-bottom:-10px;margin-right:8px;text-indent:-9999px;width:30px}.no-cover .author-name{display:inline}.no-cover .post-meta-text{color:#b3b3b1;font-size:14px;font-style:normal;font-weight:400;letter-spacing:-.02em;text-overflow:ellipsis;white-space:nowrap}.blog-post-meta{color:#b3b3b1}ul.what-i-read{list-style-type:none;margin:0;padding:0}ul.what-i-read>li{display:inline-block;padding:0 10px 0 0}</style><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="alternate" type="application/rss+xml" title="Severe Software Developer Blog" href="/rss.xml"/><link rel="icon" href="/favicon-32x32.png?v=994a873755adc623fbc44f1a9a107c69" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=994a873755adc623fbc44f1a9a107c69"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=994a873755adc623fbc44f1a9a107c69"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=994a873755adc623fbc44f1a9a107c69"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=994a873755adc623fbc44f1a9a107c69"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=994a873755adc623fbc44f1a9a107c69"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=994a873755adc623fbc44f1a9a107c69"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=994a873755adc623fbc44f1a9a107c69"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=994a873755adc623fbc44f1a9a107c69"/><title data-react-helmet="true">Optimizing Performance of Simple Version Parsing in Scala | @dkomanov</title><link data-react-helmet="true" rel="canonical" href="https://dkomanov.medium.com/optimizing-performance-of-simple-version-parsing-in-scala-aeff8bc133a5"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><div class="teaser-image"><div class="teaser-image_image" style="background-image:url(/static/ac7cbf764cf6c6ea8c34a821239aaffc/cover.jpg);transform:translate3d(0px, 0px, 0px);opacity:1">Teaser Image</div></div><header class="site-header"><a class="site-logo" href="/">@dkomanov</a><h1 class="site-title">@dkomanov</h1><div class="site-description">Severe Software Developer Blog</div><div class="site-menu"><a href="/">Blog</a><a href="/what-i-read">What I Read</a><a href="/what-i-listen">What I Listen</a><a href="/about">About</a></div></header><div class="site-content"><div class="blog-post" itemscope="" itemType="http://schema.org/Article"><h1>Optimizing Performance of Simple Version Parsing in Scala</h1><div class="markdown " role="main"><p>For some time I wanted to write a blog post about performance optimizations: a step by step guide how to improve performance of some small portion of code. Something like I did in the past — <a href="/p/micro-optimization-for-uuid-fromstring-in-7-steps">Micro-optimization for UUID.fromString in 7 steps</a>. And recently I finally found an example from the actual production code, so it won’t be a made up challenge to improve something bad, but something potentially useful :)</p>
<p>Here I want to demonstrate on a fairly simple example many different aspects of code and how it’s possible to optimize it as much as possible, step by step improving performance by rewriting, redesigning and rewriting again. Without further ado, let’s start!</p>
<h2 id="what-are-we-benchmarking" style="position:relative;"><a href="#what-are-we-benchmarking" aria-label="what are we benchmarking permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What Are We Benchmarking?</h2>
<p>Use case is very simple, we have this data structure:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">case</span> <span class="token keyword">class</span> Version<span class="token punctuation">(</span>major<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> minor<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> fix<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> toString<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">major</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">minor</span></span><span class="token string">$.fix"</span></span>
<span class="token punctuation">}</span></code></pre></div>
<p>Each part of Version is a number between 0 and 10000. A string representation of <code class="language-text">Version(1, 0, 0)</code> would be <code class="language-text">"1.0.0"</code>. No semantic versioning, no hyphens etc. Just 2 dots and 3 numbers. And there’s a code for parsing this string representation:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">def</span> parse<span class="token punctuation">(</span>v<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span>Version<span class="token punctuation">]</span> <span class="token operator">=</span> Try <span class="token punctuation">{</span>
  <span class="token keyword">val</span> numbers<span class="token annotation punctuation">@Array</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> minor<span class="token punctuation">,</span> fix<span class="token punctuation">)</span> <span class="token operator">=</span> v<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token char">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>toInt<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>numbers<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>num <span class="token keyword">=></span> num <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> num <span class="token operator">></span> MaxVersionSize<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> RuntimeException<span class="token punctuation">(</span>v<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  Version<span class="token punctuation">(</span>major<span class="token punctuation">,</span> minor<span class="token punctuation">,</span> fix<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">.</span>toOption</code></pre></div>
<h2 id="lets-optimize" style="position:relative;"><a href="#lets-optimize" aria-label="lets optimize permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Let’s Optimize!</h2>
<p>First, we need to benchmark this code with different inputs:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Benchmark       (encoded)  Mode  Cnt     Score     Error  Units
yolo        200.200.99999  avgt    5  2133.263 ± 218.761  ns/op
yolo                1.0.0  avgt    5   163.856 ±  12.370  ns/op</code></pre></div>
<h3 id="step-1-exceptions-are-expensive" style="position:relative;"><a href="#step-1-exceptions-are-expensive" aria-label="step 1 exceptions are expensive permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Step 1. Exceptions Are Expensive</h3>
<p>In the code above we have <code class="language-text">Try(...).toOption</code>, which means that we ignore all exceptions. If there’s any exception we consider this version invalid — <code class="language-text">None</code>. But we know that exceptions are <a href="https://shipilev.net/blog/2014/exceptional-performance/">very expensive</a>. And the depth of the stack trace makes it more and more expensive. In this case stack trace is very small: it’s a JMH benchmark, so depth is smaller than 20, in a real application it would be significantly larger, meaning even slower. Let’s get rid of a <code class="language-text">throw</code> statement, which is easy:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala">Try <span class="token punctuation">{</span>
  <span class="token keyword">val</span> numbers<span class="token annotation punctuation">@Array</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> minor<span class="token punctuation">,</span> fix<span class="token punctuation">)</span> <span class="token operator">=</span> v<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token char">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>toInt<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>numbers<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>num <span class="token keyword">=></span> num <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> num <span class="token operator">></span> MaxVersionSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
    None
  <span class="token keyword">else</span>
    Some<span class="token punctuation">(</span>Version<span class="token punctuation">(</span>major<span class="token punctuation">,</span> minor<span class="token punctuation">,</span> fix<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">.</span>toOption<span class="token punctuation">.</span>flatten</code></pre></div>
<p>This version’s benchmarks improved quite a bit for this particular case:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Benchmark       (encoded)  Mode  Cnt     Score     Error  Units
yolo        200.200.99999  avgt    5  2133.263 ± 218.761  ns/op
yoloNoThrow 200.200.99999  avgt    5   192.138 ±   1.144  ns/op
yolo                1.0.0  avgt    5   163.856 ±  12.370  ns/op
yoloNoThrow         1.0.0  avgt    5   163.308 ±  10.761  ns/op</code></pre></div>
<h3 id="step-15-more-issues-to-solve" style="position:relative;"><a href="#step-15-more-issues-to-solve" aria-label="step 15 more issues to solve permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Step 1.5. More Issues To Solve</h3>
<p>Well, we solved one case, but it’s not the only one. Let’s see what we actually do here. All the relevant pieces in this single line of code:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">val</span> numbers<span class="token annotation punctuation">@Array</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> minor<span class="token punctuation">,</span> fix<span class="token punctuation">)</span> <span class="token operator">=</span> v<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token char">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>toInt<span class="token punctuation">)</span></code></pre></div>
<p>Let’s break it down.</p>
<ol>
<li><code class="language-text">v.split('.')</code> iterates over entire String, finds dots and creates an array of Strings. To create array it uses intermediate <code class="language-text">ArrayList</code>. So, it allocates at least 2 times more memory than needed.</li>
<li><code class="language-text">.map(_.toInt)</code> creates an Array of Int, parses all the split parts (meaning, iterates over each String again). <code class="language-text">toInt</code> (which is just <code class="language-text">Integer.parseInt</code>) may throw an exception.</li>
<li><code class="language-text">numbers@Array(major, minor, fix)</code> extracts 3 elements from an array, if array length is not 3 — throws an exception.</li>
<li>Also, there is <code class="language-text">Try(...).toOption</code>…</li>
</ol>
<h3 id="step-3-remove-scalautiltry" style="position:relative;"><a href="#step-3-remove-scalautiltry" aria-label="step 3 remove scalautiltry permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Step 3. Remove scala.util.Try</h3>
<p>It’s a simple one, just replace <code class="language-text">scala.util.Try</code> with a regular <code class="language-text">try</code> and <code class="language-text">catch</code>:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">val</span> numbers<span class="token annotation punctuation">@Array</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> minor<span class="token punctuation">,</span> fix<span class="token punctuation">)</span> <span class="token operator">=</span> v<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token char">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>toInt<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>numbers<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>num <span class="token keyword">=></span> num <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> num <span class="token operator">></span> MaxVersionSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
    None
  <span class="token keyword">else</span>
    Some<span class="token punctuation">(</span>Version<span class="token punctuation">(</span>major<span class="token punctuation">,</span> minor<span class="token punctuation">,</span> fix<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> _<span class="token operator">:</span> Throwable <span class="token keyword">=></span> None
<span class="token punctuation">}</span></code></pre></div>
<p>And a benchmark for it:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Benchmark       (encoded)  Mode  Cnt     Score     Error  Units
yolo                1.0.0  avgt    5   163.856 ±  12.370  ns/op
yoloNoTry           1.0.0  avgt    5   164.512 ±   5.407  ns/op
yoloNoThrow         1.0.0  avgt    5   163.308 ±  10.761  ns/op
yoloNoThrowNoTry    1.0.0  avgt    5   166.721 ±   1.802  ns/op</code></pre></div>
<p>It’s slightly slower, but error is smaller (less deviations).</p>
<h3 id="step-4-regex" style="position:relative;"><a href="#step-4-regex" aria-label="step 4 regex permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Step 4. Regex</h3>
<p>Any parsing problem (especially for <a href="https://stackoverflow.com/questions/590747/using-regular-expressions-to-parse-html-why-not">HTML</a>) could be solved with regular expressions!</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">private</span> <span class="token keyword">val</span> MyRegex <span class="token operator">=</span> Pattern<span class="token punctuation">.</span>compile<span class="token punctuation">(</span><span class="token string">"(\\d{1,5})\\.(\\d{1,5})\\.(\\d{1,5})"</span><span class="token punctuation">)</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">val</span> m <span class="token operator">=</span> MyRegex<span class="token punctuation">.</span>matcher<span class="token punctuation">(</span>v<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span>matches<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">val</span> major <span class="token operator">=</span> m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt
  <span class="token keyword">val</span> minor <span class="token operator">=</span> m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt
  <span class="token keyword">val</span> fix <span class="token operator">=</span> m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt
  <span class="token keyword">if</span> <span class="token punctuation">(</span>major <span class="token operator">></span> MaxVersionSize <span class="token operator">||</span> minor <span class="token operator">></span> MaxVersionSize <span class="token operator">||</span> fix <span class="token operator">></span> MaxVersionSize<span class="token punctuation">)</span>
    None
  <span class="token keyword">else</span>
    Some<span class="token punctuation">(</span>Version<span class="token punctuation">(</span>major<span class="token punctuation">,</span> minor<span class="token punctuation">,</span> fix<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  None
<span class="token punctuation">}</span></code></pre></div>
<p>This solution is also quite readable, it doesn’t throw exceptions as regular expression validates correct non-negative numbers, so <code class="language-text">toInt</code> won’t fail.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Benchmark       (encoded)  Mode  Cnt     Score     Error  Units
yoloNoThrow     200.200.a  avgt    5  3156.323 ± 219.461  ns/op
regex           200.200.a  avgt    5   251.237 ±  13.064  ns/op
yoloNoThrow         1.0.0  avgt    5   163.308 ±  10.761  ns/op
regex               1.0.0  avgt    5   216.829 ±   0.991  ns/op</code></pre></div>
<p>For errors this version does the trick — no exceptions, so errors aren’t as slow, but the happy flow is slower! Not good!</p>
<h3 id="step-5-searching-for-dots-use-indexof" style="position:relative;"><a href="#step-5-searching-for-dots-use-indexof" aria-label="step 5 searching for dots use indexof permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Step 5. Searching For Dots (use indexOf)</h3>
<p>The code is straight-forward, but verbose a bit:</p>
<ul>
<li>indexOf 3 times to find <code class="language-text">.</code> character (the 3rd one to verify there isn’t more).</li>
<li>Check that 3 regions are numbers.</li>
<li>parseInteger for 3 regions.</li>
</ul>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">def</span> parseOptimized1<span class="token punctuation">(</span>v<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span>Version<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">val</span> index1 <span class="token operator">=</span> v<span class="token punctuation">.</span>indexOf<span class="token punctuation">(</span><span class="token char">'.'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>index1 <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> None
  <span class="token punctuation">}</span>

  <span class="token keyword">val</span> index2 <span class="token operator">=</span> v<span class="token punctuation">.</span>indexOf<span class="token punctuation">(</span><span class="token char">'.'</span><span class="token punctuation">,</span> index1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>index2 <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> None
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>v<span class="token punctuation">.</span>indexOf<span class="token punctuation">(</span><span class="token char">'.'</span><span class="token punctuation">,</span> index2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> None
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isNumber3<span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> index1<span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token operator">!</span>isNumber3<span class="token punctuation">(</span>v<span class="token punctuation">,</span> index1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> index2<span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token operator">!</span>isNumber3<span class="token punctuation">(</span>v<span class="token punctuation">,</span> index2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> None
  <span class="token punctuation">}</span>

  <span class="token keyword">val</span> majorStr <span class="token operator">=</span> v<span class="token punctuation">.</span>substring<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index1<span class="token punctuation">)</span>
  <span class="token keyword">val</span> minorStr <span class="token operator">=</span> v<span class="token punctuation">.</span>substring<span class="token punctuation">(</span>index1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> index2<span class="token punctuation">)</span>
  <span class="token keyword">val</span> fixStr <span class="token operator">=</span> v<span class="token punctuation">.</span>substring<span class="token punctuation">(</span>index2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>

  <span class="token keyword">val</span> major <span class="token operator">=</span> majorStr<span class="token punctuation">.</span>toInt
  <span class="token keyword">val</span> minor <span class="token operator">=</span> minorStr<span class="token punctuation">.</span>toInt
  <span class="token keyword">val</span> fix <span class="token operator">=</span> fixStr<span class="token punctuation">.</span>toInt

  <span class="token keyword">if</span> <span class="token punctuation">(</span>major <span class="token operator">></span> MaxVersionSize <span class="token operator">||</span> minor <span class="token operator">></span> MaxVersionSize <span class="token operator">||</span> fix <span class="token operator">></span> MaxVersionSize<span class="token punctuation">)</span>
    None
  <span class="token keyword">else</span>
    Some<span class="token punctuation">(</span>Version<span class="token punctuation">(</span>major<span class="token punctuation">,</span> minor<span class="token punctuation">,</span> fix<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>And benchmarks:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Benchmark       (encoded)  Mode  Cnt     Score     Error  Units
yoloNoThrow     200.200.a  avgt    5  3156.323 ± 219.461  ns/op
regex           200.200.a  avgt    5   251.237 ±  13.064  ns/op
optimized1      200.200.a  avgt    5    34.619 ±   0.116  ns/op
yoloNoThrow         1.0.0  avgt    5   163.308 ±  10.761  ns/op
regex               1.0.0  avgt    5   216.829 ±   0.991  ns/op
optimized1          1.0.0  avgt    5   100.512 ±   4.974  ns/op</code></pre></div>
<p>Good! Finally, we improved both error flow and success flow. Can we improve it more, though?</p>
<h3 id="step-6-replace-substring" style="position:relative;"><a href="#step-6-replace-substring" aria-label="step 6 replace substring permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Step 6. Replace substring</h3>
<p>The problematic part is this:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">val</span> majorStr <span class="token operator">=</span> v<span class="token punctuation">.</span>substring<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index1<span class="token punctuation">)</span>
<span class="token keyword">val</span> major <span class="token operator">=</span> majorStr<span class="token punctuation">.</span>toInt</code></pre></div>
<p>Here we do <code class="language-text">substring</code> and then calling <code class="language-text">parseInteger</code>. If you use JDK 9 or higher, you may use a new overload that takes <code class="language-text">beginIndex</code> and <code class="language-text">endIndex</code> arguments, so you can bypass creating a redundant <code class="language-text">String</code> instance. The fix looks like this:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">val</span> major <span class="token operator">=</span> Integer<span class="token punctuation">.</span>parseUnsignedInt<span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> index1<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> minor <span class="token operator">=</span> Integer<span class="token punctuation">.</span>parseUnsignedInt<span class="token punctuation">(</span>v<span class="token punctuation">,</span> index1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> index2<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> fix <span class="token operator">=</span> Integer<span class="token punctuation">.</span>parseUnsignedInt<span class="token punctuation">(</span>v<span class="token punctuation">,</span> index2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span></code></pre></div>
<p>And the benchmark (only for happy flows):</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Benchmark           (encoded)  Mode  Cnt     Score     Error  Units

yoloNoThrow             1.0.0  avgt    5   163.308 ±  10.761  ns/op
regex                   1.0.0  avgt    5   216.829 ±   0.991  ns/op
optimized1              1.0.0  avgt    5   100.512 ±   4.974  ns/op
optimized2              1.0.0  avgt    5    63.764 ±   4.887  ns/op

yoloNoThrow 10000.10000.10000  avgt    5   209.066 ±   1.968  ns/op
regex       10000.10000.10000  avgt    5   384.005 ±   1.439  ns/op
optimized1  10000.10000.10000  avgt    5   156.005 ±   5.058  ns/op
optimized2  10000.10000.10000  avgt    5   115.824 ±   5.485  ns/op</code></pre></div>
<p>It’s quite significant: 25%-35% faster.</p>
<h3 id="step-7-almost-there" style="position:relative;"><a href="#step-7-almost-there" aria-label="step 7 almost there permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Step 7. Almost There?</h3>
<p>However, we still have a problem - we actually go over initial string 3 times:</p>
<ol>
<li>Find all dots.</li>
<li>Check that there are only digits between dots.</li>
<li>Parse numbers.</li>
</ol>
<p>My first approach to eliminate one of these redundant passes failed miserably: I tried to go over String using pattern matching for each character, and ended up with slightly less performant solution:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Benchmark           (encoded)  Mode  Cnt     Score     Error  Units
optimized1  10000.10000.10000  avgt    5   156.005 ±   5.058  ns/op
optimized2  10000.10000.10000  avgt    5   115.824 ±   5.485  ns/op
optimized3  10000.10000.10000  avgt    5   120.257 ±   0.252  ns/op</code></pre></div>
<p>As it goes, I rewrote it to Java and got expected performance boost:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Benchmark           (encoded)  Mode  Cnt     Score     Error  Units
optimized1  10000.10000.10000  avgt    5   156.005 ±   5.058  ns/op
optimized2  10000.10000.10000  avgt    5   115.824 ±   5.485  ns/op
optimized3  10000.10000.10000  avgt    5   120.257 ±   0.252  ns/op
optimd3Java 10000.10000.10000  avgt    5   107.327 ±   3.675  ns/op</code></pre></div>
<p>Here is the loop (in Java):</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">int</span> len <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> major <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> minor <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> lastDotIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> ch <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token char">'0'</span><span class="token operator">:</span> <span class="token keyword">case</span> <span class="token char">'1'</span><span class="token operator">:</span> <span class="token keyword">case</span> <span class="token char">'2'</span><span class="token operator">:</span> <span class="token keyword">case</span> <span class="token char">'3'</span><span class="token operator">:</span> <span class="token keyword">case</span> <span class="token char">'4'</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token char">'5'</span><span class="token operator">:</span> <span class="token keyword">case</span> <span class="token char">'6'</span><span class="token operator">:</span> <span class="token keyword">case</span> <span class="token char">'7'</span><span class="token operator">:</span> <span class="token keyword">case</span> <span class="token char">'8'</span><span class="token operator">:</span> <span class="token keyword">case</span> <span class="token char">'9'</span><span class="token operator">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token punctuation">(</span>lastDotIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// longer than MaxVersionSize</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> <span class="token char">'.'</span><span class="token operator">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>major <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> parsed <span class="token operator">=</span> <span class="token function">parseIntSafeEmpty</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parsed <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> parsed <span class="token operator">></span> <span class="token class-name">MaxVersionSize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                major <span class="token operator">=</span> parsed<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>minor <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> parsed <span class="token operator">=</span> <span class="token function">parseIntSafeEmpty</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> lastDotIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parsed <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> parsed <span class="token operator">></span> <span class="token class-name">MaxVersionSize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                minor <span class="token operator">=</span> parsed<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 3rd dot</span>
            <span class="token punctuation">}</span>
            lastDotIndex <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// invalid character</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Here we validate digits and find dots in a single pass. Parsing is still requires the second pass over the same characters.</p>
<h3 id="step-8-dont-use-switch" style="position:relative;"><a href="#step-8-dont-use-switch" aria-label="step 8 dont use switch permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Step 8. Don’t use switch</h3>
<p>Inside for loop we can try to use <code class="language-text">if..else</code> instead of <code class="language-text">switch</code>:</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">char</span> ch <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">>=</span> <span class="token char">'0'</span> <span class="token operator">&amp;&amp;</span> ch <span class="token operator">&lt;=</span> <span class="token char">'9'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token punctuation">(</span>lastDotIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// longer than MaxVersionSize</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">==</span> <span class="token char">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>major <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> parsed <span class="token operator">=</span> <span class="token function">parseIntSafeEmpty</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsed <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> parsed <span class="token operator">></span> <span class="token class-name">MaxVersionSize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        major <span class="token operator">=</span> parsed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>minor <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> parsed <span class="token operator">=</span> <span class="token function">parseIntSafeEmpty</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> lastDotIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsed <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> parsed <span class="token operator">></span> <span class="token class-name">MaxVersionSize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        minor <span class="token operator">=</span> parsed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 3rd dot</span>
    <span class="token punctuation">}</span>
    lastDotIndex <span class="token operator">=</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// invalid character</span>
<span class="token punctuation">}</span></code></pre></div>
<p>And it actually gives another performance boost!</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Benchmark                       (encoded)  Mode  Cnt     Score     Error  Units
optimized3Java          10000.10000.10000  avgt    5   107.327 ±   3.675  ns/op
optimized3JavaNoSwitch  10000.10000.10000  avgt    5    97.115 ±   4.890  ns/op</code></pre></div>
<h3 id="step-9-single-pass" style="position:relative;"><a href="#step-9-single-pass" aria-label="step 9 single pass permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Step 9. Single pass!</h3>
<p>Finally, instead of parsing integers from String we need to accumulate digits as we read them. It adds some complexity, but not really much. Here is the final code for parsing version:</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">int</span> len <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> major <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> minor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> current <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> dots <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> lastDotIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token keyword">char</span> ch <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> digit <span class="token operator">=</span> ch <span class="token operator">-</span> <span class="token number">48</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>digit <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastDotIndex <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> current <span class="token operator">></span> <span class="token class-name">MaxVersionSize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>dots<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                major <span class="token operator">=</span> current<span class="token punctuation">;</span>
                dots <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
                minor <span class="token operator">=</span> current<span class="token punctuation">;</span>
                dots <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        lastDotIndex <span class="token operator">=</span> i<span class="token punctuation">;</span>
        current <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>digit <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> digit <span class="token operator">></span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// overflow is possible!</span>
        current <span class="token operator">=</span> current <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">+</span> digit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>dots <span class="token operator">!=</span> <span class="token number">2</span> <span class="token operator">||</span> lastDotIndex <span class="token operator">==</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> current <span class="token operator">></span> <span class="token class-name">MaxVersionSize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Version</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> minor<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>And the benchmark:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Benchmark                       (encoded)  Mode  Cnt     Score     Error  Units
yoloNoThrow             10000.10000.10000  avgt    5   209.066 ±   1.968  ns/op
regex                   10000.10000.10000  avgt    5   384.005 ±   1.439  ns/op
optimized1              10000.10000.10000  avgt    5   156.005 ±   5.058  ns/op
optimized2              10000.10000.10000  avgt    5   115.824 ±   5.485  ns/op
optimized3Java          10000.10000.10000  avgt    5   107.327 ±   3.675  ns/op
optimized3JavaNoSwitch  10000.10000.10000  avgt    5    97.115 ±   4.890  ns/op
optimized6              10000.10000.10000  avgt    5    57.729 ±   1.709  ns/op</code></pre></div>
<p>4 times faster from the initial implementation!</p>
<h2 id="the-end-lets-talk-about-memory" style="position:relative;"><a href="#the-end-lets-talk-about-memory" aria-label="the end lets talk about memory permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The End? Let’s Talk About Memory</h2>
<p>I mentioned at the beginning of this journey memory allocations that we have in <code class="language-text">split</code> method — to for Array of strings and for the intermediate <code class="language-text">ArrayList</code>. I ran JMH benchmark with profiler of GC (<code class="language-text">-prof gc</code>) to see how much memory different implementations allocate.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/cd7f186a65e395db94fe3bacc41fd00c/53f1b/memory.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 30.270270270270274%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABVklEQVQY04WQzSusUQDG361/RSndrY9ieWNlycIGKTao6x+wVIqELYrcvL6mWxaXoVmNj1GGBfIx75Axw505M+ecOeOcn16uFfLUs3p6fj09XvAgWdq5J18y5HZ3ePJ/I2IRTHoRa/I4B85ZnHOfOpRWBiUV1lq8rUSWmt44f0/L7Hf1cFb3g5v+RsSax7M4Jaw4+/wlMMwrZUGpJDDG4G0nMtQPJmifVvzpHCDV0kTq10+KkSqsvHotWFv5ALL/DQ6lyxQKBbTWeNEQOJSgfeod2ExquOUVqA474N8B30mbCkIIpJR40aMc1T1xWscUq23dXNfXct3XQGHZo7jukTmfJNAVMiJH8UGhs5psXnMjNffhb08ZXFm9LQ4/vLyTjPkpZmOGk3mfx5kJHtdmkMeDuPMRNpNzjCc38ZMxTlauCCJpNvYCRi/TLFwE6KgP2du3qc7xAqwbpdmzyKjUAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Normalized Memory Allocations Per Single Call, bytes"
        title="Normalized Memory Allocations Per Single Call, bytes"
        src="/static/cd7f186a65e395db94fe3bacc41fd00c/50383/memory.png"
        srcset="/static/cd7f186a65e395db94fe3bacc41fd00c/1d79a/memory.png 185w,
/static/cd7f186a65e395db94fe3bacc41fd00c/1efb2/memory.png 370w,
/static/cd7f186a65e395db94fe3bacc41fd00c/50383/memory.png 740w,
/static/cd7f186a65e395db94fe3bacc41fd00c/73caa/memory.png 1110w,
/static/cd7f186a65e395db94fe3bacc41fd00c/536c7/memory.png 1480w,
/static/cd7f186a65e395db94fe3bacc41fd00c/53f1b/memory.png 2453w"
        sizes="(max-width: 740px) 100vw, 740px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>Original and Regex versions allocate similar amount of memory — around 400 bytes per call (for a happy flow, obviously, for exceptions we need to allocate significantly more). First optimized version (Step 5) allocates 184 bytes and other optimized implementations allocate 40 bytes.</p>
<p>40 bytes is what we need for <code class="language-text">Option[Version]</code>. According to <a href="https://github.com/openjdk/jol">JOL</a>:</p>
<ul>
<li><code class="language-text">scala.Some</code> takes 16 bytes: 12 bytes for header + 4 bytes for a reference.</li>
<li><code class="language-text">Version</code> takes 24 bytes: 12 bytes for header + 12 bytes for 3 integers.</li>
</ul>
<h3 id="step-10-get-rid-of-optionversion" style="position:relative;"><a href="#step-10-get-rid-of-optionversion" aria-label="step 10 get rid of optionversion permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Step 10. Get Rid of Option[Version]</h3>
<p>Because each version part is limited to 10000, each integer needs only 14 bits (2^14 = 16384 = 16K). One <code class="language-text">long</code> can hold even 4 such integers! So, let’s try to pack everything into <code class="language-text">long</code>! We can even put a bit for “invalid” (to simulate <code class="language-text">None</code>).</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">private</span> <span class="token keyword">val</span> BitsPerValue <span class="token operator">=</span> MaxVersionSize<span class="token punctuation">.</span>toBinaryString<span class="token punctuation">.</span>length
require<span class="token punctuation">(</span>BitsPerValue <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;=</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token string">"not enough bits"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">val</span> InvalidBit <span class="token operator">=</span> <span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> BitsPerValue <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> Invalid<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> InvalidBit

<span class="token keyword">def</span> version<span class="token punctuation">(</span>major<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> minor<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> fix<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">(</span><span class="token punctuation">(</span>major <span class="token operator">&amp;</span> <span class="token number">16383</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong <span class="token operator">&lt;&lt;</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">|</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span>minor <span class="token operator">&amp;</span> <span class="token number">16383</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong <span class="token operator">&lt;&lt;</span> <span class="token number">14</span><span class="token punctuation">)</span> <span class="token operator">|</span>
    <span class="token punctuation">(</span>fix<span class="token punctuation">.</span>toLong <span class="token operator">&amp;</span> <span class="token number">16383</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>And now instead of returning <code class="language-text">Option[Version]</code> we need to return <code class="language-text">long</code> and just replace <code class="language-text">None</code> or <code class="language-text">null</code> with <code class="language-text">Invalid</code> and <code class="language-text">Some(Version(...))</code> with <code class="language-text">version(...)</code>!</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/6b4183a82cc444597a94b80a7912f881/53f1b/memory-no-alloc.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 30.270270270270274%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABLUlEQVQY042QvS9DUQDF3+xPMRlYmoqwqkjMSCTSQTSRIl1MYsFSYmosIlZVHzEYRMWEqI9KOvh4eREE1bzbvvvebe/7yaswCI2TnPH8cs4xTgol+mfzvAoPa26Gh6lJ7OwG6n4ZrUr4gO9rfN//1YFcqZCORGuNkb0s0ho7ZXHP43A4xm1HG+ZICJEx0CL/L2DVE1QqAqUUxv7ZM6F4jt4FyfbAGFakEyvRTXmnCe0+fQJ1tSFQuh62beO6Lkb2/IXweI7BlGR3KI4V6cJKROpA72YeXTEbtqxP9hRClHEcB+Pg4o3m6DE9SUmmL4oZbsEcbUesG4gtA2Wt1EO+Vn+2DBz8V//w7tEhmbZYPVJcr6UpppYobqaQVxO4hWnUe46aHwBr36Gf/moa6AM/16rXKL+SMAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Allocated Memory Per Single Call without Option[Version], bytes"
        title="Allocated Memory Per Single Call without Option[Version], bytes"
        src="/static/6b4183a82cc444597a94b80a7912f881/50383/memory-no-alloc.png"
        srcset="/static/6b4183a82cc444597a94b80a7912f881/1d79a/memory-no-alloc.png 185w,
/static/6b4183a82cc444597a94b80a7912f881/1efb2/memory-no-alloc.png 370w,
/static/6b4183a82cc444597a94b80a7912f881/50383/memory-no-alloc.png 740w,
/static/6b4183a82cc444597a94b80a7912f881/73caa/memory-no-alloc.png 1110w,
/static/6b4183a82cc444597a94b80a7912f881/536c7/memory-no-alloc.png 1480w,
/static/6b4183a82cc444597a94b80a7912f881/53f1b/memory-no-alloc.png 2453w"
        sizes="(max-width: 740px) 100vw, 740px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>Yes, now we see that after <a href="#step-5-searching-for-dots-use-indexof">Step 5</a> we managed to remove allocations completely! And what’s about performance without any allocations?</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Benchmark                       (encoded)  Mode  Cnt     Score     Error  Units

yolo                    10000.10000.10000  avgt    5   218.728 ±   2.026  ns/op
yolo NO ALLOC           10000.10000.10000  avgt    5   211.766 ±  19.489  ns/op

optimized1              10000.10000.10000  avgt    5   156.005 ±   5.058  ns/op
optimized1 NO ALLOC     10000.10000.10000  avgt    5   146.182 ±   0.199  ns/op

optimized6              10000.10000.10000  avgt    5    57.729 ±   1.709  ns/op
optimized6 NO ALLOC     10000.10000.10000  avgt    5    46.327 ±   0.065  ns/op</code></pre></div>
<p>As expected, it improved performance even more. By the way, it’s as significant for the short string:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Benchmark                       (encoded)  Mode  Cnt     Score     Error  Units

yolo                                1.0.0  avgt    5   163.856 ±  12.370  ns/op
yolo NO ALLOC                       1.0.0  avgt    5   164.106 ±  17.569  ns/op

optimized1                          1.0.0  avgt    5   100.512 ±   4.974  ns/op
optimized1 NO ALLOC                 1.0.0  avgt    5    91.981 ±   3.188  ns/op

optimized6                          1.0.0  avgt    5    22.198 ±   0.051  ns/op
optimized6 NO ALLOC                 1.0.0  avgt    5    20.232 ±   0.054  ns/op</code></pre></div>
<h3 id="valhalla-ftw" style="position:relative;"><a href="#valhalla-ftw" aria-label="valhalla ftw permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Valhalla FTW!</h3>
<p>Project <a href="https://jdk.java.net/valhalla/">Valhalla</a> is going to help us greatly with this zero-allocation solution as it will enable to not pay for allocations for such simple data structures, but also it will make it convenient to use. With the current approach we return <code class="language-text">long</code>, and it’s not really clear for a code reader to understand what this long actually means.</p>
<p>With value-classes it will be possible to define version like this:</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java">value <span class="token keyword">class</span> <span class="token class-name">Version</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> value<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Version</span> INVALID <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Version</span><span class="token punctuation">(</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> <span class="token number">14</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token class-name">Version</span><span class="token punctuation">(</span><span class="token keyword">long</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">Version</span><span class="token punctuation">(</span><span class="token keyword">int</span> major<span class="token punctuation">,</span> <span class="token keyword">int</span> minor<span class="token punctuation">,</span> <span class="token keyword">int</span> fix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token function">asValue</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> minor<span class="token punctuation">,</span> fix<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Version</span> <span class="token function">fromString</span><span class="token punctuation">(</span><span class="token class-name">String</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// our implementation</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isInvalid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> value <span class="token operator">==</span> INVALID<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">major</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>value <span class="token operator">>></span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">16383</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">minor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>value <span class="token operator">>></span> <span class="token number">14</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">16383</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">fix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;</span> <span class="token number">16383</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">asValue</span><span class="token punctuation">(</span><span class="token keyword">int</span> major<span class="token punctuation">,</span> <span class="token keyword">int</span> minor<span class="token punctuation">,</span> <span class="token keyword">int</span> fix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>major <span class="token operator">&amp;</span> <span class="token number">16383</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">|</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>minor <span class="token operator">&amp;</span> <span class="token number">16383</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">14</span><span class="token punctuation">)</span> <span class="token operator">|</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>fix <span class="token operator">&amp;</span> <span class="token number">16383</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>  
<span class="token punctuation">}</span></code></pre></div>
<p>Effectively it will be 8 bytes in memory, not in heap, passing by value, as effective as <code class="language-text">long</code>, but with the convenience of the normal class. We just need to patiently wait for Valhalla :)</p>
<h2 id="final-thoughts" style="position:relative;"><a href="#final-thoughts" aria-label="final thoughts permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Final Thoughts</h2>
<p>Clearly, the initial code is concise and simple. And sometimes we pay for the simplicity and the ease of maintenance. Do we even need to optimize it? If it works — no need to touch it. In my case, my attention was brought to this code because of the exceptions. By chance I profiled service with <a href="https://github.com/async-profiler/async-profiler">async-profiler</a> and at that point of time we received significant amount of requests with invalid versions, so exceptions thrown by this validation were visible in hot spots.</p>
<p>It’s still may not be a reason for optimizations. If we are just concerned with exceptions, we may as well use <a href="#step-4-regex">Regex</a> implementation. It’s not as robust on happy flow, but still good enough. And it has more or less the same readability.</p>
<p>My internal perfectionist screams: “What’s about efficiency?!” But it’s always a trade off between maintenance cost and actual production impact of code changes. <a href="#step-6-replace-substring">Step 6</a> actually may be a good compromise between readability and performance, as <code class="language-text">indexOf</code> solution is not that complicated and still provides visible performance benefit (no garbage also!)</p>
<h2 id="conclusion" style="position:relative;"><a href="#conclusion" aria-label="conclusion permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conclusion</h2>
<p>I had a lot of fun conducting this benchmark and doing all these optimizations step by step. I hope you enjoyed it as well. To sum up optimization efforts:</p>
<ul>
<li>As always, <a href="http://wiki.jvmlangsummit.com/images/1/1d/PerformanceAnxiety2010.pdf">beware</a> of premature optimizations!</li>
<li>Use as less exceptions as possible. If you need to use exceptions, consider using <a href="https://stackoverflow.com/questions/11434431/exception-without-stack-trace-in-java">stack-traceless</a> ones.</li>
<li>Reduce number of intermediate allocations to minimum. It will not only improve performance of the task, but will reduce pressure on Garbage Collector, which is a good thing for the application in general.</li>
<li>CPU cycles do matter. Iterating over a string has its price. More iterations you do, more you pay.</li>
<li>Consider maintenance cost of the optimization. It could be detrimental in a long run.</li>
</ul>
<p>But more than anything, optimization and benchmarking are always a fun exercise — have fun! ;-)</p>
<p>Play with charts <a href="/charts/version-parsing">here</a>. Source code is on <a href="https://github.com/dkomanov/stuff/commit/85e5845688922ecce4ccc88818c9e283174f8705">GitHub</a>. Originally posted on <a href="https://dkomanov.medium.com/optimizing-performance-of-simple-version-parsing-in-scala-aeff8bc133a5">Medium</a>. <a href="https://pixabay.com/illustrations/matrix-code-computer-pc-data-356024/">Cover image</a> by <a href="https://pixabay.com/users/51581-51581/">51581</a> from <a href="https://pixabay.com/">Pixabay</a> + <a href="https://excalidraw.com/">Excalidraw</a>.</p></div></div><div class="blog-post-meta"><ul class="tags"><li class="cf"><a href="/posts/scala">scala</a></li><li class="cf"><a href="/posts/java">java</a></li><li class="cf"><a href="/posts/string">string</a></li><li class="cf"><a href="/posts/benchmark">benchmark</a></li><li class="cf"><a href="/posts/performance">performance</a></li><li class="cf"><a href="/posts/optimization">optimization</a></li></ul><hr/><div class="share-buttons"><button aria-label="twitter" class="react-share__ShareButton share-button" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="24" height="24"><rect width="64" height="64" rx="0" ry="0" fill="#00aced"></rect><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></svg></button><button aria-label="facebook" class="react-share__ShareButton share-button" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="24" height="24"><rect width="64" height="64" rx="0" ry="0" fill="#3b5998"></rect><path d="M34.1,47V33.3h4.6l0.7-5.3h-5.3v-3.4c0-1.5,0.4-2.6,2.6-2.6l2.8,0v-4.8c-0.5-0.1-2.2-0.2-4.1-0.2 c-4.1,0-6.9,2.5-6.9,7V28H24v5.3h4.6V47H34.1z" fill="white"></path></svg></button></div></div></div><footer>All content ©<!-- --> <a href="mailto:dkomanov@gmail.com">Dmitry Komanov</a>,<!-- --> <a href="/powered">powered by...</a></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/p/optimizing-performance-of-simple-version-parsing-in-scala/";window.___webpackCompilationHash="7057ea941c452b74eaec";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-f1d5be50dbe1d5fc9ecc.js"],"app":["/app-e1983581a6531d6e363a.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-99a953a5d5072d737c00.js"],"component---src-pages-404-js":["/component---src-pages-404-js-411ef4eaab63e67f917d.js"],"component---src-pages-charts-base-64-jdk-vs-apache-commons-index-tsx":["/component---src-pages-charts-base-64-jdk-vs-apache-commons-index-tsx-d14165dc07e0e483d4fb.js"],"component---src-pages-charts-base-64-jni-index-tsx":["/component---src-pages-charts-base-64-jni-index-tsx-4f66c9bc6220d72f885d.js"],"component---src-pages-charts-java-compression-compression-ratio-tsx":["/component---src-pages-charts-java-compression-compression-ratio-tsx-8110b1e4b7c477551750.js"],"component---src-pages-charts-java-compression-index-tsx":["/component---src-pages-charts-java-compression-index-tsx-e2fcb3cad10b7bb622d2.js"],"component---src-pages-charts-java-compression-real-data-tsx":["/component---src-pages-charts-java-compression-real-data-tsx-43ab02b3357201d9b0f9.js"],"component---src-pages-charts-mysql-blob-fetch-index-tsx":["/component---src-pages-charts-mysql-blob-fetch-index-tsx-479eabb8b57bfe4a76bf.js"],"component---src-pages-charts-mysql-streaming-index-js":["/component---src-pages-charts-mysql-streaming-index-js-780495a06cbe1ac6221b.js"],"component---src-pages-charts-native-access-index-tsx":["/component---src-pages-charts-native-access-index-tsx-5c6f958f17ce5c93a235.js"],"component---src-pages-charts-offheap-array-index-tsx":["/component---src-pages-charts-offheap-array-index-tsx-024d498f8961da81b4fb.js"],"component---src-pages-charts-offheap-hashmap-index-tsx":["/component---src-pages-charts-offheap-hashmap-index-tsx-d75446a4db74c1da573a.js"],"component---src-pages-charts-read-lines-index-js":["/component---src-pages-charts-read-lines-index-js-bb3f7db27e294632f1a2.js"],"component---src-pages-charts-read-utf-8-index-js":["/component---src-pages-charts-read-utf-8-index-js-f4d60054c81944568be5.js"],"component---src-pages-charts-region-matches-index-tsx":["/component---src-pages-charts-region-matches-index-tsx-1812b45dfa8604201183.js"],"component---src-pages-charts-scala-serialization-2022-index-tsx":["/component---src-pages-charts-scala-serialization-2022-index-tsx-d9ec2e1b0fde2462ad45.js"],"component---src-pages-charts-scala-serialization-index-js":["/component---src-pages-charts-scala-serialization-index-js-225ab2b6f43837a81a74.js"],"component---src-pages-charts-scala-string-format-index-js":["/component---src-pages-charts-scala-string-format-index-js-989dfb4a2933d53485aa.js"],"component---src-pages-charts-set-map-java-vs-scala-index-tsx":["/component---src-pages-charts-set-map-java-vs-scala-index-tsx-98d55b19945e17cd1869.js"],"component---src-pages-charts-version-parsing-index-tsx":["/component---src-pages-charts-version-parsing-index-tsx-d56e7c10681051a6027a.js"],"component---src-pages-index-js":["/component---src-pages-index-js-8d5dc7a04410f1a5e964.js"],"component---src-templates-blog-by-tag-js":["/component---src-templates-blog-by-tag-js-644d70da62520e655eb3.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-3a7f1226ca2d533bf8f2.js"],"component---src-templates-static-js":["/component---src-templates-static-js-b0b89dc82e3360603931.js"],"component---src-templates-what-i-listen-list-tsx":["/component---src-templates-what-i-listen-list-tsx-774af08d23b2797f8ff4.js"],"component---src-templates-what-i-listen-single-episode-tsx":["/component---src-templates-what-i-listen-single-episode-tsx-7691f95dc109a423643e.js"],"component---src-templates-what-i-listen-tag-cloud-tsx":["/component---src-templates-what-i-listen-tag-cloud-tsx-58bf894680d9448a1385.js"],"component---src-templates-what-i-read-index-js":["/component---src-templates-what-i-read-index-js-d4124ab8f3404c08f33d.js"]};/*]]>*/</script><script src="/polyfill-f1d5be50dbe1d5fc9ecc.js" nomodule=""></script><script src="/app-e1983581a6531d6e363a.js" async=""></script><script src="/framework-bf670a827ae315f850d0.js" async=""></script><script src="/webpack-runtime-68b2d55c5e9bd8b7e798.js" async=""></script></body></html>