{"componentChunkName":"component---src-templates-blog-post-js","path":"/p/scala-string-interpolation-performance/","result":{"data":{"markdownRemark":{"id":"e6ea8881-0c5d-56cd-a53c-d33d517db5e1","excerpt":"Performance comparison between different kinds of string concatenation/formatting in Java/Scala String concatenation is a basic building block in every modern…","html":"<blockquote>\n<p>Performance comparison between different kinds of string concatenation/formatting in Java/Scala</p>\n</blockquote>\n<p>String concatenation is a basic building block in every modern programming\nlanguage. Many different projects, especially in Web, produce a lot of strings.\nAnd it’s interesting, how this problem is solved in different languages.\nIn our case, in Java and Scala (because it’s much easier to compare, and\nthese I use day-to-day).</p>\n<p>There are a <a href=\"https://www.google.com/?q=java+string+concatenation+performance\">lot</a> of <a href=\"https://www.google.com/?q=scala+string+interpolation+performance\">posts</a>\non Internet about this topic. But still, there are something interesting to say\nabout it (I hope you won’t be bored). Yes, this is about performance and microbenchmarking,\nI <a href=\"http://wiki.jvmlangsummit.com/images/1/1d/PerformanceAnxiety2010.pdf\">know</a>.</p>\n<p>Basically, this post is about how to make robust string concatenation\n(with macros!) and performance comparison. You may skip this big part right to\nGraphs and Conclusion.</p>\n<h2 id=\"what-is-string-concatenation\" style=\"position:relative;\"><a href=\"#what-is-string-concatenation\" aria-label=\"what is string concatenation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What is string concatenation?</h2>\n<p>In JVM <a href=\"http://docs.oracle.com/javase/8/docs/api/java/lang/String.html\">String</a> object is immutable. If you need to\ncreate a new String with a content of two other strings, you need to create\na third one. In Java you may concatenate not only string but any\nobjects — Java compiler will convert an object to its string representation\nautomatically. Scala compiler also does it.</p>\n<p>What will compiler do, when we write such code in Java:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">int</span> a <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">String</span> b <span class=\"token operator\">=</span> <span class=\"token string\">\"s\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">String</span> str <span class=\"token operator\">=</span> a <span class=\"token operator\">+</span> b<span class=\"token punctuation\">;</span></code></pre></div>\n<p>This code will be converted to this code:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">int</span> a <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">String</span> b <span class=\"token operator\">=</span> <span class=\"token string\">\"s\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">String</span> str <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StringBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Nothing new, it’s well-known thing. But, it’s important to understand,\nwhat is happening there:</p>\n<ol>\n<li>new StringBuilder creates a class with a char array of 16 elements.</li>\n<li>append method converts an argument to chars and stores into an internal array.</li>\n</ol>\n<p>If an array is not big enough, it will create a bigger array.\n3. toString creates a String object, but char array is not shared between\nStringBuilder and this new String object (because it’s mutable in StringBuilder).</p>\n<p>So, in order to concatenate 2 objects, we need to create an intermediate object,\nbig enough to store the string representation of our 2 objects.</p>\n<h2 id=\"how-to-improve-default-concatenation\" style=\"position:relative;\"><a href=\"#how-to-improve-default-concatenation\" aria-label=\"how to improve default concatenation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How to improve default concatenation</h2>\n<p>We have 2 heavy operations from the list above: allocation of a buffer in\nStringBuilder (and reallocations!) and a creation of String\n(making copy of StringBuilder’s buffer).</p>\n<p>Let’s put some efforts to deal with it. Because I had a lot of experience\nin .NET, I know, how string concatenation is implemented there.</p>\n<h3 id=\"whats-about-cnet\" style=\"position:relative;\"><a href=\"#whats-about-cnet\" aria-label=\"whats about cnet permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What’s about C#.NET?</h3>\n<p>In C# the same problem solved in a slightly different way. Actually, many\nproblems in .NET solved slightly differently.</p>\n<p>This concatenation will be converted by the <a href=\"https://ericlippert.com/2013/06/17/string-concatenation-behind-the-scenes-part-one/\">compiler</a>\nto call to static method Concat (yes, in .NET they use CamelCase instead of\ncamelCase in Java, yet another little difference):</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\">String</span> str <span class=\"token operator\">=</span> String<span class=\"token punctuation\">.</span><span class=\"token function\">Concat</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>And inside Concat we may see, how it <a href=\"https://referencesource.microsoft.com/#mscorlib/system/string.cs,3133\">works</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\">String</span> <span class=\"token function\">Concat</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> str0<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> str1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IsNullOrEmpty</span><span class=\"token punctuation\">(</span>str0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IsNullOrEmpty</span><span class=\"token punctuation\">(</span>str1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> String<span class=\"token punctuation\">.</span>Empty<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> str1<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IsNullOrEmpty</span><span class=\"token punctuation\">(</span>str1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> str0<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> str0Length <span class=\"token operator\">=</span> str0<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">String</span> result <span class=\"token operator\">=</span> <span class=\"token function\">FastAllocateString</span><span class=\"token punctuation\">(</span>str0<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">+</span> str1<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">FillStringChecked</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>        str0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">FillStringChecked</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">,</span> str0Length<span class=\"token punctuation\">,</span> str1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>What is interesting here is resulting string length precomputation. They create\na char buffer of resulting size, fill it and use in String object without copying. Obviously, this should work much faster (and it’s).</p>\n<p>Let’s try to do something similar in Scala.</p>\n<h3 id=\"optimized-string-concatenation\" style=\"position:relative;\"><a href=\"#optimized-string-concatenation\" aria-label=\"optimized string concatenation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Optimized string concatenation</h3>\n<p>So, what do we need is precompute a StringBuilder length to avoid any reallocations.</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">def</span> concat<span class=\"token punctuation\">(</span>o1<span class=\"token operator\">:</span> Object<span class=\"token punctuation\">,</span> o2<span class=\"token operator\">:</span> Object<span class=\"token punctuation\">,</span> o3<span class=\"token operator\">:</span> Object<span class=\"token punctuation\">,</span>\n           o4<span class=\"token operator\">:</span> Object<span class=\"token punctuation\">,</span> o5<span class=\"token operator\">:</span> Object<span class=\"token punctuation\">,</span> o6<span class=\"token operator\">:</span> Object<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">String</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  concatNonNull<span class=\"token punctuation\">(</span>orNull<span class=\"token punctuation\">(</span>o1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> orNull<span class=\"token punctuation\">(</span>o2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> orNull<span class=\"token punctuation\">(</span>o3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                orNull<span class=\"token punctuation\">(</span>o4<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> orNull<span class=\"token punctuation\">(</span>o5<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> orNull<span class=\"token punctuation\">(</span>o6<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">def</span> orNull<span class=\"token punctuation\">(</span>o<span class=\"token operator\">:</span> Object<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">String</span> <span class=\"token operator\">=</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>o <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"null\"</span> <span class=\"token keyword\">else</span> o<span class=\"token punctuation\">.</span>toString\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">def</span> concatNonNull<span class=\"token punctuation\">(</span>s1<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">,</span> s2<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">,</span>\n                          s3<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">,</span> s4<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">,</span>\n                          s5<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">,</span> s6<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">String</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">new</span> StringBuilder<span class=\"token punctuation\">(</span>s1<span class=\"token punctuation\">.</span>length <span class=\"token operator\">+</span> s2<span class=\"token punctuation\">.</span>length <span class=\"token operator\">+</span> s3<span class=\"token punctuation\">.</span>length <span class=\"token operator\">+</span> s4<span class=\"token punctuation\">.</span>length <span class=\"token operator\">+</span> s5<span class=\"token punctuation\">.</span>length <span class=\"token operator\">+</span> s6<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>s1<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>s2<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>s3<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>s4<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>s5<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>s6<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span>toString\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This is a version for 6 arguments (we may generate as many as we want).\nPrecalculation of a StringBuilder buffer size should give us some performance\nboost (we will see it later).</p>\n<h3 id=\"fast-stringbuildertostring\" style=\"position:relative;\"><a href=\"#fast-stringbuildertostring\" aria-label=\"fast stringbuildertostring permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Fast StringBuilder.toString</h3>\n<p>Let’s take a look at StringBuilder.toString <a href=\"http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/8u40-b25/java/lang/StringBuilder.java?av=f#404\">implementation</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Create a copy, don't share the array</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And in String’s constructor <a href=\"http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/8u40-b25/java/lang/String.java#190\">we see</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> value<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> offset<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> count<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ... validations omitted</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> <span class=\"token class-name\">Arrays</span><span class=\"token punctuation\">.</span><span class=\"token function\">copyOfRange</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">,</span> offset<span class=\"token punctuation\">,</span> offset<span class=\"token operator\">+</span>count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Aha! Arrays.copyOfRange creates a new char[] and copy data there. We know for sure,\nthat char array will be filled up and we can use it directly\n(we’re good ppl, we won’t modify it after string creation). In String class,\nthere is a <a href=\"http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/8u40-b25/java/lang/String.java#597\">constructor</a>,\nthat don’t do copy, but… it’s package-private. Meaning, we can’t use it. Or can we?</p>\n<p>We may try to use <a href=\"http://stackoverflow.com/questions/22244402/how-can-i-improve-performance-of-field-set-perhap-using-methodhandles\">fast reflection</a> (MethodHandle)\nto access to private constructor! Looks <a href=\"https://github.com/dkomanov/scala-string-format/blob/master/scala-string-format/src/main/scala/com/komanov/stringformat/FastStringFactory.java\">pretty easy</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> <span class=\"token function\">fastNewString</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> chars<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Throwable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Constructor</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> constructor <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">getDeclaredConstructor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    constructor<span class=\"token punctuation\">.</span><span class=\"token function\">setAccessible</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// it should be cached</span>\n    <span class=\"token class-name\">MethodHandle</span> newString <span class=\"token operator\">=</span> <span class=\"token class-name\">MethodHandles</span><span class=\"token punctuation\">.</span><span class=\"token function\">lookup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">unreflectConstructor</span><span class=\"token punctuation\">(</span>constructor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> newString<span class=\"token punctuation\">.</span><span class=\"token function\">invokeExact</span><span class=\"token punctuation\">(</span>chars<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Spoiler: it doesn’t work! Details below.</p>\n<h3 id=\"thats-it\" style=\"position:relative;\"><a href=\"#thats-it\" aria-label=\"thats it permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>That’s it?</h3>\n<p>So, that’s it, no more optimizations? Of course not! What else to we do\nin concatenation? The toString method calls for each argument. This also could\nbe optimized. How?</p>\n<p>Imagine, you pass an integer there, which is primitive. In order to pass it,\nyou need to <a href=\"https://docs.oracle.com/javase/tutorial/java/data/autoboxing.html\">box it</a> and then we call Integer.toString\nmethod. What’s wrong with toString? It allocates new memory. StringBuilder has\nan optimization for appending primitive values, it calculates how many chars\nneeded to print an integer (in order to reallocate internal buffer, if necessary)\nand then uses internal method Integer.getChars, passing internal char array there.\nSo, there are no additional allocations for printing integer.</p>\n<p>Having such generic method, we can’t utilize StringBuilder power to not do\nunnecessary allocations. But, we’re in Scala world, we may use\n<a href=\"http://docs.scala-lang.org/overviews/macros/overview.html\">macroses</a>! The very good explanation is in\n<a href=\"http://stackoverflow.com/questions/15329027/string-interpolation-and-macro-how-to-get-the-stringcontext-and-expression-loca\">this StackOverflow topic</a>.</p>\n<h2 id=\"scala-string-interpolation\" style=\"position:relative;\"><a href=\"#scala-string-interpolation\" aria-label=\"scala string interpolation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scala String Interpolation</h2>\n<p>But before I move to macros implementation of string concatenation, let’s take\na look at Scala’s way of string formatting which is called\n<a href=\"http://docs.scala-lang.org/overviews/core/string-interpolation.html\">String Interpolation</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">val</span> value1 <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">val</span> value2 <span class=\"token operator\">=</span> <span class=\"token string\">\"abc\"</span>\n<span class=\"token string-interpolation\"><span class=\"token id function\">s</span><span class=\"token string\">\"start</span><span class=\"token interpolation\"><span class=\"token punctuation\">${</span><span class=\"token expression\">value1</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">middle</span><span class=\"token interpolation\"><span class=\"token punctuation\">${</span><span class=\"token expression\">value2</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">end\"</span></span></code></pre></div>\n<p>This is an equivalent of Java of Scala simple string concatenation, but looks\nmuch better:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token string\">\"start\"</span> <span class=\"token operator\">+</span> value1 <span class=\"token operator\">+</span> <span class=\"token string\">\"middle\"</span> <span class=\"token operator\">+</span> value2 <span class=\"token operator\">+</span> <span class=\"token string\">\"end\"</span></code></pre></div>\n<p>Scala compiler transforms such interpolation to this code:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">new</span> StringContext<span class=\"token punctuation\">(</span><span class=\"token string\">\"start\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"middle\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"end\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>s<span class=\"token punctuation\">(</span>value1<span class=\"token punctuation\">,</span> value2<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Oh no. Again, more allocations? Yes. At least 2: one for an array of string\nconstants and another for an array of arguments. And also, inside method s,\nthere is a processing of string constants (yes, on each call). Doesn’t look as\nhighly optimal.</p>\n<h3 id=\"macros-to-rule-them-all\" style=\"position:relative;\"><a href=\"#macros-to-rule-them-all\" aria-label=\"macros to rule them all permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Macros to rule them all</h3>\n<p>We may create a macros, that will generate another code for string interpolation.\nWe still can use this neat syntax, but do whatever we want to concatenate these\nstring constants and arguments.</p>\n<p>For example, we can precalculate length of StringBuilder, and then append\narguments there and be sure, that there won’t be any other allocation.</p>\n<p>The <a href=\"https://github.com/dkomanov/scala-string-format/blob/master/scala-string-format/src/main/scala/com/komanov/stringformat/macros/MacroConcat.scala\">code of macros</a> is relatively small\n(around 100 lines), but it’s hard to demonstrate it well. I will explain what\nit does. This code:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">def</span> value1<span class=\"token operator\">:</span> <span class=\"token builtin\">Int</span>\n<span class=\"token keyword\">def</span> value2<span class=\"token operator\">:</span> Object\n<span class=\"token string-interpolation\"><span class=\"token id function\">sfi</span><span class=\"token string\">\"a</span><span class=\"token interpolation\"><span class=\"token punctuation\">${</span><span class=\"token expression\">value1</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">b</span><span class=\"token interpolation\"><span class=\"token punctuation\">${</span><span class=\"token expression\">value2</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">c\"</span></span></code></pre></div>\n<p>Will be transformed to this code:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">val</span> local_2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">val</span> tmp <span class=\"token operator\">=</span> value2\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tmp eq <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"null\"</span> <span class=\"token keyword\">else</span> tmp<span class=\"token punctuation\">.</span>toString\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">new</span> java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>StringBuilder<span class=\"token punctuation\">(</span><span class=\"token number\">12</span> <span class=\"token operator\">+</span> local_2<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>value1<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"b\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>local_2<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"c\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span>toString</code></pre></div>\n<p>Important parts of generated code:</p>\n<ol>\n<li>sfi stands for “super fast interpolation” :)</li>\n<li>Precalculated length constant — 12 — consists of 3 characters for strings</li>\n</ol>\n<p>“a”, “b” and “c” and 9 characters allocated for int (value1). It may be not\nenough (for bigger int), but this is a simplification for now.\n3. We don’t box integer and don’t call toString, but using append method\noverload for int. It should be faster.</p>\n<p>Obviously, macros could be much richer — we can calculate exactly length of\ninteger (and all primitive values) to not over/under allocate buffer. We may\ndetermine whether it’s safe to not create local variables (if it’s already local\nvariable or field) to reduce bytecode size.</p>\n<p>But, for testing purposes, I think it’s good enough.</p>\n<h3 id=\"lets-microbenchmark-it\" style=\"position:relative;\"><a href=\"#lets-microbenchmark-it\" aria-label=\"lets microbenchmark it permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Let’s microbenchmark it!</h3>\n<p>Basically, I will test this case:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> <span class=\"token function\">concat</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> value1<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> value2<span class=\"token punctuation\">,</span>\n        <span class=\"token class-name\">Object</span> nullObject<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> value1 <span class=\"token operator\">+</span> <span class=\"token string\">\"a\"</span> <span class=\"token operator\">+</span> value2 <span class=\"token operator\">+</span> <span class=\"token string\">\"b\"</span> <span class=\"token operator\">+</span> value2 <span class=\"token operator\">+</span> nullObject<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>With various input arguments, resulting string will be of 7, 17, 29, 75, 212,\n1004 and 1006 characters long, which should cover a lot of use cases.</p>\n<h4 id=\"what-to-test\" style=\"position:relative;\"><a href=\"#what-to-test\" aria-label=\"what to test permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What to test</h4>\n<p>Besides various input arguments there will be benchmarks for different kinds\nof concatenation/formatting (all listed in this <a href=\"https://github.com/dkomanov/scala-string-format/blob/master/scala-string-format-core/src/test/scala/com/komanov/stringformat/FormatsTest.scala\">test</a>):</p>\n<ul>\n<li>Java concatenation, as in code fragment above;</li>\n<li><a href=\"http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/8u40-b25/java/lang/String.java#2927\">String.format</a> method;</li>\n<li>java.text.<a href=\"http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/8u40-b25/java/text/MessageFormat.java#MessageFormat\">MessageFormat</a>;</li>\n<li><a href=\"http://www.slf4j.org/\">slf4j</a> message formatter (just because it’s a popular logging framework);</li>\n<li>Scala concatenation;</li>\n<li><a href=\"http://docs.scala-lang.org/overviews/core/string-interpolation.html#the-s-string-interpolator\">s</a> string interpolator;</li>\n<li><a href=\"http://docs.scala-lang.org/overviews/core/string-interpolation.html#the-f-interpolator\">f</a> string interpolator;</li>\n<li><a href=\"http://docs.scala-lang.org/overviews/core/string-interpolation.html#the-raw-interpolator\">raw</a> string interpolator;</li>\n<li>optimized concatenation 1 (with length precalculated);</li>\n<li>optimized concatenation 2 (without copying of char array);</li>\n<li>optimized concatenation via string interpolation + macros (soInterpolator);</li>\n<li>super fast interpolation via macros (sfiInterpolator).</li>\n</ul>\n<h4 id=\"charts-and-tables\" style=\"position:relative;\"><a href=\"#charts-and-tables\" aria-label=\"charts and tables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Charts and tables</h4>\n<p>As you can see, optimized concatenation works better on strings longer than\n16 characters. String interpolations, based on macros (so and sfi), are the best.\nScala’s interpolations (s, f and raw) are slow, its performance lower than\nregular string concatenation and approximately the same as slf4j.</p>\n<p>The more convenient chart is <a href=\"/charts/scala-string-format/\">here</a>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/75a9537d7b91d7c82b94a830cabe5c0e/78958/string-formatting.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.4054054054054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAABaUlEQVQoz5WRz3LTMBDG/b68BsMD9BU4cIVTbx3KtGUYSA80TVTZ1HYbmjhxYksrxZa0qwUZpnDgwnfaP99vvtnZDACGYeD/UZzEzBkRPff/FnM0hkKI3lPfM7O3FgASjIh/TM/F3yHMUUqnFBmDQniKbtcqpYgowxCSgyg6l3zDQIjROdIaQ6CmCcwxz8dekbUopY/koT0cunEcM1ytfNumhRB+8qWQrgtF4Z3D+dzFGIsigKajpbzwHAH21toJrirXNAleLBwzSzkqhX0fim8JXi7TUCzk19x1enNx9X0/WON+3xyqCtsdHY8kBE5wMEBKxboO3tOdDMz86eL9uw/mqV2+frN8gNHqvp9uprpq83unwcxma0AW8/qupEP3eH6ptNXnZzf3W748fXvyclftv7x6cTW7ZWbEFJSxhe1DPQ5OV3J7gLBbr6qShrG8/qzA2lI8rtbUbsrbmVF2c/Pxad38+sJP+AfVYf2I98eY4AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Different kind of string formatting performance, divided by resulting string length, nanos|wide\"\n        title=\"Different kind of string formatting performance, divided by resulting string length, nanos|wide\"\n        src=\"/static/75a9537d7b91d7c82b94a830cabe5c0e/50383/string-formatting.png\"\n        srcset=\"/static/75a9537d7b91d7c82b94a830cabe5c0e/1d79a/string-formatting.png 185w,\n/static/75a9537d7b91d7c82b94a830cabe5c0e/1efb2/string-formatting.png 370w,\n/static/75a9537d7b91d7c82b94a830cabe5c0e/50383/string-formatting.png 740w,\n/static/75a9537d7b91d7c82b94a830cabe5c0e/73caa/string-formatting.png 1110w,\n/static/75a9537d7b91d7c82b94a830cabe5c0e/78958/string-formatting.png 1320w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Data table for a resulting string length 212:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark                                Score     Error  Units\njavaConcat                             165.320 ±   0.578  ns/op\nstringFormat                          1364.206 ±  19.899  ns/op\nmessageFormat                         1370.831 ±  11.360  ns/op\nscalaConcat                            169.005 ±   1.481  ns/op\nconcatOptimized1                        94.336 ±   1.419  ns/op\nconcatOptimized2                       131.683 ±   4.288  ns/op\nconcatOptimizedMacros                   68.702 ±   3.256  ns/op\nslf4j                                  275.377 ±  10.165  ns/op\nsInterpolator                          268.072 ±  12.385  ns/op\nfInterpolator                         1375.487 ±  10.255  ns/op\nrawInterpolator                        271.416 ±   1.797  ns/op\nsfiInterpolator                         58.674 ±   0.562  ns/op</code></pre></div>\n<h2 id=\"curious-facts\" style=\"position:relative;\"><a href=\"#curious-facts\" aria-label=\"curious facts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Curious facts</h2>\n<h3 id=\"s-interpolator-is-slow\" style=\"position:relative;\"><a href=\"#s-interpolator-is-slow\" aria-label=\"s interpolator is slow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>s interpolator is slow</h3>\n<p>For me it was unexpected. I thought, such generic thing should work as fast as\npossible, but…</p>\n<p>Now, after my research, I understand, why it works so poorly. But I don’t\nunderstand, why it wasn’t implemented on compiler level, or at least with macros.</p>\n<p>Additionally, I’ve performed couple more tests:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">class</span> EmptyStringBenchmark <span class=\"token keyword\">extends</span> BenchmarkBase <span class=\"token punctuation\">{</span>\n  <span class=\"token annotation punctuation\">@Benchmark</span>\n  <span class=\"token keyword\">def</span> baseline<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"\"</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token annotation punctuation\">@Benchmark</span>\n  <span class=\"token keyword\">def</span> sInterpolator<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string-interpolation\"><span class=\"token id function\">s</span><span class=\"token string\">\"\"</span></span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token annotation punctuation\">@Benchmark</span>\n  <span class=\"token keyword\">def</span> sfiInterpolator<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">import</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>komanov<span class=\"token punctuation\">.</span>stringformat<span class=\"token punctuation\">.</span>macros<span class=\"token punctuation\">.</span></span>MacroConcat<span class=\"token punctuation\">.</span>_\n    <span class=\"token string-interpolation\"><span class=\"token id function\">sfi</span><span class=\"token string\">\"\"</span></span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> ConstStringBenchmark <span class=\"token keyword\">extends</span> BenchmarkBase <span class=\"token punctuation\">{</span>\n  <span class=\"token annotation punctuation\">@Benchmark</span>\n  <span class=\"token keyword\">def</span> baseline<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"abc\"</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token annotation punctuation\">@Benchmark</span>\n  <span class=\"token keyword\">def</span> sInterpolator<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string-interpolation\"><span class=\"token id function\">s</span><span class=\"token string\">\"abc\"</span></span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token annotation punctuation\">@Benchmark</span>\n  <span class=\"token keyword\">def</span> sfiInterpolator<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">import</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>komanov<span class=\"token punctuation\">.</span>stringformat<span class=\"token punctuation\">.</span>macros<span class=\"token punctuation\">.</span></span>MacroConcat<span class=\"token punctuation\">.</span>_\n    <span class=\"token string-interpolation\"><span class=\"token id function\">sfi</span><span class=\"token string\">\"abc\"</span></span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And the results:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark                               Score     Error  Units\nEmptyStringBenchmark.baseline           2.899 ±   0.011  ns/op\nEmptyStringBenchmark.sInterpolator     36.181 ±   0.083  ns/op &lt;---\nEmptyStringBenchmark.sfiInterpolator    2.895 ±   0.009  ns/op\nConstStringBenchmark.baseline           2.897 ±   0.008  ns/op\nConstStringBenchmark.sInterpolator     48.307 ±   0.112  ns/op &lt;---\nConstStringBenchmark.sfiInterpolator    2.892 ±   0.006  ns/op</code></pre></div>\n<p>Besides allocations of arrays, sInterpolator also processes constant strings\n(non-arguments) to replace special characters. So, for constant string s“a\\tb”\nit will be even worse.</p>\n<p>Macros do that processing during compilation time.</p>\n<h3 id=\"other-scala-interpolators\" style=\"position:relative;\"><a href=\"#other-scala-interpolators\" aria-label=\"other scala interpolators permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Other Scala interpolators</h3>\n<p>According to documentation, fInterpolator is based on String.format. And its\nperformance actually correlates.</p>\n<p>rawInterpolator don’t do any string processing, that’s why it’s slightly better\nthan sInterpolator.</p>\n<h3 id=\"methodhandle-trick-is-not-working\" style=\"position:relative;\"><a href=\"#methodhandle-trick-is-not-working\" aria-label=\"methodhandle trick is not working permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MethodHandle trick is not working</h3>\n<p>At the beginning, I’ve trusted to StackOverflow <a href=\"http://stackoverflow.com/questions/22244402/how-can-i-improve-performance-of-field-set-perhap-using-methodhandles\">response</a>\nabout the performance of MethodHandle. But the only thing I noticed is a performance\ndegradation between concatOptimized1 and concatOptimized2\n(StringBuilder.toString won over new String(shared_char_array)).</p>\n<p>So, I’ve tested MethodHandle performance by myself, and I got “good” results:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmark     Score     Error  Units\nbaseline      2.907 ±   0.021  ns/op\nfastSb        8.213 ±   0.088  ns/op\nfastString    5.129 ±   0.568  ns/op\nnewString   246.314 ±   3.909  ns/op\nsbToString  253.588 ±   7.551  ns/op</code></pre></div>\n<p><em>fastString</em> is an invocation of private constructor of String and <em>newString</em>\nis an invocation of public constructor of String, that copies input char array.</p>\n<p>But when I tested it on code like:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">val</span> sb <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> StringBuilder<span class=\"token punctuation\">(</span>len1 <span class=\"token operator\">+</span> len2<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span>\nFastStringFactory<span class=\"token punctuation\">.</span>fastNewString<span class=\"token punctuation\">(</span>sb<span class=\"token punctuation\">)</span></code></pre></div>\n<p>I received performance degradation. Apparently, JVM doesn’t optimized it in\nthis case. Sadly.</p>\n<p>But there is a lesson learned: don’t trust in microbenchmarks — verify!</p>\n<h3 id=\"scalas-stringbuilder-is-slower\" style=\"position:relative;\"><a href=\"#scalas-stringbuilder-is-slower\" aria-label=\"scalas stringbuilder is slower permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scala’s StringBuilder is slower</h3>\n<p>I even wrote a [small post]({% link _posts/2016-12-03-scala-stringbuilder-vs-java-stringbuilder-performance.md %})\nabout it. Despite the fact, that it’s a wrapper of java.lang.StringBuilder,\nit’s significantly slower.</p>\n<p>Btw, inside sInterpolator Java’s StringBuilder is used. Apparently, they knew it! :)</p>\n<h3 id=\"they-know-that-javalangstringbuilder-is-better\" style=\"position:relative;\"><a href=\"#they-know-that-javalangstringbuilder-is-better\" aria-label=\"they know that javalangstringbuilder is better permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>“They” know that java.lang.StringBuilder is better</h3>\n<p>Scala concatenation (+ operator) works at the same performance as Java\nconcatenation <a href=\"https://github.com/scala/scala/pull/4737\">since 2.12</a>.</p>\n<p>And also sInterpolator uses java.lang.StringBuilder inside.</p>\n<h3 id=\"better-performance-as-i-expected-for-sfiinterpolator\" style=\"position:relative;\"><a href=\"#better-performance-as-i-expected-for-sfiinterpolator\" aria-label=\"better performance as i expected for sfiinterpolator permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Better performance as I expected for sfiInterpolator</h3>\n<p>Inside sfiInterpolator implementation, I’ve decided to make it simple,\nand I am not calculating the precise length for integer and just\npreallocate 9 characters. And I’ve made a single test with Int.MAX_VALUE,\nwhich requires 10 characters. I expected some significant performance degradation\nsince we need to reallocate buffer from 1004 to 2008 chars (yes, I actually\nverified, that this reallocation happened). But, according to benchmarks,\nthere wasn’t any degradation. Which is really strange.</p>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>Performance optimization is always a fun journey (at least for me): you read\ncode, reason about it, try to write an alternative solution, measure, analyze.\nBut, it’s not fun to realize, that such basic things aren’t optimized as it\ncould be. I don’t know the motivation (maybe just lack of time), but I’m\ndisappointed a bit.</p>\n<p>Anyway, Scala has a powerful tool (macros), and it could be fixed.</p>\n<hr>\n<p>Test configuration:</p>\n<ul>\n<li>Ubuntu 16.04</li>\n<li>Linux Kernel 4.4.0–51-generic</li>\n<li>JDK 1.8.0_91</li>\n<li>Scala Library 2.12</li>\n<li>Hardware is Intel® Core™ i7–5600U CPU @ 2.60GHz × 4 (2 core + 2 HT) with 16 GB RAM</li>\n</ul>\n<p>As always, all code is on <a href=\"https://github.com/dkomanov/scala-string-format\">GitHub</a>. Graphs and tables are <a href=\"/charts/scala-string-format/\">here</a>. Comments, suggestions and blaming are welcome.</p>\n<p>Originally posted on <a href=\"https://medium.com/@dkomanov/scala-string-interpolation-performance-21dc85e83afd\">Medium</a>.</p>","fields":{"slug":"/p/scala-string-interpolation-performance/"},"frontmatter":{"rawDate":"2016-12-05T00:00:00.000Z","date":"December 05, 2016","title":"Scala: String Interpolation Performance","description":"Performance comparison between different kinds of string concatenation/formatting in Java/Scala...","tags":["scala","java","benchmark","performance","csharp"],"canonicalUrl":"https://medium.com/@dkomanov/scala-string-interpolation-performance-21dc85e83afd","cover":null}}},"pageContext":{"slug":"/p/scala-string-interpolation-performance/","previous":{"fields":{"slug":"/p/scala-stringbuilder-vs-java-stringbuilder-performance/"}},"next":{"fields":{"slug":"/p/the-cost-of-streaming-data-from-mysql/"}}}},"staticQueryHashes":["3675711862"]}