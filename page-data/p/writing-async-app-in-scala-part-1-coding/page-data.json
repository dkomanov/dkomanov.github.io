{"componentChunkName":"component---src-templates-blog-post-js","path":"/p/writing-async-app-in-scala-part-1-coding/","result":{"data":{"markdownRemark":{"id":"18c60b5c-ae0c-5927-a787-89361e9c2e7c","excerpt":"Part 1. Coding In this part we will cover the most basic part of async programming in Scala with Futures.  Part 1. Coding.  Part 2. Exception Handling.  Part…","html":"<h1 id=\"part-1-coding\" style=\"position:relative;\"><a href=\"#part-1-coding\" aria-label=\"part 1 coding permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Part 1. Coding</h1>\n<blockquote>\n<p>In this part we will cover the most basic part of async programming in Scala with Futures. <br>\nPart 1. Coding. <br>\n<a href=\"/p/writing-async-app-in-scala-part-2-exception-handling\">Part 2. Exception Handling.</a> <br>\n<a href=\"/p/writing-async-app-in-scala-part-3-threading-model\">Part 3. Threading Model.</a> <br>\nPart 4. Rewriting Existing App. <br>\nPart 5. What’s next?</p>\n</blockquote>\n<p>Today asynchronous programming gets some traction. Some may argue even some hype. However, there are cases when it’s really necessary (or, let’s put it mildly, favorably). In this blog post I’d like to put aside reasons behind writing an application in an async fashion, it’s a separate topic. Here I want to focus on the practical side of this topic - how it looks like, what we have to do in order to make it simpler, and what problems we may encounter. Everything here is based on my personal experience, so I hope it won’t be too academic.</p>\n<p>Another thing, I’m not going to explore different approaches of achieving asynchronicity (actor model, functional approaches, etc.) I’ve chosen approach with <a href=\"https://docs.scala-lang.org/overviews/core/futures.html\">Future model</a> of Scala because of the least additional cost of learning. This concept is easier understandable both for me and for people around me: leap from sync jala (java style on Scala) programming to Futures is just shorter.</p>\n<p>This post is written under the assumption that the reader is familiar with the concept of Future/Promise model and familiar with its implementation in Scala. If not, I would advise to read these articles first: <a href=\"https://alexn.org/blog/2017/01/30/asynchronous-programming-scala.html\">Asynchronous Programming and Scala</a> by <a href=\"https://alexn.org/\">Alexandru Nedelcu</a> and <a href=\"https://danielwestheide.com/blog/the-neophytes-guide-to-scala-part-8-welcome-to-the-future/\">The Neophyte’s Guide to Scala Part 8: Welcome to the Future\n</a> by <a href=\"https://danielwestheide.com/\">Daniel Westheide</a> (entire Neophyte’s Guide is awesome!).</p>\n<p>After such a long disclaimer, I have one more thing to say. A kind of application that I’m having in mind is simple: a backend for DB (not really important which one) with some REST/RPC exposure to the world (or internal world), which may also communicate via the network with other applications. Regular “web” application, without any CPU heavy operations (like image processing or blockchain computations.)</p>\n<h2 id=\"regular-web-application\" style=\"position:relative;\"><a href=\"#regular-web-application\" aria-label=\"regular web application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Regular web application</h2>\n<p>In our synchronous world, the application may look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">def</span> validateRequest<span class=\"token punctuation\">(</span>request<span class=\"token operator\">:</span> Request<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Unit</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  require<span class=\"token punctuation\">(</span>request <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">def</span> regularRpcEndpoint<span class=\"token punctuation\">(</span>request<span class=\"token operator\">:</span> Request<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Response <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  validateRequest<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isPermittedViaRpc<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> PermissionDeniedException<span class=\"token punctuation\">(</span><span class=\"token string\">\"...\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">val</span> fromDb <span class=\"token operator\">=</span> retrieveFromDatabase<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">val</span> payload <span class=\"token operator\">=</span> convertPayloadFromDb<span class=\"token punctuation\">(</span>fromDb<span class=\"token punctuation\">)</span>\n  Response<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>By the end of this series I hope it will be clear, how to rewrite application in asynchronous way and avoid some dangers of async approach.</p>\n<h2 id=\"writing-in-async-fashion\" style=\"position:relative;\"><a href=\"#writing-in-async-fashion\" aria-label=\"writing in async fashion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Writing in async fashion</h2>\n<p>NB: For simplicity let’s not think about <code class=\"language-text\">implicit ec: ExecutionContext</code> argument for Future operations yet. I will cover this topic in next parts.</p>\n<p>A straight-forward rewrite would look like:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">def</span> regularRpcEndpoint<span class=\"token punctuation\">(</span>request<span class=\"token operator\">:</span> Request<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span>Response<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  validateRequest<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span>\n\n  isPermittedViaRpc<span class=\"token punctuation\">.</span>flatMap <span class=\"token punctuation\">{</span> isPermitted <span class=\"token keyword\">=></span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isPermitted<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      Future<span class=\"token punctuation\">.</span>failed<span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> PermissionDeniedException<span class=\"token punctuation\">(</span><span class=\"token string\">\"...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      retrieveFromDatabase<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span>map<span class=\"token punctuation\">(</span>convertPayloadFromDb<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span>map<span class=\"token punctuation\">(</span>Response<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In the following examples, I’ll show how to write a bit prettier…</p>\n<h3 id=\"if-statement-replacement\" style=\"position:relative;\"><a href=\"#if-statement-replacement\" aria-label=\"if statement replacement permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>if-statement replacement</h3>\n<p>Suppose we have old-school future-less code:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">def</span> condition<span class=\"token operator\">:</span> <span class=\"token builtin\">Boolean</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">def</span> action1<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Unit</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">def</span> action2<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Unit</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>condition<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  action1<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  action2<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>How it would look like with futures? Suppose, all methods use some kind of IO inside, so:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">def</span> condition<span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span><span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">def</span> action1<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span><span class=\"token builtin\">Unit</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">def</span> action2<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span><span class=\"token builtin\">Unit</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\ncondition<span class=\"token punctuation\">.</span>flatMap<span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">)</span>\n    action1<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">else</span>\n    action2<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Pretty straight-forward, right?</p>\n<h3 id=\"boolean-operations\" style=\"position:relative;\"><a href=\"#boolean-operations\" aria-label=\"boolean operations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Boolean operations</h3>\n<p>What if there are multiple conditions?</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">def</span> condition1<span class=\"token operator\">:</span> <span class=\"token builtin\">Boolean</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">def</span> condition2<span class=\"token operator\">:</span> <span class=\"token builtin\">Boolean</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">def</span> condition3<span class=\"token operator\">:</span> <span class=\"token builtin\">Boolean</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>condition1 <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>condition2 <span class=\"token operator\">||</span> condition3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>There aren’t much help from scala-library itself here, so let’s extend it a bit:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">implicit</span> <span class=\"token keyword\">class</span> FutureOfBooleanExtensions<span class=\"token punctuation\">(</span><span class=\"token keyword\">val</span> future<span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span><span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">extends</span> <span class=\"token builtin\">AnyVal</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">def</span> <span class=\"token operator\">&amp;&amp;</span><span class=\"token punctuation\">(</span>other<span class=\"token operator\">:</span> <span class=\"token keyword\">=></span> Future<span class=\"token punctuation\">[</span><span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span><span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span>\n    future<span class=\"token punctuation\">.</span>flatMap<span class=\"token punctuation\">(</span>value <span class=\"token keyword\">=></span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>value<span class=\"token punctuation\">)</span> Future<span class=\"token punctuation\">.</span>successful<span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> other<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token operator\">||</span><span class=\"token punctuation\">(</span>other<span class=\"token operator\">:</span> <span class=\"token keyword\">=></span> Future<span class=\"token punctuation\">[</span><span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span><span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span>\n    future<span class=\"token punctuation\">.</span>flatMap<span class=\"token punctuation\">(</span>value <span class=\"token keyword\">=></span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> Future<span class=\"token punctuation\">.</span>successful<span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> other<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And now, with these extension methods we will get this:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">def</span> condition1<span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span><span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">def</span> condition2<span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span><span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">def</span> condition3<span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span><span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">val</span> condition <span class=\"token operator\">=</span> condition1 <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>condition2 <span class=\"token operator\">||</span> condition3<span class=\"token punctuation\">)</span>\ncondition<span class=\"token punctuation\">.</span>flatMap<span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">else</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Nice, right?</p>\n<p>We can go further, for example, if some of conditions aren’t IO-bound, or already calculated, we can just extend it a little bit more:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">implicit class BooleanToFutureExtensions(val v: Boolean) extends AnyVal {\n  def &amp;&amp;(other: =&gt; Future[Boolean]): Future[Boolean] =\n    if (v) other else Future.successful(false)\n\n  def ||(other: =&gt; Future[Boolean]): Future[Boolean] =\n    if (v) Future.successful(true) else other\n}</code></pre></div>\n<p>And use it:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">def</span> condition1<span class=\"token operator\">:</span> <span class=\"token builtin\">Boolean</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">def</span> condition2<span class=\"token operator\">:</span> <span class=\"token builtin\">Boolean</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">def</span> condition3<span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span><span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">val</span> condition <span class=\"token operator\">=</span> condition1 <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>condition2 <span class=\"token operator\">||</span> condition3<span class=\"token punctuation\">)</span>\ncondition<span class=\"token punctuation\">.</span>flatMap<span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">else</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Same code, but now we can mix <code class=\"language-text\">Future[Boolean]</code> and <code class=\"language-text\">Boolean</code>. Well, almost… We also need to add corresponding extension methods to <code class=\"language-text\">Future[Boolean]</code> for commutativity, which is a bit more complex, because we can’t overload method with arguments <code class=\"language-text\">=&gt; Boolean</code> and <code class=\"language-text\">=&gt; Future[Boolean]</code>, so we need to use some implicit magic (called <a href=\"https://nrinaudo.github.io/scala-best-practices/definitions/type_class.html\">type classes</a>):</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">implicit</span> <span class=\"token keyword\">class</span> FutureOfBooleanExtensions<span class=\"token punctuation\">(</span><span class=\"token keyword\">val</span> future<span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span><span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">extends</span> <span class=\"token builtin\">AnyVal</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">def</span> <span class=\"token operator\">&amp;&amp;</span><span class=\"token punctuation\">(</span>other<span class=\"token operator\">:</span> <span class=\"token keyword\">=></span> BooleanOrFutureOfBoolean<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span><span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span>\n    v<span class=\"token punctuation\">.</span>flatMap<span class=\"token punctuation\">(</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">)</span>\n        other <span class=\"token keyword\">match</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">case</span> Bool<span class=\"token punctuation\">(</span>otherValue<span class=\"token punctuation\">)</span> <span class=\"token keyword\">=></span> Future<span class=\"token punctuation\">.</span>successful<span class=\"token punctuation\">(</span>otherValue<span class=\"token punctuation\">)</span>\n          <span class=\"token keyword\">case</span> Fut<span class=\"token punctuation\">(</span>future<span class=\"token punctuation\">)</span> <span class=\"token keyword\">=></span> future\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">else</span>\n        Future<span class=\"token punctuation\">.</span>successful<span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@implicitNotFound</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"This method supports only arguments of type Boolean OR Future[Boolean]\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">sealed</span> <span class=\"token keyword\">trait</span> BooleanOrFutureOfBoolean\n\n<span class=\"token keyword\">object</span> BooleanOrFutureOfBoolean <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">case</span> <span class=\"token keyword\">class</span> Bool<span class=\"token punctuation\">(</span>value<span class=\"token operator\">:</span> <span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">extends</span> BooleanOrFutureOfBoolean\n  <span class=\"token keyword\">case</span> <span class=\"token keyword\">class</span> Fut<span class=\"token punctuation\">(</span>future<span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span><span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">extends</span> BooleanOrFutureOfBoolean\n\n  <span class=\"token keyword\">implicit</span> <span class=\"token keyword\">def</span> `<span class=\"token builtin\">Boolean</span> to BooleanOrFutureOfBoolean`<span class=\"token punctuation\">(</span>v<span class=\"token operator\">:</span> <span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> BooleanOrFutureOfBoolean <span class=\"token operator\">=</span> Bool<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">implicit</span> <span class=\"token keyword\">def</span> `Future<span class=\"token punctuation\">[</span><span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">]</span> to BooleanOrFutureOfBoolean`<span class=\"token punctuation\">(</span>v<span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span><span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> BooleanOrFutureOfBoolean <span class=\"token operator\">=</span> Fut<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>I hope you’ve got the idea: whatever regular boolean operation you need, just extend <code class=\"language-text\">Future[Boolean]</code> and <code class=\"language-text\">Boolean</code> classes to support it, and your code will look beautiful and simple.</p>\n<h2 id=\"for-comprehensions-for-the-rescue\" style=\"position:relative;\"><a href=\"#for-comprehensions-for-the-rescue\" aria-label=\"for comprehensions for the rescue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>for-comprehensions for the rescue</h2>\n<p>Another way of making code look like future-less code is usage of for-comprehensions. This topic is covered quite a lot (<a href=\"https://docs.scala-lang.org/overviews/core/futures.html#functional-composition-and-for-comprehensions\">1</a>, <a href=\"https://contributors.scala-lang.org/t/sequencing-in-for-comprehensions/779\">2</a>, <a href=\"https://stackoverflow.com/a/19046133/426397\">3</a>). In short, it looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">def</span> getMovie<span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span>Movie<span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">def</span> getActors<span class=\"token punctuation\">(</span>movie<span class=\"token operator\">:</span> Movie<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span>Seq<span class=\"token punctuation\">[</span>Actor<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">def</span> getPlot<span class=\"token punctuation\">(</span>movie<span class=\"token operator\">:</span> Movie<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span>MoviePlot<span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span>\n  movie <span class=\"token keyword\">&lt;-</span> getMovie\n  actors <span class=\"token keyword\">&lt;-</span> getActors<span class=\"token punctuation\">(</span>movie<span class=\"token punctuation\">)</span>\n  plot <span class=\"token keyword\">&lt;-</span> getPlot<span class=\"token punctuation\">(</span>movie<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">yield</span> MovieDescription<span class=\"token punctuation\">(</span>movie<span class=\"token punctuation\">,</span> actors<span class=\"token punctuation\">,</span> plot<span class=\"token punctuation\">)</span></code></pre></div>\n<h4 id=\"dealing-with-filter\" style=\"position:relative;\"><a href=\"#dealing-with-filter\" aria-label=\"dealing with filter permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dealing with filter</h4>\n<p>Looks very familiar. But in real life, it’s more complicated:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">def</span> hasPermissions<span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span><span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span>\n  isPermitted <span class=\"token keyword\">&lt;-</span> hasPermissions\n  <span class=\"token keyword\">if</span> isPermitted\n  movie <span class=\"token keyword\">&lt;-</span> getMovie\n  <span class=\"token keyword\">if</span> <span class=\"token operator\">!</span>movie<span class=\"token punctuation\">.</span>hidden\n  actors <span class=\"token keyword\">&lt;-</span> getActors<span class=\"token punctuation\">(</span>movie<span class=\"token punctuation\">)</span>\n  plot <span class=\"token keyword\">&lt;-</span> getPlot<span class=\"token punctuation\">(</span>movie<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">yield</span> MovieDescription<span class=\"token punctuation\">(</span>movie<span class=\"token punctuation\">,</span> actors<span class=\"token punctuation\">,</span> plot<span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">if</code> construct is supported (via <code class=\"language-text\">withFilter</code> method of <code class=\"language-text\">Future</code>), of course, but <code class=\"language-text\">Future</code> will be resolved with <code class=\"language-text\">NoSuchElementException</code>, without ability to understand what’s really happened there.</p>\n<p>I came up with this solution (yes, another extension method):</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">implicit</span> <span class=\"token keyword\">class</span> BooleanFutureExtensions<span class=\"token punctuation\">(</span><span class=\"token keyword\">val</span> future<span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span><span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">extends</span> <span class=\"token builtin\">AnyVal</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">def</span> orFail<span class=\"token punctuation\">(</span>e<span class=\"token operator\">:</span> <span class=\"token keyword\">=></span> Throwable<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span><span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span>\n    future<span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">(</span>t <span class=\"token keyword\">=></span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">.</span>isSuccess <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>t<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">)</span> Failure<span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> t<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And now we can rewrite it in this form:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span>\n  _ <span class=\"token keyword\">&lt;-</span> hasPermissions orFail <span class=\"token keyword\">new</span> PermissionDeniedException<span class=\"token punctuation\">(</span><span class=\"token string\">\"...\"</span><span class=\"token punctuation\">)</span>\n  movie <span class=\"token keyword\">&lt;-</span> getMovie\n  <span class=\"token keyword\">if</span> <span class=\"token operator\">!</span>movie<span class=\"token punctuation\">.</span>hidden\n  actors <span class=\"token keyword\">&lt;-</span> getActors<span class=\"token punctuation\">(</span>movie<span class=\"token punctuation\">)</span>\n  plot <span class=\"token keyword\">&lt;-</span> getPlot<span class=\"token punctuation\">(</span>movie<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">yield</span> MovieDescription<span class=\"token punctuation\">(</span>movie<span class=\"token punctuation\">,</span> actors<span class=\"token punctuation\">,</span> plot<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Now there will be <code class=\"language-text\">PermissionDeniedException</code> if user doesn’t have permissions, but still <code class=\"language-text\">NoSuchElementException</code> if movie is hidden. One of solutions might be this: instead of just comprehending <code class=\"language-text\">getMovie</code>, we may make it slightly more complex:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\">movie <span class=\"token keyword\">&lt;-</span> getMovie<span class=\"token punctuation\">.</span>filter<span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_<span class=\"token punctuation\">.</span>hidden<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>recoverWith <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">case</span> _<span class=\"token operator\">:</span> NoSuchElementException <span class=\"token keyword\">=></span> Future<span class=\"token punctuation\">.</span>failed<span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> HiddenMovieException<span class=\"token punctuation\">(</span><span class=\"token string\">\"...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>As always, we can simplify it with simple extension method:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">implicit</span> <span class=\"token keyword\">class</span> FutureExtensions<span class=\"token punctuation\">[</span>T<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">val</span> future<span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span>T<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">extends</span> <span class=\"token builtin\">AnyVal</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">def</span> filterOrFail<span class=\"token punctuation\">(</span>f<span class=\"token operator\">:</span> T <span class=\"token keyword\">=></span> <span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">,</span> e<span class=\"token operator\">:</span> <span class=\"token keyword\">=></span> Throwable<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span>T<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span>\n    future<span class=\"token punctuation\">.</span>flatMap<span class=\"token punctuation\">(</span>value <span class=\"token keyword\">=></span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> Future<span class=\"token punctuation\">.</span>successful<span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> Future<span class=\"token punctuation\">.</span>failed<span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Much better now:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span>\n  _ <span class=\"token keyword\">&lt;-</span> hasPermissions orFail <span class=\"token keyword\">new</span> PermissionDeniedException<span class=\"token punctuation\">(</span><span class=\"token string\">\"...\"</span><span class=\"token punctuation\">)</span>\n  movie <span class=\"token keyword\">&lt;-</span> getMovie<span class=\"token punctuation\">.</span>filterOrFail<span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_<span class=\"token punctuation\">.</span>hidden<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> HiddenMovieException<span class=\"token punctuation\">(</span><span class=\"token string\">\"...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  actors <span class=\"token keyword\">&lt;-</span> getActors<span class=\"token punctuation\">(</span>movie<span class=\"token punctuation\">)</span>\n  plot <span class=\"token keyword\">&lt;-</span> getPlot<span class=\"token punctuation\">(</span>movie<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">yield</span> MovieDescription<span class=\"token punctuation\">(</span>movie<span class=\"token punctuation\">,</span> actors<span class=\"token punctuation\">,</span> plot<span class=\"token punctuation\">)</span></code></pre></div>\n<h4 id=\"another-filter-related-consideration\" style=\"position:relative;\"><a href=\"#another-filter-related-consideration\" aria-label=\"another filter related consideration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Another filter-related consideration</h4>\n<p>What I really don’t like about regular <code class=\"language-text\">filter</code> is this <code class=\"language-text\">NoSuchElementException</code>. When we use <code class=\"language-text\">recover</code> or <code class=\"language-text\">recoverWith</code> right after, it means, that this exception is created only to be catched very match soon and will be replaced with something else. In a hell for <del>perfectionists</del> people who waste their time on micro-optimizations there is a never-ending loop</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> NoSuchElementException\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">case</span> _<span class=\"token operator\">:</span> NoSuchElementException <span class=\"token keyword\">=></span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>To deal with my control freak’s issue I’ve created simple singleton exception without a stack-trace:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">object ControlException extends Throwable(&quot;control&quot;, null, false, false) {\n  def unapply(e: Throwable): Boolean = e.isInstanceOf[ControlException.type]\n}</code></pre></div>\n<p>And whenever I extend <code class=\"language-text\">Future</code> in a way that I need to call <code class=\"language-text\">recover</code> method after, I use this <code class=\"language-text\">ControlException</code> which literally has close to zero overhead. Of course, I have convenient extension methods supporting it:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">implicit</span> <span class=\"token keyword\">class</span> FutureExtensions<span class=\"token punctuation\">[</span>T<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">val</span> future<span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span>T<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">extends</span> <span class=\"token builtin\">AnyVal</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">def</span> recoverFilter<span class=\"token punctuation\">(</span>f<span class=\"token operator\">:</span> <span class=\"token keyword\">=></span> T<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span>T<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span>\n    future<span class=\"token punctuation\">.</span>recover <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">case</span> _<span class=\"token operator\">:</span> NoSuchElementException <span class=\"token operator\">|</span> ControlException <span class=\"token keyword\">=></span> f\n    <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">def</span> recoverFilterWith<span class=\"token punctuation\">(</span>f<span class=\"token operator\">:</span> <span class=\"token keyword\">=></span> Future<span class=\"token punctuation\">[</span>T<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span>T<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span>\n    future<span class=\"token punctuation\">.</span>recoverWith <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">case</span> _<span class=\"token operator\">:</span> NoSuchElementException <span class=\"token operator\">|</span> ControlException <span class=\"token keyword\">=></span> f\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4 id=\"dealing-with-option\" style=\"position:relative;\"><a href=\"#dealing-with-option\" aria-label=\"dealing with option permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dealing with Option</h4>\n<p>Another problem with for-comprehensions is that you can’t mix different monads (like <code class=\"language-text\">Option</code>). Because in real life it’s quite common to expose methods like:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">def</span> findMovie<span class=\"token punctuation\">(</span>title<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span>Option<span class=\"token punctuation\">[</span>Movie<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>In this case, in for-comprehensions in this expression <code class=\"language-text\">movie &lt;- findMovie(&quot;Dark Waters&quot;)</code> the type of <code class=\"language-text\">movie</code> will be <code class=\"language-text\">Option[Movie]</code>, not <code class=\"language-text\">Movie</code>. Which is understandable, but we need to find out how to deal with it. One way is to expose Option-less version which resolves <code class=\"language-text\">Future</code> with some <code class=\"language-text\">Exception</code>. Another approach is, as you may already have guessed, to create a convenient extension method:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">implicit</span> <span class=\"token keyword\">class</span> FutureOfOptionExtensions<span class=\"token punctuation\">[</span>T<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">val</span> v<span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span>Option<span class=\"token punctuation\">[</span>T<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">extends</span> <span class=\"token builtin\">AnyVal</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">def</span> orFail<span class=\"token punctuation\">(</span>e<span class=\"token operator\">:</span> <span class=\"token keyword\">=></span> Throwable<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Future<span class=\"token punctuation\">[</span>T<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span>\n    v<span class=\"token punctuation\">.</span>flatMap<span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">.</span>fold<span class=\"token punctuation\">[</span>Future<span class=\"token punctuation\">[</span>T<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>Future<span class=\"token punctuation\">.</span>failed<span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Future<span class=\"token punctuation\">.</span>successful<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And usage:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span>\n  movie <span class=\"token keyword\">&lt;-</span> findMovie<span class=\"token punctuation\">(</span><span class=\"token string\">\"Dark Waters\"</span><span class=\"token punctuation\">)</span> orFail <span class=\"token keyword\">new</span> MovieNotFoundException<span class=\"token punctuation\">(</span><span class=\"token string\">\"...\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">yield</span> movie</code></pre></div>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>This part is the most basic of async programming: coding in async fashion. But still, when I started to write more and more code I realized how vanilla Scala is not sufficient to do most of the work — I import my extensions in every second file where I write something with Futures.</p>\n<p>And because <code class=\"language-text\">Future</code> functionality is very limited out of the box, don’t hesitate to extend it to make the life easier and the code more readable.</p>\n<p>All code is available on <a href=\"https://github.com/dkomanov/stuff/tree/master/src/com/komanov/future\">GitHub</a>. Originally posted on <a href=\"https://medium.com/@dkomanov/writing-async-app-in-scala-part-1-coding-dd09b014d576\">Medium</a>. <a href=\"https://pixabay.com/photos/technology-keyboard-computing-785742/\">Image</a> by <a href=\"https://pixabay.com/users/Pixies-1021586/?utm_source=link-attribution&#x26;utm_medium=referral&#x26;utm_campaign=image&#x26;utm_content=785742\">Daniel Agrelo</a> from <a href=\"https://pixabay.com/?utm_source=link-attribution&#x26;utm_medium=referral&#x26;utm_campaign=image&#x26;utm_content=785742\">Pixabay</a>.</p>","fields":{"slug":"/p/writing-async-app-in-scala-part-1-coding/"},"frontmatter":{"rawDate":"2020-05-23T00:00:00.000Z","date":"May 23, 2020","title":"Writing Async App in Scala. Part 1: Coding","description":"How the async code looks like, How to make it more readable and look like non-async code. Extending Future capabilities to match our needs.","tags":["scala","async","coding"],"canonicalUrl":"https://medium.com/@dkomanov/writing-async-app-in-scala-part-1-coding-dd09b014d576","cover":{"publicURL":"/static/aac741ab23d741e93808fb1effe02d8d/cover.jpg"}}}},"pageContext":{"slug":"/p/writing-async-app-in-scala-part-1-coding/","previous":{"fields":{"slug":"/p/scala-try-with-resources/"}},"next":{"fields":{"slug":"/p/writing-async-app-in-scala-part-2-exception-handling/"}}}}}