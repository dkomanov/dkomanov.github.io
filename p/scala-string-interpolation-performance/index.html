<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta data-react-helmet="true" name="twitter:description" content="Performance comparison between different kinds of string concatenation/formatting in Java/Scala..."/><meta data-react-helmet="true" name="twitter:title" content="Scala: String Interpolation Performance"/><meta data-react-helmet="true" name="twitter:creator" content="Dmitry Komanov"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="og:type" content="website"/><meta data-react-helmet="true" name="og:description" content="Performance comparison between different kinds of string concatenation/formatting in Java/Scala..."/><meta data-react-helmet="true" name="og:title" content="Scala: String Interpolation Performance"/><meta data-react-helmet="true" name="description" content="Performance comparison between different kinds of string concatenation/formatting in Java/Scala..."/><meta name="theme-color" content="#663399"/><meta name="generator" content="Gatsby 4.19.2"/><style data-href="/styles.29745ad4453b633c257a.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#000;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;text-shadow:0 1px #fff;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#b3d4fc;text-shadow:none}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{background:hsla(0,0%,100%,.5);color:#9a6e3a}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}article{border-bottom:1px solid #f2f2f0;padding:40px 0}article:last-child{border-bottom:0}article .post-title{display:block;font-size:28px;font-style:normal;font-weight:700;letter-spacing:-.02em;line-height:1.1;margin:0}article .post-teaser{float:left;height:100px;padding:0 10px 0 0;width:100px}article .post-description{color:#666665;font-size:20px;font-style:normal;font-weight:300;letter-spacing:-.02em;line-height:1.3}article .teaser-padding{margin-left:110px}article .post-meta{color:#b3b3b1;font-size:14px;line-height:30px}article .post-meta time{margin:0 1em 0 0;vertical-align:middle}ul.pagination{list-style:none;margin:1em 0 0;padding:0}ul.pagination li{color:#b3b3b1;float:left;padding:0 10px 0 0}ul.pagination li.active{font-weight:700}ul.pagination li a,ul.pagination li a:visited{color:#b3b3b1;text-decoration:none}.btn{background-color:transparent;border:none;cursor:pointer;display:inline;margin:0;outline:0;padding:0;text-decoration:underline}.btn:focus,.btn:hover{text-decoration:none}.table-toggler{text-align:center}.table-toggler a{border-bottom:1px dotted #000;cursor:pointer;font-size:.7em}.raw-data-table table{width:100%}.raw-data-table table th{background-color:rgba(0,0,0,.03)}.raw-data-table table .right{text-align:right}.markdown div.choose ul{margin:.5em 0 0;padding:0}.markdown div.choose ul li:first-child{border-radius:5px 0 0 5px}.markdown div.choose ul li:last-child{border-radius:0 5px 5px 0}.markdown div.choose ul li{background-color:rgba(0,0,0,.05);color:rgba(0,0,0,.68);cursor:pointer;line-height:1.4;margin:0;min-width:40px;padding:3px .5em;text-align:center}.markdown div.choose ul li:hover{background-color:rgba(0,0,0,.15)}.markdown div.choose ul li.active{background-color:rgba(0,0,0,.15);cursor:default}.markdown div.choose label{background-color:rgba(0,0,0,.05);color:rgba(0,0,0,.68);display:inline-block;font-size:23px;margin:0 .5em 0 0;padding:5px;vertical-align:bottom}body{text-rendering:optimizeLegibility;-webkit-font-feature-settings:"liga";font-feature-settings:"liga";font-family:Open Sans,MundoSans,Helvetica Neue,Arial,Helvetica,sans-serif;font-size:1.2em;margin:0;padding:0}a{color:#333332}a,a:hover{text-decoration:none}.cf:after{clear:both;content:"";display:table}ul.horizontal{display:inline-block;list-style:none;margin:0;padding:0;vertical-align:top}ul.horizontal li{float:left}.site-header{box-sizing:border-box;margin:0 auto;max-width:740px;padding:0;position:relative;top:-140px;width:100%;z-index:2}.site-header .site-logo{background-color:#fff;background-image:url(data:image/jpeg;base64,/9j/2wCEAAMCAgMCAgMDAwMEAwMEBQgFBQQEBQoHBwYIDAoMDAsKCwsNDhIQDQ4RDgsLEBYQERMUFRUVDA8XGBYUGBIUFRQBAwQEBQQFCQUFCRQNCw0UFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFP/AABEIAGQAZAMBIgACEQEDEQH/xAGiAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgsQAAIBAwMCBAMFBQQEAAABfQECAwAEEQUSITFBBhNRYQcicRQygZGhCCNCscEVUtHwJDNicoIJChYXGBkaJSYnKCkqNDU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+gEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoLEQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APAvcdaeJFddk6eah49xUZ4PWj271+NXP7VlCM1aSKd14Wju1drN92Ryp6jnNYM2j3NgGGxj8pG1uRn2rqkLIyujFGByGBwRWjYy3eqXSWwhF7LIcAMPm+uf6mu2ji61O0Yu58JnHCOVZgpVq0VF9ZLT7+n3nnUrFQV+zlCTzxnnnHP5VNZ20r48lWbAaRsJnC4Of6mvoKx+EeksfMvX2sRyEfcqH0BABbHGTxycDPGa2s/DfR3vHhsLV5dmCbiV+I0PRvqccDHUjHGC3vU685L342P56zHKMDQquOErOS81p9+n5Hz9J5pm/wBWQVYsTjAIIGB+FPc73aWOMKrZIGMfWvRT8NYrvWobIF4AGbAXn5cjJJ7nLDPYdB0qbwn8PY57q8sr64ZyAHhkK5jaJhkc+nIB9MHPFdLqq10eVHLVKVlOy9Dy4xMZSseEAU49/b8ciqSbVbJQ7yQNqdBXtPin4KSaOhlBzbMfmyOEPXr+VcuPAMCMSt3ApJ5Icda4ZZjTg+WSaPrsHwLi8dSVbDV4ST9TE8MIftUwxgqu3j2wP6V0oG4+1J/wjJ0B0czwTGZT/qZkfAyOu0nHXvUgNfP4iaq1HNdT+ksjwc8Bl9LCz3ikvuQuD2NGG9aBkgYpfm9qwPdK/U0hp2KMcjNMyGbSSAuQa7rRo49Ato4AwFxcYM8g6oo52c9P07VxNpcxwapbBwGwTIQRkEAE4/Q1V17xXJZlwkpWZkyr5JGMgc8+h/QelethaDa5mtWfjfGOcynV/s+k/dj8Xm+3y/P0PVbTxUTIfIZnit2WJI8geY5JAUHuSTnr0yc9q1LLWTLM8l2jFIFEpySFnlOQCOny9SAewzgHNcZ8NbNbpoZJcrDbKzuGGPnYYP44wn5nua6jxO3k/ZldQxkl3mMHAIA4X6AcfifWupVOSXKj87eH56fNI0Vs7WK9a8WZ5fJxuHJLnhz19ww/MViTXH2fSrwxKpu7CYqzHkywkk7enONrD23L+FOHVPLJbzCZHZX3Bjnauc457nP4mteys3gtVuyVCTMyy5A6tgjH/AgtbSq6aGNPCO97mlovimKeF7S4ZpbeSPZKkvzBlIBVuep27c/jXmfinQhpF6xjH7lySoJ5XnpWnrWmtp0a3akjYvlPtOSSr4X8w2Ky9Q1xdSsFFw+JYz5bN047H6cAj6muGrR9pG6PrsgzWWVYyKk/ck7P07/IxgR/9enUgTPPelCfjXjn9DLUUZHTNLlvek2/hRj/ADmgLDdufrQTxzxUu2mOvHPWgzRw+p659m19iJNu0lOvTII/x/OsfSdQTVvG9na3BaWASbyqnO8KCVUe5JxWP45MkGr36cqSxOfbJI/nXon7PHhAT6ffeKLuPe8eYLfcM8g/M38gD9a+0ShSwyn5WP5Zx3tK2Z1uffmk3959DeBPCbwBI59kUHE1w2QBk8hAM9uvPqPXjO8Y2Bvry+niPFrsgjAOcM/zH8tyj8K828S+MPD32K6hv9cv4Jcbna13OU574B2849K53wb4sllv0isdbu761kfz0S5j++DkbuRnuRmvM+rvl5/0O2NVOXI7feej6b4P1C+vrVlRwkrtkdCAp24/UfnXsX/CAmTw9LbmQvJGuVA6H0P5YP41wXiHxZfeB/DmkXM9oY8LhJ3BKuTg8fUgGvPov2gvE+o3ywR+IdF0+JThFmkEZYZ6d81Macqi0OlyhTWnU6nxVCbbTLgy74GjJUk5GzC7T/Pj6g14fe+IFSGRlfLSkKyg91UD+WPyr17xRrF/4osJ7R2ivJLuEqlxB/e2n8+cc18xPPNJJKSCjRyAlGHAz1/UV34WndNSPGxnxJxR7Po99/aGmW8+dxdfmPuOtXlbJxmub8DyM2gQ5ycEjJroFJB+lfM4iKhWlFdz+lMnrTr5fQnPdxX5Ehwxz/KkwPemknPf86TLeh/Ouc9m5aApjjkGpTgDJIqrNPk4HSmlczbSOF+IunxNe6TMdiC5nW0kduAAx+Un6c19EfAjw3/YfhqDSrpQzRs5II45dsD8sV8zfGm5MfhmJFyXecFcdsA/419PfBvxRD4r8IWOvWsL26XSl/Jc5KMGYMue+CDzX0SUpYKDe13/AMA/BOIlSp53VUd2ov8ADX9H8z0e5+E1vq0QFlItnv5INurDP8/1qqPhDp3hZUuLmcXl43AZgq4HoAK0b3x1JY26Q2oMl3JxFGvVjXCeKfiZJ4AvpV1ewGqPdKC92kgJiP8AdUH+EH0PvXPGLl7sTj5YW5pHp/jjw9beIPCmi6ddxqIiu4tgfIc44/CuDP7KGnxvHNFa6LqduvKR3lqVaIE5+Vk/wrB1L9rDSNVm0/Sk0S61TgAx20Jbg9juwMfnXp2heKtQ0Hy7K/bFvcIJbfL7ioPJjJ7leme9bPmo+Vw9nSra6No4+1+DujeDJZZrWCK2kxnybcsIkPfaCeK+Q/jM8PhXxVrKxQKiXNyfIOOG+VWIH0L191+IrkamW8s/KVJJFfB/xbtrv4g/HQ6NpML6pJZqLZYbNDKzScs4CjOWH3SAP4cdRXfgIuc25PoeLmUo06a5dHc6/wAIIw8M6azYLNEGPHrzWzjj61z3huHWtN1nWNK1q2ubGey8pVs7uAwyQggkAqQCOMda6Jjge9fNYuDhXkn3/M/oTIcVTxmWUK1FPl5Utd9NP0GMdpxSbh7UE/Skz7iuSx7xPIWmdY4wWZjgKvc19BfCn9k7UNXsYdc8ZRXWnWcjZttHQeXdXIHVpCf9TH9RuPP3eCfq/wCFP7N3hL4WKj6ZYC91QD59UvAJJz14U4wg5x8oGR1z1ruNaRIbGdjhppcqQOoX09q+0wuUQpe/Xd326f8ABP5/zvjytir4fLU4Rf2n8T9F09d/Q+Dv2mf2etO8Y+GNN0PQYrHR1tJlmQWsHEmAQQ7n55CAThmJPXpXDfCbwrceAfB1voU8wkniaZt4+6T5jEge3IP519a+LdMA1GG5QAorSDHoo24/mfzrxn4gWi/27dJGAsw2TxgH1GB+BKsPzrTFu9Oy2ufC4SU5VnObbk1u92YQ0tvElg8NlMbPWBwlyckIvfgEdeK57VfBt5oWnNHea1aySEfNJJaAknvy27j24rTsvFMWjXyS5VVDlZFz8w7c139r4i0DxAFW4WPzGHzKxBBrxY80GfU0Kil/wTx7wx4Y1KdsWd5oaruJWOW0HB/4AQQfeuw03wtrdqZP+ElvrUafETLE9rIx+bsPmGQOa7eJ/C+lIcQ2sOST+7IDE/WuX8WeKbLVSbCBtsQU/MOR+dOpKU3ax0VZxitNH5DJNfW00q8lXBSGNmXd3wOM1wf7FHwI1CXxrB4u1mNmnlikuYZ3H33YYLc85+Y/ma734c+Fn8Y6oNPdS9psdnOMZG0jP0OQP+BV9M/DLR4dMtNMtooliW001EUKMddv/wASK9jBx5YaHyuPqOc0ux3Op+AfD3jbRI7XxHo9nrDbSqvcwh5EB6lX+8p91INeA/Er9hLTL4SXfgnVW0y4bLDTtRYywnpgK/307n5g/XtX0/oaBYVPcdvSt6NwBz0r0quHo4hWqxv+f3mGBzfH5VPmwlVx8un3PQ/KjxD8AviH4a1SSxuvCGrTypz5llavcxMOxDxgj8M59QKzf+FQ+Ov+hL8Q/wDgqn/+Jr9blgRhnaPwFL9mX+6PyryXktBvSTPvYeImPUUpUYN/P/MoXjvCm+MbQnLJ6r/Wud1hjL5p3Ao5BX8q2nusqR1ZfWua1keW6op4B+XFe5KR+VxieY+IE33DIMBV87j3G014Z8ULOS01jTr5Q2JYWtZT2G07k/Hl6971mBvNuSOWS4MnPoVwf5V5r8RdAOq6DKIkLzQETRheSSo6D1JUkfU15laDnBpHpUKihVjJng/iPRm1SMvAwjuVHQ9H+vv715hqra1o12w3PDkgDzPmH5j6V7BJOrR7lI9c1jao0dxGQ6hx05FePGVtz6VRu9Dy0ahreozqz3UjHkZCk8V3ei6ZNZW8TXJZ5G+WOL1Oc8+1JYxQ282RH0PAx0rsPCGizeJfEdlaxqTPO2AQM+VGPvufoM/U4HetFLmdoodRRh703se3/ATwy9ro13qsijzZUMcRI5wPvEH0JGMf7Fe06Jbi11CdQMBLaNPyLj+QrG0qxg0jRYbOJfKXascS9cYwFH57fzro7Ubbu/cf3UHP0z/WvahD2cVE+WnUdacpvqdJoc5EDE9Sa2YZS5Fc7pLYiGO9bUMn8PQ46+ma647HJP4maa3MjDMedvYhQc+9L583+1/3wKpfao4wAZ1hzyFJxx/nj8KPt0P/AD+J+dWZ8jZmPK32hBnhlOaxNZkb7ZCM9etbD/8AHzF/uNWLrP8Ax+wf57VnI0jucfeqGu7nIzkkEf8AAv8A69creKHVgRxXV3n/AB9z/U/+hVytz0asXsW+h83eOLZNI8Z6tZ2w2W6yoyp2XeiuQPbLHHtXOXjMMjccZ6V1HxL/AOShav8A78P/AKJSuWve/wBa8OqlzM+roN8sfRDNNgW4ulV+nXivoP4BaHaCHUNSKZunm+zbjj5UCq2B3GS3P+6PSvANG/4/Vr6O+Af/ACArz/r+f/0COtcKl7Q48wb9n9x61gPdop+6kkOB/wADBrajGJL3HHzKP0FYy/8AH7/20g/9CFbUf+svf95f5CvWZ4dPY1dNJMQq/FK2XH+9/Qf1qhpn+pX6CrkX3n/4F/MVsuhlPdjYraO9aaSdBIwkZBuHQA4A/SpP7Ltf+eCflS2H3J/+uz/+hGrNAM//2Q==);background-size:cover;border:3px solid #fff;border-radius:50%;box-shadow:0 1px 1px rgba(0,0,0,.3);height:120px;margin-right:-60px;position:absolute;right:50%;text-indent:-9999px;top:-60px;width:120px;z-index:99}.site-header .site-title{color:#fff;font-size:50px;font-weight:700;letter-spacing:-2px;line-height:50px;margin:0;outline:0;padding:84px 16px 8px;text-align:center;word-break:break-word}.site-header .site-description{color:#666;font-size:18px;font-weight:400;line-height:1.5;margin:0 0 20px;padding:0 32px;text-align:center}.site-content{box-sizing:border-box;margin:0 auto;max-width:740px;position:relative;top:-140px;width:100%}.wide-content{display:block;left:50%;margin-left:-48vw;margin-right:-48vw;position:relative;right:50%;width:96vw}@media only screen and (max-width:800px){.site-content{padding:0 32px}}.markdown{color:#333;width:100%}.markdown,.markdown h1,.markdown h2,.markdown h3{font-family:Linux Libertine,serif}.markdown h3,.markdown h4,.markdown h5,.markdown h6{font-family:Linux Libertine,serif;font-size:24px;font-style:normal;font-weight:700;letter-spacing:-.02em;line-height:1.3;margin:0 0 4px}.markdown h5,.markdown h6{font-family:Linux Libertine,serif;font-size:20px;font-style:normal;font-weight:500;letter-spacing:.02em;line-height:1.4;margin:0 0 3px;text-transform:uppercase}.markdown h1,.markdown h2{font-size:32px;font-style:normal;font-weight:700;letter-spacing:-.02em;line-height:1.2;margin-bottom:4px;padding-top:31px}.markdown p{color:#333;font-size:22px;font-style:normal;font-weight:400;-webkit-hyphens:auto;hyphens:auto;line-height:30px;margin:0;padding-bottom:30px}.markdown a{color:#333;text-decoration:underline}.markdown img{margin:0 auto;max-width:100%}.markdown figure{margin:0;padding:0 0 30px}.markdown figcaption{color:#666665;font-size:16px;font-style:italic;font-weight:400;line-height:1.3;outline:0;text-align:center;z-index:300}.markdown hr{border:0;border-top:1px solid #ddd;display:block;margin:30px auto;padding:0;width:15%}.markdown blockquote,.markdown li blockquote{border-left:3px solid #57ad68;margin:0 0 30px -26px;padding-left:20px}.markdown blockquote p,.markdown li blockquote p{border-left:3px solid #57ad68;font-style:italic;font-weight:400;letter-spacing:.01rem;margin-left:-26px;padding-bottom:3px;padding-left:20px}.markdown ol,.markdown ul{margin:0;padding:0 0 30px}.markdown li{font-size:23px;font-style:normal;font-weight:400;line-height:30px;margin-bottom:12px;margin-left:30px;padding:2px 0 0}.markdown li p{padding:0 0 1.618rem}.markdown ol li{list-style-type:decimal}.markdown code{font-family:Courier,monospace;font-size:16px}.markdown.tiny *{font-size:16px;line-height:1.2em}.markdown.tiny ul{padding:0}.markdown.tiny ul li{margin-bottom:0}footer{color:#999;font-size:12px;line-height:17.6px;margin:0 auto;max-width:640px;padding:22px 0;text-align:center;width:100%}footer a{color:#666;text-decoration:none}footer a:hover{color:#333}.share-buttons{display:inline-block}.share-buttons .share-button{display:inline-block;margin:0 0 0 .5em;text-align:center;vertical-align:top}.site-menu{color:#ccc;margin:0 0 50px;text-align:center}.site-menu a{color:#999;padding-left:20px;text-decoration:none}.site-menu a:hover{color:#333}.site-menu a.active{font-weight:700}.tag-cloud a{margin:6px}ul.tags{display:inline-block;list-style:none;margin:0;padding:0;vertical-align:top}ul.tags li{background-color:rgba(0,0,0,.05);border-radius:3px;float:left;line-height:1.4;margin:4px .5em 0 0;padding:3px 5px}ul.tags li:hover{background-color:rgba(0,0,0,.15)}ul.tags li.label{padding:0 .5em 0 0}ul.tags li a,ul.tags li a:visited{color:rgba(0,0,0,.68);text-decoration:none}.teaser-image{background-color:#000;height:360px;overflow:hidden;position:relative}.teaser-image_image{background-position:50%;background-size:cover;bottom:0;left:0;position:absolute;right:0;text-indent:-9999px;top:0;z-index:1}.time-units p.small{margin:0 0 10px}.time-units small{color:rgba(0,0,0,.3);font-size:11px}.site-content.no-cover{position:relative;top:0}.no-cover .post-meta{padding-top:60px}.no-cover .post-title{color:#333332;font-size:50px;font-style:normal;font-weight:700;letter-spacing:-.04em;line-height:1.1;margin-bottom:16px}.no-cover .author-image{background-image:url(/img/top-logo.jpg);background-size:cover;border-radius:100%;display:inline-block;float:left;height:30px;line-height:30px;margin-bottom:-10px;margin-right:8px;text-indent:-9999px;width:30px}.no-cover .author-name{display:inline}.no-cover .post-meta-text{color:#b3b3b1;font-size:14px;font-style:normal;font-weight:400;letter-spacing:-.02em;text-overflow:ellipsis;white-space:nowrap}.blog-post-meta{color:#b3b3b1}ul.what-i-read{list-style-type:none;margin:0;padding:0}ul.what-i-read>li{display:inline-block;padding:0 10px 0 0}</style><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="alternate" type="application/rss+xml" title="Severe Software Developer Blog" href="/rss.xml"/><link rel="icon" href="/favicon-32x32.png?v=994a873755adc623fbc44f1a9a107c69" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=994a873755adc623fbc44f1a9a107c69"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=994a873755adc623fbc44f1a9a107c69"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=994a873755adc623fbc44f1a9a107c69"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=994a873755adc623fbc44f1a9a107c69"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=994a873755adc623fbc44f1a9a107c69"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=994a873755adc623fbc44f1a9a107c69"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=994a873755adc623fbc44f1a9a107c69"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=994a873755adc623fbc44f1a9a107c69"/><title data-react-helmet="true">Scala: String Interpolation Performance | @dkomanov</title><link data-react-helmet="true" rel="canonical" href="https://medium.com/@dkomanov/scala-string-interpolation-performance-21dc85e83afd"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="site-content no-cover"><div class="post-meta"><h1 class="post-title">Scala: String Interpolation Performance</h1><div class="cf post-meta-text"><a href="/"><span class="author-image">Blog Logo</span></a><h4 class="author-name" itemProp="author" itemscope="" itemType="http://schema.org/Person">Dmitry Komanov</h4><span> on <time dateTime="2016-12-05T00:00:00.000Z">December 05, 2016</time><br/><br/></span></div><div class="site-menu"><a href="/">Blog</a><a href="/what-i-read">What I Read</a><a href="/what-i-listen">What I Listen</a><a href="/about">About</a></div></div><div class="blog-post" itemscope="" itemType="http://schema.org/Article"><div class="markdown " role="main"><blockquote>
<p>Performance comparison between different kinds of string concatenation/formatting in Java/Scala</p>
</blockquote>
<p>String concatenation is a basic building block in every modern programming
language. Many different projects, especially in Web, produce a lot of strings.
And it’s interesting, how this problem is solved in different languages.
In our case, in Java and Scala (because it’s much easier to compare, and
these I use day-to-day).</p>
<p>There are a <a href="https://www.google.com/?q=java+string+concatenation+performance">lot</a> of <a href="https://www.google.com/?q=scala+string+interpolation+performance">posts</a>
on Internet about this topic. But still, there are something interesting to say
about it (I hope you won’t be bored). Yes, this is about performance and microbenchmarking,
I <a href="http://wiki.jvmlangsummit.com/images/1/1d/PerformanceAnxiety2010.pdf">know</a>.</p>
<p>Basically, this post is about how to make robust string concatenation
(with macros!) and performance comparison. You may skip this big part right to
Graphs and Conclusion.</p>
<h2 id="what-is-string-concatenation" style="position:relative;"><a href="#what-is-string-concatenation" aria-label="what is string concatenation permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What is string concatenation?</h2>
<p>In JVM <a href="http://docs.oracle.com/javase/8/docs/api/java/lang/String.html">String</a> object is immutable. If you need to
create a new String with a content of two other strings, you need to create
a third one. In Java you may concatenate not only string but any
objects — Java compiler will convert an object to its string representation
automatically. Scala compiler also does it.</p>
<p>What will compiler do, when we write such code in Java:</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> b <span class="token operator">=</span> <span class="token string">"s"</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> str <span class="token operator">=</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span></code></pre></div>
<p>This code will be converted to this code:</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> b <span class="token operator">=</span> <span class="token string">"s"</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Nothing new, it’s well-known thing. But, it’s important to understand,
what is happening there:</p>
<ol>
<li>new StringBuilder creates a class with a char array of 16 elements.</li>
<li>append method converts an argument to chars and stores into an internal array.</li>
</ol>
<p>If an array is not big enough, it will create a bigger array.
3. toString creates a String object, but char array is not shared between
StringBuilder and this new String object (because it’s mutable in StringBuilder).</p>
<p>So, in order to concatenate 2 objects, we need to create an intermediate object,
big enough to store the string representation of our 2 objects.</p>
<h2 id="how-to-improve-default-concatenation" style="position:relative;"><a href="#how-to-improve-default-concatenation" aria-label="how to improve default concatenation permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How to improve default concatenation</h2>
<p>We have 2 heavy operations from the list above: allocation of a buffer in
StringBuilder (and reallocations!) and a creation of String
(making copy of StringBuilder’s buffer).</p>
<p>Let’s put some efforts to deal with it. Because I had a lot of experience
in .NET, I know, how string concatenation is implemented there.</p>
<h3 id="whats-about-cnet" style="position:relative;"><a href="#whats-about-cnet" aria-label="whats about cnet permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What’s about C#.NET?</h3>
<p>In C# the same problem solved in a slightly different way. Actually, many
problems in .NET solved slightly differently.</p>
<p>This concatenation will be converted by the <a href="https://ericlippert.com/2013/06/17/string-concatenation-behind-the-scenes-part-one/">compiler</a>
to call to static method Concat (yes, in .NET they use CamelCase instead of
camelCase in Java, yet another little difference):</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token class-name">String</span> str <span class="token operator">=</span> String<span class="token punctuation">.</span><span class="token function">Concat</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>And inside Concat we may see, how it <a href="https://referencesource.microsoft.com/#mscorlib/system/string.cs,3133">works</a>:</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">String</span> <span class="token function">Concat</span><span class="token punctuation">(</span><span class="token class-name">String</span> str0<span class="token punctuation">,</span> <span class="token class-name">String</span> str1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>str0<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>str1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> String<span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> str1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>str1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> str0<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name"><span class="token keyword">int</span></span> str0Length <span class="token operator">=</span> str0<span class="token punctuation">.</span>Length<span class="token punctuation">;</span>
    <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token function">FastAllocateString</span><span class="token punctuation">(</span>str0<span class="token punctuation">.</span>Length <span class="token operator">+</span> str1<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FillStringChecked</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>        str0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FillStringChecked</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> str0Length<span class="token punctuation">,</span> str1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>What is interesting here is resulting string length precomputation. They create
a char buffer of resulting size, fill it and use in String object without copying. Obviously, this should work much faster (and it’s).</p>
<p>Let’s try to do something similar in Scala.</p>
<h3 id="optimized-string-concatenation" style="position:relative;"><a href="#optimized-string-concatenation" aria-label="optimized string concatenation permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Optimized string concatenation</h3>
<p>So, what do we need is precompute a StringBuilder length to avoid any reallocations.</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">def</span> concat<span class="token punctuation">(</span>o1<span class="token operator">:</span> Object<span class="token punctuation">,</span> o2<span class="token operator">:</span> Object<span class="token punctuation">,</span> o3<span class="token operator">:</span> Object<span class="token punctuation">,</span>
           o4<span class="token operator">:</span> Object<span class="token punctuation">,</span> o5<span class="token operator">:</span> Object<span class="token punctuation">,</span> o6<span class="token operator">:</span> Object<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  concatNonNull<span class="token punctuation">(</span>orNull<span class="token punctuation">(</span>o1<span class="token punctuation">)</span><span class="token punctuation">,</span> orNull<span class="token punctuation">(</span>o2<span class="token punctuation">)</span><span class="token punctuation">,</span> orNull<span class="token punctuation">(</span>o3<span class="token punctuation">)</span><span class="token punctuation">,</span>
                orNull<span class="token punctuation">(</span>o4<span class="token punctuation">)</span><span class="token punctuation">,</span> orNull<span class="token punctuation">(</span>o5<span class="token punctuation">)</span><span class="token punctuation">,</span> orNull<span class="token punctuation">(</span>o6<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">def</span> orNull<span class="token punctuation">(</span>o<span class="token operator">:</span> Object<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token string">"null"</span> <span class="token keyword">else</span> o<span class="token punctuation">.</span>toString
<span class="token keyword">private</span> <span class="token keyword">def</span> concatNonNull<span class="token punctuation">(</span>s1<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> s2<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span>
                          s3<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> s4<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span>
                          s5<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> s6<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">new</span> StringBuilder<span class="token punctuation">(</span>s1<span class="token punctuation">.</span>length <span class="token operator">+</span> s2<span class="token punctuation">.</span>length <span class="token operator">+</span> s3<span class="token punctuation">.</span>length <span class="token operator">+</span> s4<span class="token punctuation">.</span>length <span class="token operator">+</span> s5<span class="token punctuation">.</span>length <span class="token operator">+</span> s6<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>append<span class="token punctuation">(</span>s1<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>append<span class="token punctuation">(</span>s2<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>append<span class="token punctuation">(</span>s3<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>append<span class="token punctuation">(</span>s4<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>append<span class="token punctuation">(</span>s5<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>append<span class="token punctuation">(</span>s6<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>toString
<span class="token punctuation">}</span></code></pre></div>
<p>This is a version for 6 arguments (we may generate as many as we want).
Precalculation of a StringBuilder buffer size should give us some performance
boost (we will see it later).</p>
<h3 id="fast-stringbuildertostring" style="position:relative;"><a href="#fast-stringbuildertostring" aria-label="fast stringbuildertostring permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fast StringBuilder.toString</h3>
<p>Let’s take a look at StringBuilder.toString <a href="http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/8u40-b25/java/lang/StringBuilder.java?av=f#404">implementation</a>:</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create a copy, don't share the array</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>And in String’s constructor <a href="http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/8u40-b25/java/lang/String.java#190">we see</a>:</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token keyword">char</span> value<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ... validations omitted</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOfRange</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> offset<span class="token operator">+</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Aha! Arrays.copyOfRange creates a new char[] and copy data there. We know for sure,
that char array will be filled up and we can use it directly
(we’re good ppl, we won’t modify it after string creation). In String class,
there is a <a href="http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/8u40-b25/java/lang/String.java#597">constructor</a>,
that don’t do copy, but… it’s package-private. Meaning, we can’t use it. Or can we?</p>
<p>We may try to use <a href="http://stackoverflow.com/questions/22244402/how-can-i-improve-performance-of-field-set-perhap-using-methodhandles">fast reflection</a> (MethodHandle)
to access to private constructor! Looks <a href="https://github.com/dkomanov/scala-string-format/blob/master/scala-string-format/src/main/scala/com/komanov/stringformat/FastStringFactory.java">pretty easy</a>:</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">fastNewString</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chars<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> constructor <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span>
            <span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    constructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// it should be cached</span>
    <span class="token class-name">MethodHandle</span> newString <span class="token operator">=</span> <span class="token class-name">MethodHandles</span><span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">unreflectConstructor</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> newString<span class="token punctuation">.</span><span class="token function">invokeExact</span><span class="token punctuation">(</span>chars<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Spoiler: it doesn’t work! Details below.</p>
<h3 id="thats-it" style="position:relative;"><a href="#thats-it" aria-label="thats it permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>That’s it?</h3>
<p>So, that’s it, no more optimizations? Of course not! What else to we do
in concatenation? The toString method calls for each argument. This also could
be optimized. How?</p>
<p>Imagine, you pass an integer there, which is primitive. In order to pass it,
you need to <a href="https://docs.oracle.com/javase/tutorial/java/data/autoboxing.html">box it</a> and then we call Integer.toString
method. What’s wrong with toString? It allocates new memory. StringBuilder has
an optimization for appending primitive values, it calculates how many chars
needed to print an integer (in order to reallocate internal buffer, if necessary)
and then uses internal method Integer.getChars, passing internal char array there.
So, there are no additional allocations for printing integer.</p>
<p>Having such generic method, we can’t utilize StringBuilder power to not do
unnecessary allocations. But, we’re in Scala world, we may use
<a href="http://docs.scala-lang.org/overviews/macros/overview.html">macroses</a>! The very good explanation is in
<a href="http://stackoverflow.com/questions/15329027/string-interpolation-and-macro-how-to-get-the-stringcontext-and-expression-loca">this StackOverflow topic</a>.</p>
<h2 id="scala-string-interpolation" style="position:relative;"><a href="#scala-string-interpolation" aria-label="scala string interpolation permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Scala String Interpolation</h2>
<p>But before I move to macros implementation of string concatenation, let’s take
a look at Scala’s way of string formatting which is called
<a href="http://docs.scala-lang.org/overviews/core/string-interpolation.html">String Interpolation</a>:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">val</span> value1 <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">val</span> value2 <span class="token operator">=</span> <span class="token string">"abc"</span>
<span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"start</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">value1</span><span class="token punctuation">}</span></span><span class="token string">middle</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">value2</span><span class="token punctuation">}</span></span><span class="token string">end"</span></span></code></pre></div>
<p>This is an equivalent of Java of Scala simple string concatenation, but looks
much better:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token string">"start"</span> <span class="token operator">+</span> value1 <span class="token operator">+</span> <span class="token string">"middle"</span> <span class="token operator">+</span> value2 <span class="token operator">+</span> <span class="token string">"end"</span></code></pre></div>
<p>Scala compiler transforms such interpolation to this code:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">new</span> StringContext<span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">,</span> <span class="token string">"middle"</span><span class="token punctuation">,</span> <span class="token string">"end"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>s<span class="token punctuation">(</span>value1<span class="token punctuation">,</span> value2<span class="token punctuation">)</span></code></pre></div>
<p>Oh no. Again, more allocations? Yes. At least 2: one for an array of string
constants and another for an array of arguments. And also, inside method s,
there is a processing of string constants (yes, on each call). Doesn’t look as
highly optimal.</p>
<h3 id="macros-to-rule-them-all" style="position:relative;"><a href="#macros-to-rule-them-all" aria-label="macros to rule them all permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Macros to rule them all</h3>
<p>We may create a macros, that will generate another code for string interpolation.
We still can use this neat syntax, but do whatever we want to concatenate these
string constants and arguments.</p>
<p>For example, we can precalculate length of StringBuilder, and then append
arguments there and be sure, that there won’t be any other allocation.</p>
<p>The <a href="https://github.com/dkomanov/scala-string-format/blob/master/scala-string-format/src/main/scala/com/komanov/stringformat/macros/MacroConcat.scala">code of macros</a> is relatively small
(around 100 lines), but it’s hard to demonstrate it well. I will explain what
it does. This code:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">def</span> value1<span class="token operator">:</span> <span class="token builtin">Int</span>
<span class="token keyword">def</span> value2<span class="token operator">:</span> Object
<span class="token string-interpolation"><span class="token id function">sfi</span><span class="token string">"a</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">value1</span><span class="token punctuation">}</span></span><span class="token string">b</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">value2</span><span class="token punctuation">}</span></span><span class="token string">c"</span></span></code></pre></div>
<p>Will be transformed to this code:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">val</span> local_2 <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">val</span> tmp <span class="token operator">=</span> value2
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp eq <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token string">"null"</span> <span class="token keyword">else</span> tmp<span class="token punctuation">.</span>toString
<span class="token punctuation">}</span>
<span class="token keyword">new</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>StringBuilder<span class="token punctuation">(</span><span class="token number">12</span> <span class="token operator">+</span> local_2<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span>append<span class="token punctuation">(</span>value1<span class="token punctuation">)</span>
  <span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span>append<span class="token punctuation">(</span>local_2<span class="token punctuation">)</span>
  <span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"c"</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span>toString</code></pre></div>
<p>Important parts of generated code:</p>
<ol>
<li>sfi stands for “super fast interpolation” :)</li>
<li>Precalculated length constant — 12 — consists of 3 characters for strings</li>
</ol>
<p>“a”, “b” and “c” and 9 characters allocated for int (value1). It may be not
enough (for bigger int), but this is a simplification for now.
3. We don’t box integer and don’t call toString, but using append method
overload for int. It should be faster.</p>
<p>Obviously, macros could be much richer — we can calculate exactly length of
integer (and all primitive values) to not over/under allocate buffer. We may
determine whether it’s safe to not create local variables (if it’s already local
variable or field) to reduce bytecode size.</p>
<p>But, for testing purposes, I think it’s good enough.</p>
<h3 id="lets-microbenchmark-it" style="position:relative;"><a href="#lets-microbenchmark-it" aria-label="lets microbenchmark it permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Let’s microbenchmark it!</h3>
<p>Basically, I will test this case:</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">int</span> value1<span class="token punctuation">,</span> <span class="token class-name">String</span> value2<span class="token punctuation">,</span>
        <span class="token class-name">Object</span> nullObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> value1 <span class="token operator">+</span> <span class="token string">"a"</span> <span class="token operator">+</span> value2 <span class="token operator">+</span> <span class="token string">"b"</span> <span class="token operator">+</span> value2 <span class="token operator">+</span> nullObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>With various input arguments, resulting string will be of 7, 17, 29, 75, 212,
1004 and 1006 characters long, which should cover a lot of use cases.</p>
<h4 id="what-to-test" style="position:relative;"><a href="#what-to-test" aria-label="what to test permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What to test</h4>
<p>Besides various input arguments there will be benchmarks for different kinds
of concatenation/formatting (all listed in this <a href="https://github.com/dkomanov/scala-string-format/blob/master/scala-string-format-core/src/test/scala/com/komanov/stringformat/FormatsTest.scala">test</a>):</p>
<ul>
<li>Java concatenation, as in code fragment above;</li>
<li><a href="http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/8u40-b25/java/lang/String.java#2927">String.format</a> method;</li>
<li>java.text.<a href="http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/8u40-b25/java/text/MessageFormat.java#MessageFormat">MessageFormat</a>;</li>
<li><a href="http://www.slf4j.org/">slf4j</a> message formatter (just because it’s a popular logging framework);</li>
<li>Scala concatenation;</li>
<li><a href="http://docs.scala-lang.org/overviews/core/string-interpolation.html#the-s-string-interpolator">s</a> string interpolator;</li>
<li><a href="http://docs.scala-lang.org/overviews/core/string-interpolation.html#the-f-interpolator">f</a> string interpolator;</li>
<li><a href="http://docs.scala-lang.org/overviews/core/string-interpolation.html#the-raw-interpolator">raw</a> string interpolator;</li>
<li>optimized concatenation 1 (with length precalculated);</li>
<li>optimized concatenation 2 (without copying of char array);</li>
<li>optimized concatenation via string interpolation + macros (soInterpolator);</li>
<li>super fast interpolation via macros (sfiInterpolator).</li>
</ul>
<h4 id="charts-and-tables" style="position:relative;"><a href="#charts-and-tables" aria-label="charts and tables permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Charts and tables</h4>
<p>As you can see, optimized concatenation works better on strings longer than
16 characters. String interpolations, based on macros (so and sfi), are the best.
Scala’s interpolations (s, f and raw) are slow, its performance lower than
regular string concatenation and approximately the same as slf4j.</p>
<p>The more convenient chart is <a href="/charts/scala-string-format/">here</a>.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/75a9537d7b91d7c82b94a830cabe5c0e/78958/string-formatting.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 45.4054054054054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAABaUlEQVQoz5WRz3LTMBDG/b68BsMD9BU4cIVTbx3KtGUYSA80TVTZ1HYbmjhxYksrxZa0qwUZpnDgwnfaP99vvtnZDACGYeD/UZzEzBkRPff/FnM0hkKI3lPfM7O3FgASjIh/TM/F3yHMUUqnFBmDQniKbtcqpYgowxCSgyg6l3zDQIjROdIaQ6CmCcwxz8dekbUopY/koT0cunEcM1ytfNumhRB+8qWQrgtF4Z3D+dzFGIsigKajpbzwHAH21toJrirXNAleLBwzSzkqhX0fim8JXi7TUCzk19x1enNx9X0/WON+3xyqCtsdHY8kBE5wMEBKxboO3tOdDMz86eL9uw/mqV2+frN8gNHqvp9uprpq83unwcxma0AW8/qupEP3eH6ptNXnZzf3W748fXvyclftv7x6cTW7ZWbEFJSxhe1DPQ5OV3J7gLBbr6qShrG8/qzA2lI8rtbUbsrbmVF2c/Pxad38+sJP+AfVYf2I98eY4AAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Different kind of string formatting performance, divided by resulting string length, nanos|wide"
        title="Different kind of string formatting performance, divided by resulting string length, nanos|wide"
        src="/static/75a9537d7b91d7c82b94a830cabe5c0e/50383/string-formatting.png"
        srcset="/static/75a9537d7b91d7c82b94a830cabe5c0e/1d79a/string-formatting.png 185w,
/static/75a9537d7b91d7c82b94a830cabe5c0e/1efb2/string-formatting.png 370w,
/static/75a9537d7b91d7c82b94a830cabe5c0e/50383/string-formatting.png 740w,
/static/75a9537d7b91d7c82b94a830cabe5c0e/73caa/string-formatting.png 1110w,
/static/75a9537d7b91d7c82b94a830cabe5c0e/78958/string-formatting.png 1320w"
        sizes="(max-width: 740px) 100vw, 740px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>Data table for a resulting string length 212:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Benchmark                                Score     Error  Units
javaConcat                             165.320 ±   0.578  ns/op
stringFormat                          1364.206 ±  19.899  ns/op
messageFormat                         1370.831 ±  11.360  ns/op
scalaConcat                            169.005 ±   1.481  ns/op
concatOptimized1                        94.336 ±   1.419  ns/op
concatOptimized2                       131.683 ±   4.288  ns/op
concatOptimizedMacros                   68.702 ±   3.256  ns/op
slf4j                                  275.377 ±  10.165  ns/op
sInterpolator                          268.072 ±  12.385  ns/op
fInterpolator                         1375.487 ±  10.255  ns/op
rawInterpolator                        271.416 ±   1.797  ns/op
sfiInterpolator                         58.674 ±   0.562  ns/op</code></pre></div>
<h2 id="curious-facts" style="position:relative;"><a href="#curious-facts" aria-label="curious facts permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Curious facts</h2>
<h3 id="s-interpolator-is-slow" style="position:relative;"><a href="#s-interpolator-is-slow" aria-label="s interpolator is slow permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>s interpolator is slow</h3>
<p>For me it was unexpected. I thought, such generic thing should work as fast as
possible, but…</p>
<p>Now, after my research, I understand, why it works so poorly. But I don’t
understand, why it wasn’t implemented on compiler level, or at least with macros.</p>
<p>Additionally, I’ve performed couple more tests:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">class</span> EmptyStringBenchmark <span class="token keyword">extends</span> BenchmarkBase <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Benchmark</span>
  <span class="token keyword">def</span> baseline<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">""</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Benchmark</span>
  <span class="token keyword">def</span> sInterpolator<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string-interpolation"><span class="token id function">s</span><span class="token string">""</span></span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Benchmark</span>
  <span class="token keyword">def</span> sfiInterpolator<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>komanov<span class="token punctuation">.</span>stringformat<span class="token punctuation">.</span>macros<span class="token punctuation">.</span></span>MacroConcat<span class="token punctuation">.</span>_
    <span class="token string-interpolation"><span class="token id function">sfi</span><span class="token string">""</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> ConstStringBenchmark <span class="token keyword">extends</span> BenchmarkBase <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Benchmark</span>
  <span class="token keyword">def</span> baseline<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"abc"</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Benchmark</span>
  <span class="token keyword">def</span> sInterpolator<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"abc"</span></span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Benchmark</span>
  <span class="token keyword">def</span> sfiInterpolator<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>komanov<span class="token punctuation">.</span>stringformat<span class="token punctuation">.</span>macros<span class="token punctuation">.</span></span>MacroConcat<span class="token punctuation">.</span>_
    <span class="token string-interpolation"><span class="token id function">sfi</span><span class="token string">"abc"</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>And the results:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Benchmark                               Score     Error  Units
EmptyStringBenchmark.baseline           2.899 ±   0.011  ns/op
EmptyStringBenchmark.sInterpolator     36.181 ±   0.083  ns/op &lt;---
EmptyStringBenchmark.sfiInterpolator    2.895 ±   0.009  ns/op
ConstStringBenchmark.baseline           2.897 ±   0.008  ns/op
ConstStringBenchmark.sInterpolator     48.307 ±   0.112  ns/op &lt;---
ConstStringBenchmark.sfiInterpolator    2.892 ±   0.006  ns/op</code></pre></div>
<p>Besides allocations of arrays, sInterpolator also processes constant strings
(non-arguments) to replace special characters. So, for constant string s“a\tb”
it will be even worse.</p>
<p>Macros do that processing during compilation time.</p>
<h3 id="other-scala-interpolators" style="position:relative;"><a href="#other-scala-interpolators" aria-label="other scala interpolators permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Other Scala interpolators</h3>
<p>According to documentation, fInterpolator is based on String.format. And its
performance actually correlates.</p>
<p>rawInterpolator don’t do any string processing, that’s why it’s slightly better
than sInterpolator.</p>
<h3 id="methodhandle-trick-is-not-working" style="position:relative;"><a href="#methodhandle-trick-is-not-working" aria-label="methodhandle trick is not working permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>MethodHandle trick is not working</h3>
<p>At the beginning, I’ve trusted to StackOverflow <a href="http://stackoverflow.com/questions/22244402/how-can-i-improve-performance-of-field-set-perhap-using-methodhandles">response</a>
about the performance of MethodHandle. But the only thing I noticed is a performance
degradation between concatOptimized1 and concatOptimized2
(StringBuilder.toString won over new String(shared_char_array)).</p>
<p>So, I’ve tested MethodHandle performance by myself, and I got “good” results:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Benchmark     Score     Error  Units
baseline      2.907 ±   0.021  ns/op
fastSb        8.213 ±   0.088  ns/op
fastString    5.129 ±   0.568  ns/op
newString   246.314 ±   3.909  ns/op
sbToString  253.588 ±   7.551  ns/op</code></pre></div>
<p><em>fastString</em> is an invocation of private constructor of String and <em>newString</em>
is an invocation of public constructor of String, that copies input char array.</p>
<p>But when I tested it on code like:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">val</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> StringBuilder<span class="token punctuation">(</span>len1 <span class="token operator">+</span> len2<span class="token punctuation">)</span>
  <span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
FastStringFactory<span class="token punctuation">.</span>fastNewString<span class="token punctuation">(</span>sb<span class="token punctuation">)</span></code></pre></div>
<p>I received performance degradation. Apparently, JVM doesn’t optimized it in
this case. Sadly.</p>
<p>But there is a lesson learned: don’t trust in microbenchmarks — verify!</p>
<h3 id="scalas-stringbuilder-is-slower" style="position:relative;"><a href="#scalas-stringbuilder-is-slower" aria-label="scalas stringbuilder is slower permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Scala’s StringBuilder is slower</h3>
<p>I even wrote a [small post]({% link _posts/2016-12-03-scala-stringbuilder-vs-java-stringbuilder-performance.md %})
about it. Despite the fact, that it’s a wrapper of java.lang.StringBuilder,
it’s significantly slower.</p>
<p>Btw, inside sInterpolator Java’s StringBuilder is used. Apparently, they knew it! :)</p>
<h3 id="they-know-that-javalangstringbuilder-is-better" style="position:relative;"><a href="#they-know-that-javalangstringbuilder-is-better" aria-label="they know that javalangstringbuilder is better permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>“They” know that java.lang.StringBuilder is better</h3>
<p>Scala concatenation (+ operator) works at the same performance as Java
concatenation <a href="https://github.com/scala/scala/pull/4737">since 2.12</a>.</p>
<p>And also sInterpolator uses java.lang.StringBuilder inside.</p>
<h3 id="better-performance-as-i-expected-for-sfiinterpolator" style="position:relative;"><a href="#better-performance-as-i-expected-for-sfiinterpolator" aria-label="better performance as i expected for sfiinterpolator permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Better performance as I expected for sfiInterpolator</h3>
<p>Inside sfiInterpolator implementation, I’ve decided to make it simple,
and I am not calculating the precise length for integer and just
preallocate 9 characters. And I’ve made a single test with Int.MAX_VALUE,
which requires 10 characters. I expected some significant performance degradation
since we need to reallocate buffer from 1004 to 2008 chars (yes, I actually
verified, that this reallocation happened). But, according to benchmarks,
there wasn’t any degradation. Which is really strange.</p>
<h2 id="conclusion" style="position:relative;"><a href="#conclusion" aria-label="conclusion permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conclusion</h2>
<p>Performance optimization is always a fun journey (at least for me): you read
code, reason about it, try to write an alternative solution, measure, analyze.
But, it’s not fun to realize, that such basic things aren’t optimized as it
could be. I don’t know the motivation (maybe just lack of time), but I’m
disappointed a bit.</p>
<p>Anyway, Scala has a powerful tool (macros), and it could be fixed.</p>
<hr>
<p>Test configuration:</p>
<ul>
<li>Ubuntu 16.04</li>
<li>Linux Kernel 4.4.0–51-generic</li>
<li>JDK 1.8.0_91</li>
<li>Scala Library 2.12</li>
<li>Hardware is Intel® Core™ i7–5600U CPU @ 2.60GHz × 4 (2 core + 2 HT) with 16 GB RAM</li>
</ul>
<p>As always, all code is on <a href="https://github.com/dkomanov/scala-string-format">GitHub</a>. Graphs and tables are <a href="/charts/scala-string-format/">here</a>. Comments, suggestions and blaming are welcome.</p>
<p>Originally posted on <a href="https://medium.com/@dkomanov/scala-string-interpolation-performance-21dc85e83afd">Medium</a>.</p></div></div><div class="blog-post-meta"><ul class="tags"><li class="cf"><a href="/posts/scala">scala</a></li><li class="cf"><a href="/posts/java">java</a></li><li class="cf"><a href="/posts/benchmark">benchmark</a></li><li class="cf"><a href="/posts/performance">performance</a></li><li class="cf"><a href="/posts/csharp">csharp</a></li></ul><hr/><div class="share-buttons"><button aria-label="twitter" class="react-share__ShareButton share-button" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="24" height="24"><rect width="64" height="64" rx="0" ry="0" fill="#00aced"></rect><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></svg></button><button aria-label="facebook" class="react-share__ShareButton share-button" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="24" height="24"><rect width="64" height="64" rx="0" ry="0" fill="#3b5998"></rect><path d="M34.1,47V33.3h4.6l0.7-5.3h-5.3v-3.4c0-1.5,0.4-2.6,2.6-2.6l2.8,0v-4.8c-0.5-0.1-2.2-0.2-4.1-0.2 c-4.1,0-6.9,2.5-6.9,7V28H24v5.3h4.6V47H34.1z" fill="white"></path></svg></button></div></div><footer>All content ©<!-- --> <a href="mailto:dkomanov@gmail.com">Dmitry Komanov</a>,<!-- --> <a href="/powered">powered by...</a></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/p/scala-string-interpolation-performance/";window.___webpackCompilationHash="add4dc4e95fedffe2259";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-f1d5be50dbe1d5fc9ecc.js"],"app":["/app-950ba0629bd69b2d2b4f.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-99a953a5d5072d737c00.js"],"component---src-pages-404-js":["/component---src-pages-404-js-d311d0c14a6bd17dfdcb.js"],"component---src-pages-charts-mysql-streaming-index-js":["/component---src-pages-charts-mysql-streaming-index-js-25aaae44df97202f7281.js"],"component---src-pages-charts-read-lines-index-js":["/component---src-pages-charts-read-lines-index-js-b87c91730bf5d4cc29f1.js"],"component---src-pages-charts-read-utf-8-index-js":["/component---src-pages-charts-read-utf-8-index-js-65f78bf0ddaa1e918dc1.js"],"component---src-pages-charts-region-matches-index-tsx":["/component---src-pages-charts-region-matches-index-tsx-10b5a10ab2b4f830b09f.js"],"component---src-pages-charts-scala-serialization-index-js":["/component---src-pages-charts-scala-serialization-index-js-918ec026ccaad391f6e7.js"],"component---src-pages-charts-scala-string-format-index-js":["/component---src-pages-charts-scala-string-format-index-js-777fb117f352dc73665f.js"],"component---src-pages-charts-set-map-java-vs-scala-index-tsx":["/component---src-pages-charts-set-map-java-vs-scala-index-tsx-fc2e745efd99a802fb62.js"],"component---src-pages-index-js":["/component---src-pages-index-js-89b9502773a9c85a5d28.js"],"component---src-templates-blog-by-tag-js":["/component---src-templates-blog-by-tag-js-4a20511be4b662e46145.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-72d890085c5bfd932504.js"],"component---src-templates-static-js":["/component---src-templates-static-js-1bfbee0247e4250c5e9c.js"],"component---src-templates-what-i-listen-list-tsx":["/component---src-templates-what-i-listen-list-tsx-78541c11d35977090566.js"],"component---src-templates-what-i-listen-single-episode-tsx":["/component---src-templates-what-i-listen-single-episode-tsx-7b2b201033a53beee2dd.js"],"component---src-templates-what-i-listen-tag-cloud-tsx":["/component---src-templates-what-i-listen-tag-cloud-tsx-327c66099e94fb90a770.js"],"component---src-templates-what-i-read-index-js":["/component---src-templates-what-i-read-index-js-491c475db57164b668a4.js"]};/*]]>*/</script><script src="/polyfill-f1d5be50dbe1d5fc9ecc.js" nomodule=""></script><script src="/app-950ba0629bd69b2d2b4f.js" async=""></script><script src="/framework-bf670a827ae315f850d0.js" async=""></script><script src="/webpack-runtime-915cac0aedf920a3fd5b.js" async=""></script></body></html>