{"componentChunkName":"component---src-templates-blog-post-js","path":"/p/the-cost-of-streaming-data-from-mysql/","result":{"data":{"markdownRemark":{"id":"00a20b09-0a03-5d10-9b3e-f207ad5fbd7e","excerpt":"Repost of my blog post in Wix Engineering Blog with some extra information. Cover image via pixabay. Though the question of “How to query data from a database…","html":"<blockquote>\n<p>Repost of my <a href=\"https://www.wix.engineering/post/the-cost-of-streaming-data-from-mysql\">blog post</a> in <a href=\"https://www.wix.engineering\">Wix Engineering Blog</a> with some <a href=\"#extra\">extra</a> information. Cover image via <a href=\"https://pixabay.com/en/mountains-road-night-evening-sky-691186/\">pixabay</a>.</p>\n</blockquote>\n<p>Though the question of “How to query data from a database?” is quite an old one, we still have a reason to investigate it nowadays. True, it is common to query a list of rows from a database since that usually means less code and configuration and it’s also the default approach. However, in certain scenarios, this method is just not optimal. In these cases, we don’t need all rows in memory right away, and sometimes we just can’t afford it.</p>\n<p>When addressing the issue of querying a significant amount of data, limited by your server capacity, you may have to go with one of the following solutions: Limiting row count could work, but you won’t get all the data; pagination is another solution. However, you’ll need to perform several queries instead of a single one; and finally, streaming seems like a good option as you still send a single query and receive all the data. However, with streaming, your single query has many underlying requests under the hood to MySQL DB, which may result in longer data processing time. Since requests are performed from a driver, it’s not related to MySQL DB storage engine.</p>\n<p>While looking into these solutions, I realized there weren’t any benchmark tests for streaming at all. So I decided to test the performance cost for streaming in JVM.</p>\n<h2 id=\"what-is-streaming\" style=\"position:relative;\"><a href=\"#what-is-streaming\" aria-label=\"what is streaming permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What is streaming</h2>\n<p>By default, MySQL Java drivers retrieve the data from the database all at once, and you get a ResultSet with all rows inside. On the <a href=\"http://dev.mysql.com/doc/connector-j/5.1/en/connector-j-reference-implementation-notes.html\">MySQL documentation</a>, it mentions the possibility of not retrieving data all at once - this is called <a href=\"http://stackoverflow.com/questions/2447324/streaming-large-result-sets-with-mysql\">streaming</a>.</p>\n<p>Note: all source code examples are in Scala.</p>\n<h3 id=\"heres-how-it-works\" style=\"position:relative;\"><a href=\"#heres-how-it-works\" aria-label=\"heres how it works permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Here’s how it works:</h3>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token comment\">// conn is java.sql.Connection</span>\n<span class=\"token keyword\">val</span> conn <span class=\"token operator\">=</span> getConnection<span class=\"token punctuation\">(</span>driver<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> st<span class=\"token operator\">:</span> java<span class=\"token punctuation\">.</span>sql<span class=\"token punctuation\">.</span>Statement <span class=\"token operator\">=</span> conn<span class=\"token punctuation\">.</span>createStatement<span class=\"token punctuation\">(</span>\n java<span class=\"token punctuation\">.</span>sql<span class=\"token punctuation\">.</span>ResultSet<span class=\"token punctuation\">.</span>TYPE_FORWARD_ONLY<span class=\"token punctuation\">,</span>\n java<span class=\"token punctuation\">.</span>sql<span class=\"token punctuation\">.</span>ResultSet<span class=\"token punctuation\">.</span>CONCUR_READ_ONLY\n<span class=\"token punctuation\">)</span>\nst<span class=\"token punctuation\">.</span>setFetchSize<span class=\"token punctuation\">(</span>Integer<span class=\"token punctuation\">.</span>MIN_VALUE<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">val</span> rs<span class=\"token operator\">:</span> java<span class=\"token punctuation\">.</span>sql<span class=\"token punctuation\">.</span>ResultSet <span class=\"token operator\">=</span> st<span class=\"token punctuation\">.</span>executeQuery<span class=\"token punctuation\">(</span><span class=\"token string\">\"SELECT * FROM table WHERE id = 123\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>When you configure the Statement like that on the executeQuery method call, you get a streaming ResultSet which contains only the first row. In this ResultSet, the next row will be loaded from a database only on the next method call.</p>\n<h3 id=\"when-is-it-applicable\" style=\"position:relative;\"><a href=\"#when-is-it-applicable\" aria-label=\"when is it applicable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>When is it applicable?</h3>\n<p>There are many use cases where you can use streaming besides data streaming: data migrations, <a href=\"http://knes1.github.io/blog/2015/2015-10-19-streaming-mysql-results-using-java8-streams-and-spring-data.html\">data export</a>, batch processing (when you need to provide rows one by one), and one particularly interesting to me - Event Sourcing.</p>\n<p>The straightforward way of getting an actual state of an object in event sourcing is to play all events from an event stream. However, because this is a fold operation and not all events are needed right away, you will need to apply events one by one.</p>\n<p>Common sense suggests that applying streaming to event sourcing cannot possibly be “free.” There should be some performance cost for it, otherwise, why do we need a special mode in the MySQL driver?</p>\n<h2 id=\"so-lets-test\" style=\"position:relative;\"><a href=\"#so-lets-test\" aria-label=\"so lets test permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>So… Let’s test!</h2>\n<p>Considering all the benefits, if we could determine that the cost isn’t very high, streaming would be a good solution for querying data. But in order to test the performance of streaming, we need to have something to compare it with.</p>\n<p>Obviously, we can’t compare a general use case of streaming, so instead, we will test getting a list of rows via streaming and via the default mode (getting everything at once). This should show us any overhead of the MySQL driver and additional network interaction between our application and the MySQL server.</p>\n<h3 id=\"how-to-test\" style=\"position:relative;\"><a href=\"#how-to-test\" aria-label=\"how to test permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How to test?</h3>\n<p>Let’s start with the actual test code. Have a look at the test code for default querying (selecting everything at once):</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">def</span> selectAtOnce<span class=\"token punctuation\">(</span>driver<span class=\"token operator\">:</span> MysqlDriver<span class=\"token punctuation\">,</span> limit<span class=\"token operator\">:</span> <span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> List<span class=\"token punctuation\">[</span>TestTableRow<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">val</span> st <span class=\"token operator\">=</span> getConnection<span class=\"token punctuation\">(</span>driver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>createStatement<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">val</span> rs <span class=\"token operator\">=</span> st<span class=\"token punctuation\">.</span>executeQuery<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token id function\">s</span><span class=\"token string\">\"SELECT id, name FROM </span><span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token expression\">TableName</span></span><span class=\"token string\"> LIMIT </span><span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token expression\">limit</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// at this point in rs we have all rows!</span>\n  <span class=\"token keyword\">val</span> result <span class=\"token operator\">=</span> mutable<span class=\"token punctuation\">.</span>ListBuffer<span class=\"token punctuation\">[</span>TestTableRow<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>rs<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n   result <span class=\"token operator\">+=</span> mapRow<span class=\"token punctuation\">(</span>rs<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  result<span class=\"token punctuation\">.</span>toList\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In the selectAtOnce method, we simply establish the connection to the database, select limit rows, and map it to the result list.\nThis is what the test code should look like so that the driver knows it should turn on streaming. The only distinction is the setFetchSite (Int.MinValue) method call, which makes all the difference:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">def</span> selectViaStreaming<span class=\"token punctuation\">(</span>driver<span class=\"token operator\">:</span> MysqlDriver<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> List<span class=\"token punctuation\">[</span>TestTableRow<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">val</span> st <span class=\"token operator\">=</span> getConnection<span class=\"token punctuation\">(</span>driver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>createStatement<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  st<span class=\"token punctuation\">.</span>setFetchSize<span class=\"token punctuation\">(</span><span class=\"token builtin\">Int</span><span class=\"token punctuation\">.</span>MinValue<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">val</span> rs <span class=\"token operator\">=</span> st<span class=\"token punctuation\">.</span>executeQuery<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token id function\">s</span><span class=\"token string\">\"SELECT id, name FROM </span><span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token expression\">TableName</span></span><span class=\"token string\"> LIMIT </span><span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token expression\">limit</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// in rs we don’t have any data until the next() method call</span>\n  <span class=\"token keyword\">val</span> result <span class=\"token operator\">=</span> mutable<span class=\"token punctuation\">.</span>ListBuffer<span class=\"token punctuation\">[</span>TestTableRow<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>rs<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n   result <span class=\"token operator\">+=</span> mapRow<span class=\"token punctuation\">(</span>rs<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  result<span class=\"token punctuation\">.</span>toList\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In selectViaStreaming, we do the same, but we hint the driver that we need the special streaming ResultSet. This ResultSet fetches data only on the next method call.</p>\n<h3 id=\"what-to-test\" style=\"position:relative;\"><a href=\"#what-to-test\" aria-label=\"what to test permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What To Test</h3>\n<p>Taking into account we have more than one driver for MySQL server, results may vary. After reading <a href=\"https://mariadb.org/on-performance-of-jdbc-drivers/\">another performance</a> test from MariaDB blog, I decided to test all three available drivers: <a href=\"https://dev.mysql.com/downloads/connector/j/\">ConnectorJ</a>, <a href=\"https://mariadb.com/kb/en/mariadb/about-mariadb-connector-j/\">MariaDB</a>, and <a href=\"https://github.com/krummas/DrizzleJDBC\">Drizzle</a>, but when I started testing, I discovered that Drizzle doesn’t support streaming - so only ConnectorJ and MariaDB remained relevant.</p>\n<p>For each driver, I ran two sets of tests: one for the default querying (.atOnce) and one for the streaming (.stream). Each set consisted of several test cases to query different amount of rows (via LIMIT clause); from 1 to 1000.</p>\n<p>To check the network influence, I performed tests in three different configurations:</p>\n<ul>\n<li>Benchmark and MySQL on the same server (local).</li>\n<li>Benchmark and MySQL on different servers connected through Wi-Fi (wifi = simulation of a “slow” network with ping greater than a millisecond).</li>\n<li>Benchmark and MySQL on different servers but connected through the wire (wire = fast network).</li>\n</ul>\n<h2 id=\"results\" style=\"position:relative;\"><a href=\"#results\" aria-label=\"results permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Results</h2>\n<p>Let’s take a look at the benchmark results.</p>\n<h3 id=\"local\" style=\"position:relative;\"><a href=\"#local\" aria-label=\"local permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Local</h3>\n<p>Times grows linearly with rows count. Apparently, there are no network problems - traffic on localhost is very fast.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9054d6c19ddad15b86369c839ecec351/5df5d/local.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.270270270270274%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAxklEQVQY01WP224DIQxE+f//bLvdRLuA14DvFSRp2nmwLGuOPU4RQcQi4ktm5i+t1iI8XlJ16gzHdXxD2SExs5kx8z844i/ApHC08+PMW8lbaScKdlNLAODuIvLrdnceQl3KDvkzl3urRx+lcWe3dxB3TyJiZsKsrHx12Gv5ynmr9d6o0QLeOXwyT3zCEWFm9VbqDa7cBw4a7Mtmrh7zc1U101VNRHRJRNLaEXM8T8yfeQxE5EHUR6kVABGRiFsbvbdH0gf8A5aUX7WH30J8AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Local|wide\"\n        title=\"Local|wide\"\n        src=\"/static/9054d6c19ddad15b86369c839ecec351/50383/local.png\"\n        srcset=\"/static/9054d6c19ddad15b86369c839ecec351/1d79a/local.png 185w,\n/static/9054d6c19ddad15b86369c839ecec351/1efb2/local.png 370w,\n/static/9054d6c19ddad15b86369c839ecec351/50383/local.png 740w,\n/static/9054d6c19ddad15b86369c839ecec351/73caa/local.png 1110w,\n/static/9054d6c19ddad15b86369c839ecec351/536c7/local.png 1480w,\n/static/9054d6c19ddad15b86369c839ecec351/5df5d/local.png 1572w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3 id=\"wi-fi-slow-network-with-latency\" style=\"position:relative;\"><a href=\"#wi-fi-slow-network-with-latency\" aria-label=\"wi fi slow network with latency permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wi-Fi (slow network with latency)</h3>\n<p>Since the network is unpredictable, it’s hard to see any reasonable correlation between streaming and non-streaming. However, in general, times grows linearly as well.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2d0f99aa42951162564bde289a9519f1/5d6a0/wifi.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.72972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA2ElEQVQY0zVQ7W4DMQi793/H/aw6dW3vkgvhy8B06WaBQMhYlrfMnEQRkQufZfXfJTOrsqoyE6oQrapAyLTN3VUVwD8vKjOqUiTnvHhZxJdUqIRbuoUwHaexbMzs7ohY2sVaiCrTEg5V3s/21v6i/d6lzdmkv7g/+ngOKDYAppoB2om6S6N+b8dtby8+3tyfpPtZPKE2TpjAFZEVy9FWVWa2397fX4/z56B2mpgq1MKx7FQhVgpXIIEA4KuwfZJwj1ipAK4qzPMzWmtjTCIywxgswtf/grv/AoKhXvcNTkRdAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"wifi|wide\"\n        title=\"wifi|wide\"\n        src=\"/static/2d0f99aa42951162564bde289a9519f1/50383/wifi.png\"\n        srcset=\"/static/2d0f99aa42951162564bde289a9519f1/1d79a/wifi.png 185w,\n/static/2d0f99aa42951162564bde289a9519f1/1efb2/wifi.png 370w,\n/static/2d0f99aa42951162564bde289a9519f1/50383/wifi.png 740w,\n/static/2d0f99aa42951162564bde289a9519f1/73caa/wifi.png 1110w,\n/static/2d0f99aa42951162564bde289a9519f1/536c7/wifi.png 1480w,\n/static/2d0f99aa42951162564bde289a9519f1/5d6a0/wifi.png 1580w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3 id=\"wire\" style=\"position:relative;\"><a href=\"#wire\" aria-label=\"wire permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wire</h3>\n<p>Here we see a stable difference between streaming and non-streaming. The performance of ConnectorJ’s atOnce is the best. The difference between streaming and non-streaming doesn’t seem to be significant. ConnectorJ’s difference for streaming decreases with more rows: from two times degrade with small amount of rows, to ten percent for hundreds of rows. Here we see a substantial difference between streaming and non-streaming.</p>\n<p>In the case of MariaDB the difference is insignificant. We may see the difference between streaming and non-streaming decreasing from two times for small amount of rows to tens of percent for big amount of rows.</p>\n<p>ConnectorJ’s non-streaming is slightly better than everything else.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d8bc4f3824ed966e7d438ab85c9c4f59/fde66/wire.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.270270270270274%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAxUlEQVQY011QW27DMAzL/S+6LelW27Kst7U5QYtg/KIEkSC1ZSazmNm8ISJmZlzDRfKOc6eyiSylqt60eSoilafoNE+TYFEkKlj33g6sn7U++gYAEWFmL9OZOdcpDOqKhdoB5cD6jWUH+OkMyJ2EzSw2M3V3xWEwtFM/Wvmo9Qvqk6CM0VnFVWOuHvNf9C0z3b3s7blDeSACs7ivIK8KuV4QEX7CzN5ku2xiWcci7iqMYyiLELVWARARRXQMJhpudhn9iX8BnhxfXLxpKUIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"wire|wide\"\n        title=\"wire|wide\"\n        src=\"/static/d8bc4f3824ed966e7d438ab85c9c4f59/50383/wire.png\"\n        srcset=\"/static/d8bc4f3824ed966e7d438ab85c9c4f59/1d79a/wire.png 185w,\n/static/d8bc4f3824ed966e7d438ab85c9c4f59/1efb2/wire.png 370w,\n/static/d8bc4f3824ed966e7d438ab85c9c4f59/50383/wire.png 740w,\n/static/d8bc4f3824ed966e7d438ab85c9c4f59/73caa/wire.png 1110w,\n/static/d8bc4f3824ed966e7d438ab85c9c4f59/536c7/wire.png 1480w,\n/static/d8bc4f3824ed966e7d438ab85c9c4f59/fde66/wire.png 1574w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>You can play with charts <a href=\"/charts/mysql-streaming\">here</a>.</p>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>As expected, streaming performance has a strong correlation with network bandwidth and latency. In the case of a local MySQL installation, the difference is insignificant, and times grows linearly with the row count for both drivers. For slow networks, it’s harder to distinguish between streaming and non-streaming, since network latency is unpredictable. In fast networks, the difference could indeed reach up to twice as long - but it decreases with the row count.</p>\n<p>So, if you have a local installation of a MySQL server or a powerful network between the application server and the MySQL server, then you may want to consider using streaming for your service from scratch. The difference in performance is not critical, plus you won’t need to worry about scaling so it won’t hurt your service reliability in the future.</p>\n<h3 id=\"testing-environment-or-how-i-tested-it\" style=\"position:relative;\"><a href=\"#testing-environment-or-how-i-tested-it\" aria-label=\"testing environment or how i tested it permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Testing Environment (or, how I tested it)</h3>\n<p>If you, like me, are interested in reviewing the test environment, here are a few words on the matter: I used <a href=\"http://openjdk.java.net/projects/code-tools/jmh/\">JMH tool</a> for running benchmarks, and all the results are pretty reproducible. I ran JMH benchmarks from a laptop with i7 2.6 GHz (2 cores) and 16GB of RAM. For wire configuration, I used AWS cloud with two micro instances (one for the server, and one for JHM benchmark).</p>\n<p>The use case for the event sourcing simulation is 1000 rows with unique ID’s and 200 bytes of payload (which is an average size for events that we have in projects at Wix).</p>\n<p>To test the correctness of my benchmark I used an open source library <a href=\"https://github.com/wix/wix-embedded-mysql\">wix-embedded-mysql</a>. It is a highly useful tool that enables you not to think about MySQL server installation (it downloads, runs, and shutdowns a real MySQL server instance in your test).</p>\n<p>You can check out my <a href=\"/charts/mysql-streaming\">GitHub repo</a> for more details.</p>\n<h2 id=\"extra\" style=\"position:relative;\"><a href=\"#extra\" aria-label=\"extra permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Extra</h2>\n<p>What I decided not to put in the original post is one annoyingly strange graph that I got several times on a wire (like 2 or 3 times in a row). But then I failed to reproduce it (I tried many times), but without success. JFYI…</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 740px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/356ef7007af6a362d0b74d50c5eb9bb6/5caea/weird.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.72972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAABLElEQVQoz3WRi47cIAxF8/9f2arKdifkAdhA8APvEmbSaaValsXjWudiJohx3dZlWbZtdc4xc/t/qPZq9syJmVXV3uKWjvXftReilpKdZ5tCCKNfrtC3uFB69fRKpCkpQENU5u5iGg038B+yWVO1UhqipdRqfUqGbJBlQG7e2NXaADoqZxV5nt92VPUi95vuzEytNZaWS4u9pz/vNQf7Y+ZlcAKIIjIOSSwVy7kRW3uNb+RFEmFRuabDwsSTquCG6HCdYf154OLL6vOnw/kBHy4te3ZHfuzpscPvPfxa4uzCvPofH9XHiYjwwGMJ3gVY93QE7yHG5DefIHsPADmGlHIt53nWwiKllEqUc57uz2U6IwIkrPVUIkAAhK6v7P0BEIkUYvL+QEQz+x7YF+CnSNB6It5dAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Weird case on wire\"\n        title=\"Weird case on wire\"\n        src=\"/static/356ef7007af6a362d0b74d50c5eb9bb6/50383/weird.png\"\n        srcset=\"/static/356ef7007af6a362d0b74d50c5eb9bb6/1d79a/weird.png 185w,\n/static/356ef7007af6a362d0b74d50c5eb9bb6/1efb2/weird.png 370w,\n/static/356ef7007af6a362d0b74d50c5eb9bb6/50383/weird.png 740w,\n/static/356ef7007af6a362d0b74d50c5eb9bb6/5caea/weird.png 996w\"\n        sizes=\"(max-width: 740px) 100vw, 740px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>My only assumption here was that there was something really strange with network and MariaDB went mad, but then same thing we would see on Wi-Fi chart.</p>","fields":{"slug":"/p/the-cost-of-streaming-data-from-mysql/"},"frontmatter":{"rawDate":"2017-09-18T00:00:00.000Z","date":"September 18, 2017","title":"The Cost of Streaming Data from MySQL","description":"How streaming from MySQL (on client side) affects performance comparing to non-streaming...","tags":["mysql","event sourcing","streaming","java","scala","connectorj","mariadb","embedded mysql"],"canonicalUrl":"https://www.wix.engineering/post/the-cost-of-streaming-data-from-mysql","cover":{"publicURL":"/static/bdd404a9d742ca9bb7cb80d6122c1a9a/cover.jpg"}}}},"pageContext":{"slug":"/p/the-cost-of-streaming-data-from-mysql/","previous":{"fields":{"slug":"/p/scala-string-interpolation-performance/"}},"next":{"fields":{"slug":"/p/performance-of-readline-in-jvm/"}}}},"staticQueryHashes":["3675711862"]}