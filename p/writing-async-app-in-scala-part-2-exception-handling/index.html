<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta data-react-helmet="true" name="twitter:description" content="How to propagate errors in async world? What are caveats of using exceptions in async programming? Use exceptions as a primary propagation mechanism while being on a safe side."/><meta data-react-helmet="true" name="twitter:title" content="Writing Async App in Scala. Part 2: Exception Handling"/><meta data-react-helmet="true" name="twitter:creator" content="Dmitry Komanov"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="og:type" content="website"/><meta data-react-helmet="true" name="og:description" content="How to propagate errors in async world? What are caveats of using exceptions in async programming? Use exceptions as a primary propagation mechanism while being on a safe side."/><meta data-react-helmet="true" name="og:title" content="Writing Async App in Scala. Part 2: Exception Handling"/><meta data-react-helmet="true" name="description" content="How to propagate errors in async world? What are caveats of using exceptions in async programming? Use exceptions as a primary propagation mechanism while being on a safe side."/><meta name="theme-color" content="#663399"/><meta name="generator" content="Gatsby 4.19.2"/><style data-href="/styles.29745ad4453b633c257a.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#000;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;text-shadow:0 1px #fff;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#b3d4fc;text-shadow:none}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{background:hsla(0,0%,100%,.5);color:#9a6e3a}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}article{border-bottom:1px solid #f2f2f0;padding:40px 0}article:last-child{border-bottom:0}article .post-title{display:block;font-size:28px;font-style:normal;font-weight:700;letter-spacing:-.02em;line-height:1.1;margin:0}article .post-teaser{float:left;height:100px;padding:0 10px 0 0;width:100px}article .post-description{color:#666665;font-size:20px;font-style:normal;font-weight:300;letter-spacing:-.02em;line-height:1.3}article .teaser-padding{margin-left:110px}article .post-meta{color:#b3b3b1;font-size:14px;line-height:30px}article .post-meta time{margin:0 1em 0 0;vertical-align:middle}ul.pagination{list-style:none;margin:1em 0 0;padding:0}ul.pagination li{color:#b3b3b1;float:left;padding:0 10px 0 0}ul.pagination li.active{font-weight:700}ul.pagination li a,ul.pagination li a:visited{color:#b3b3b1;text-decoration:none}.btn{background-color:transparent;border:none;cursor:pointer;display:inline;margin:0;outline:0;padding:0;text-decoration:underline}.btn:focus,.btn:hover{text-decoration:none}.table-toggler{text-align:center}.table-toggler a{border-bottom:1px dotted #000;cursor:pointer;font-size:.7em}.raw-data-table table{width:100%}.raw-data-table table th{background-color:rgba(0,0,0,.03)}.raw-data-table table .right{text-align:right}.markdown div.choose ul{margin:.5em 0 0;padding:0}.markdown div.choose ul li:first-child{border-radius:5px 0 0 5px}.markdown div.choose ul li:last-child{border-radius:0 5px 5px 0}.markdown div.choose ul li{background-color:rgba(0,0,0,.05);color:rgba(0,0,0,.68);cursor:pointer;line-height:1.4;margin:0;min-width:40px;padding:3px .5em;text-align:center}.markdown div.choose ul li:hover{background-color:rgba(0,0,0,.15)}.markdown div.choose ul li.active{background-color:rgba(0,0,0,.15);cursor:default}.markdown div.choose label{background-color:rgba(0,0,0,.05);color:rgba(0,0,0,.68);display:inline-block;font-size:23px;margin:0 .5em 0 0;padding:5px;vertical-align:bottom}body{text-rendering:optimizeLegibility;-webkit-font-feature-settings:"liga";font-feature-settings:"liga";font-family:Open Sans,MundoSans,Helvetica Neue,Arial,Helvetica,sans-serif;font-size:1.2em;margin:0;padding:0}a{color:#333332}a,a:hover{text-decoration:none}.cf:after{clear:both;content:"";display:table}ul.horizontal{display:inline-block;list-style:none;margin:0;padding:0;vertical-align:top}ul.horizontal li{float:left}.site-header{box-sizing:border-box;margin:0 auto;max-width:740px;padding:0;position:relative;top:-140px;width:100%;z-index:2}.site-header .site-logo{background-color:#fff;background-image:url(data:image/jpeg;base64,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);background-size:cover;border:3px solid #fff;border-radius:50%;box-shadow:0 1px 1px rgba(0,0,0,.3);height:120px;margin-right:-60px;position:absolute;right:50%;text-indent:-9999px;top:-60px;width:120px;z-index:99}.site-header .site-title{color:#fff;font-size:50px;font-weight:700;letter-spacing:-2px;line-height:50px;margin:0;outline:0;padding:84px 16px 8px;text-align:center;word-break:break-word}.site-header .site-description{color:#666;font-size:18px;font-weight:400;line-height:1.5;margin:0 0 20px;padding:0 32px;text-align:center}.site-content{box-sizing:border-box;margin:0 auto;max-width:740px;position:relative;top:-140px;width:100%}.wide-content{display:block;left:50%;margin-left:-48vw;margin-right:-48vw;position:relative;right:50%;width:96vw}@media only screen and (max-width:800px){.site-content{padding:0 32px}}.markdown{color:#333;width:100%}.markdown,.markdown h1,.markdown h2,.markdown h3{font-family:Linux Libertine,serif}.markdown h3,.markdown h4,.markdown h5,.markdown h6{font-family:Linux Libertine,serif;font-size:24px;font-style:normal;font-weight:700;letter-spacing:-.02em;line-height:1.3;margin:0 0 4px}.markdown h5,.markdown h6{font-family:Linux Libertine,serif;font-size:20px;font-style:normal;font-weight:500;letter-spacing:.02em;line-height:1.4;margin:0 0 3px;text-transform:uppercase}.markdown h1,.markdown h2{font-size:32px;font-style:normal;font-weight:700;letter-spacing:-.02em;line-height:1.2;margin-bottom:4px;padding-top:31px}.markdown p{color:#333;font-size:22px;font-style:normal;font-weight:400;-webkit-hyphens:auto;hyphens:auto;line-height:30px;margin:0;padding-bottom:30px}.markdown a{color:#333;text-decoration:underline}.markdown img{margin:0 auto;max-width:100%}.markdown figure{margin:0;padding:0 0 30px}.markdown figcaption{color:#666665;font-size:16px;font-style:italic;font-weight:400;line-height:1.3;outline:0;text-align:center;z-index:300}.markdown hr{border:0;border-top:1px solid #ddd;display:block;margin:30px auto;padding:0;width:15%}.markdown blockquote,.markdown li blockquote{border-left:3px solid #57ad68;margin:0 0 30px -26px;padding-left:20px}.markdown blockquote p,.markdown li blockquote p{border-left:3px solid #57ad68;font-style:italic;font-weight:400;letter-spacing:.01rem;margin-left:-26px;padding-bottom:3px;padding-left:20px}.markdown ol,.markdown ul{margin:0;padding:0 0 30px}.markdown li{font-size:23px;font-style:normal;font-weight:400;line-height:30px;margin-bottom:12px;margin-left:30px;padding:2px 0 0}.markdown li p{padding:0 0 1.618rem}.markdown ol li{list-style-type:decimal}.markdown code{font-family:Courier,monospace;font-size:16px}.markdown.tiny *{font-size:16px;line-height:1.2em}.markdown.tiny ul{padding:0}.markdown.tiny ul li{margin-bottom:0}footer{color:#999;font-size:12px;line-height:17.6px;margin:0 auto;max-width:640px;padding:22px 0;text-align:center;width:100%}footer a{color:#666;text-decoration:none}footer a:hover{color:#333}.share-buttons{display:inline-block}.share-buttons .share-button{display:inline-block;margin:0 0 0 .5em;text-align:center;vertical-align:top}.site-menu{color:#ccc;margin:0 0 50px;text-align:center}.site-menu a{color:#999;padding-left:20px;text-decoration:none}.site-menu a:hover{color:#333}.site-menu a.active{font-weight:700}.tag-cloud a{margin:6px}ul.tags{display:inline-block;list-style:none;margin:0;padding:0;vertical-align:top}ul.tags li{background-color:rgba(0,0,0,.05);border-radius:3px;float:left;line-height:1.4;margin:4px .5em 0 0;padding:3px 5px}ul.tags li:hover{background-color:rgba(0,0,0,.15)}ul.tags li.label{padding:0 .5em 0 0}ul.tags li a,ul.tags li a:visited{color:rgba(0,0,0,.68);text-decoration:none}.teaser-image{background-color:#000;height:360px;overflow:hidden;position:relative}.teaser-image_image{background-position:50%;background-size:cover;bottom:0;left:0;position:absolute;right:0;text-indent:-9999px;top:0;z-index:1}.time-units p.small{margin:0 0 10px}.time-units small{color:rgba(0,0,0,.3);font-size:11px}.site-content.no-cover{position:relative;top:0}.no-cover .post-meta{padding-top:60px}.no-cover .post-title{color:#333332;font-size:50px;font-style:normal;font-weight:700;letter-spacing:-.04em;line-height:1.1;margin-bottom:16px}.no-cover .author-image{background-image:url(/img/top-logo.jpg);background-size:cover;border-radius:100%;display:inline-block;float:left;height:30px;line-height:30px;margin-bottom:-10px;margin-right:8px;text-indent:-9999px;width:30px}.no-cover .author-name{display:inline}.no-cover .post-meta-text{color:#b3b3b1;font-size:14px;font-style:normal;font-weight:400;letter-spacing:-.02em;text-overflow:ellipsis;white-space:nowrap}.blog-post-meta{color:#b3b3b1}ul.what-i-read{list-style-type:none;margin:0;padding:0}ul.what-i-read>li{display:inline-block;padding:0 10px 0 0}</style><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="alternate" type="application/rss+xml" title="Severe Software Developer Blog" href="/rss.xml"/><link rel="icon" href="/favicon-32x32.png?v=994a873755adc623fbc44f1a9a107c69" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=994a873755adc623fbc44f1a9a107c69"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=994a873755adc623fbc44f1a9a107c69"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=994a873755adc623fbc44f1a9a107c69"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=994a873755adc623fbc44f1a9a107c69"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=994a873755adc623fbc44f1a9a107c69"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=994a873755adc623fbc44f1a9a107c69"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=994a873755adc623fbc44f1a9a107c69"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=994a873755adc623fbc44f1a9a107c69"/><title data-react-helmet="true">Writing Async App in Scala. Part 2: Exception Handling | @dkomanov</title><link data-react-helmet="true" rel="canonical" href="https://medium.com/@dkomanov/writing-async-app-in-scala-part-2-exception-handling-3fba8504c6fa"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><div class="teaser-image"><div class="teaser-image_image" style="background-image:url(/static/14b5b1138b468c35a2fd98477678aa23/cover.jpg);transform:translate3d(0px, 0px, 0px);opacity:1">Teaser Image</div></div><header class="site-header"><a class="site-logo" href="/">@dkomanov</a><h1 class="site-title">@dkomanov</h1><div class="site-description">Severe Software Developer Blog</div><div class="site-menu"><a href="/">Blog</a><a href="/what-i-read">What I Read</a><a href="/what-i-listen">What I Listen</a><a href="/about">About</a></div></header><div class="site-content"><div class="blog-post" itemscope="" itemType="http://schema.org/Article"><h1>Writing Async App in Scala. Part 2: Exception Handling</h1><div class="markdown " role="main"><blockquote>
<p>In this part we will cover the exception handling for async programming in Scala with Futures. <br>
<a href="/p/writing-async-app-in-scala-part-1-coding">Part 1. Coding.</a> <br>
Part 2. Exception Handling. <br>
<a href="/p/writing-async-app-in-scala-part-3-threading-model">Part 3. Threading Model.</a> <br>
Part 4. Rewrite Blocking App. <br>
Part 5. What’s next?</p>
</blockquote>
<p>I deliberately named this part as “Exception Handling”. There are different error handling models: exceptions, error codes, returning <a href="https://www.adtran.com/index.php/blog/technology-blog/255-asynchronous-functional-error-handling-in-scala">Either</a> of business result or some kind of error etc. I’m not going to describe all possible options here, I decided to use exceptions (or, to better put it, <code class="language-text">Future.failed</code> with exception inside) as a error propagation mechanism, mainly because:</p>
<ol>
<li>Familiarity. We all use exceptions in pre-async non-functional world.</li>
<li>It’s impossible to turn off exceptions in JVM, so it will be a part of <code class="language-text">Future</code> anyway.</li>
<li>Simplicity. It doesn’t require to build any kind of rich system for error handling, there is one out of the box.</li>
</ol>
<p>Future is like <a href="https://www.scala-lang.org/api/2.12.10/scala/util/Try.html">Try</a> in terms of exception handling: all methods of Future do catch exceptions and transforms Future into <a href="https://www.scala-lang.org/api/2.12.10/scala/concurrent/Future$.html#failed%5BT%5D(exception:Throwable):scala.concurrent.Future%5BT%5D">failed</a> Future. Except for the <code class="language-text">onComplete</code> and <code class="language-text">foreach</code> methods, exception from your callback will return in propagation to the <a href="https://www.scala-lang.org/api/2.12.10/scala/concurrent/ExecutionContext.html#reportFailure(cause:Throwable):Unit">reportFailure</a> of your <a href="https://www.scala-lang.org/api/2.12.10/scala/concurrent/ExecutionContext.html">ExecutionContext</a>. So, it’s safe to throw an exception in all functions that you pass to Future (map, flatMap etc.).</p>
<p>However, there’s a caveat…</p>
<h2 id="the-great-caveat" style="position:relative;"><a href="#the-great-caveat" aria-label="the great caveat permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The Great Caveat</h2>
<p>Whenever it’s declared that a function returns <code class="language-text">Future</code>, there is an assumption, that function can’t throw an exception — it returns a Future that eventually will be successful or failed. The compiler doesn’t enforce such an assumption, and it’s possible that this task is too complicated without too much of a boilerplate code. Also it could be even annoying, because in most of the application code it doesn’t matter whether a function actually throws an exception or returns a failed Future, but not always.</p>
<p>When you’re in a Future’s execution lifecycle, meaning calling methods of existing Future object like <code class="language-text">map</code>, <code class="language-text">flatMap</code> and <code class="language-text">transform</code>, you’re safe in terms of exceptions:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala">Future<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span>map<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span>_ <span class="token keyword">=></span> <span class="token keyword">throw</span> <span class="token keyword">new</span> IllegalArgumentException<span class="token punctuation">)</span>
  <span class="token punctuation">.</span>flatMap<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span>_ <span class="token keyword">=></span> <span class="token keyword">throw</span> <span class="token keyword">new</span> IllegalStateException<span class="token punctuation">)</span>
<span class="token comment">// Effectively: Future.failed(new IllegalArgumentException)</span></code></pre></div>
<p>But outside of this lifecycle there may be a problem:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">def</span> innocentFunction<span class="token punctuation">(</span>param<span class="token operator">:</span> <span class="token builtin">AnyRef</span><span class="token punctuation">)</span><span class="token operator">:</span> Future<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  require<span class="token punctuation">(</span>param <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
  Future<span class="token punctuation">.</span>successful<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

innocentFunction<span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span>map<span class="token punctuation">(</span>_ <span class="token keyword">=></span> <span class="token keyword">throw</span> <span class="token keyword">new</span> IllegalStateException<span class="token punctuation">)</span>
<span class="token comment">// an IllegalArgumentException will be thrown before map call</span></code></pre></div>
<p>It’s very important to be cautious in, let’s call it, entry points. Whenever you’re outside of Future’s execution lifecycle. Usually, a web framework covers most of your application code — it provides and entry point like this for you:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">def</span> rpcFunction<span class="token punctuation">(</span>param<span class="token operator">:</span> <span class="token builtin">AnyRef</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">implicit</span> ec<span class="token operator">:</span> ExecutionContext<span class="token punctuation">)</span><span class="token operator">:</span> Future<span class="token punctuation">[</span><span class="token builtin">AnyRef</span><span class="token punctuation">]</span></code></pre></div>
<p>And inside such function it’s safe to throw exceptions, because the framework does <code class="language-text">try..catch</code> for you (usually). But sometimes you need to escape from this lifecycle. This is obviously an edge case, vast majority of the code is usually within safe boundaries.</p>
<h2 id="exploring-an-edge-case" style="position:relative;"><a href="#exploring-an-edge-case" aria-label="exploring an edge case permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Exploring an edge case</h2>
<p>I’ll give you an example. Suppose, we have an HttpRequest and we have caching layers (memcached and CDN) and a fallback to a Hadoop calculation (which takes a long time):</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">case</span> <span class="token keyword">class</span> HttpRequest<span class="token punctuation">(</span>uri<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> handleFromMemcached<span class="token punctuation">(</span>r<span class="token operator">:</span> HttpRequest<span class="token punctuation">)</span><span class="token operator">:</span> Future<span class="token punctuation">[</span>Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  require<span class="token punctuation">(</span>r<span class="token punctuation">.</span>uri <span class="token operator">!=</span> <span class="token string">"/memcached-boom"</span><span class="token punctuation">,</span> <span class="token string">"Memcached Boom!"</span><span class="token punctuation">)</span>
  Future<span class="token punctuation">.</span>successful<span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>uri <span class="token operator">==</span> <span class="token string">"/memcached"</span><span class="token punctuation">)</span> Some<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span> <span class="token keyword">else</span> None<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">def</span> handleFromCdn<span class="token punctuation">(</span>r<span class="token operator">:</span> HttpRequest<span class="token punctuation">)</span><span class="token operator">:</span> Future<span class="token punctuation">[</span>Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  require<span class="token punctuation">(</span>r<span class="token punctuation">.</span>uri <span class="token operator">!=</span> <span class="token string">"/cnd-boom"</span><span class="token punctuation">,</span> <span class="token string">"CDN Boom!"</span><span class="token punctuation">)</span>
  Future<span class="token punctuation">.</span>successful<span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>uri <span class="token operator">==</span> <span class="token string">"/cdn"</span><span class="token punctuation">)</span> Some<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span> <span class="token keyword">else</span> None<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">def</span> handleFromHadoop<span class="token punctuation">(</span>r<span class="token operator">:</span> HttpRequest<span class="token punctuation">)</span><span class="token operator">:</span> Future<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span>
  Future<span class="token punctuation">.</span>successful<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> handle<span class="token punctuation">(</span>r<span class="token operator">:</span> HttpRequest<span class="token punctuation">)</span><span class="token operator">:</span> Future<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// suppose here we're inside Future's execution lifecycle, so it's safe to throw exceptions.</span>
  handleFromMemcached<span class="token punctuation">(</span>r<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>flatMap <span class="token punctuation">{</span> memcachedResult <span class="token keyword">=></span>
      memcachedResult<span class="token punctuation">.</span>fold <span class="token punctuation">{</span>
        handleFromCdn<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">.</span>flatMap <span class="token punctuation">{</span> cdnResult <span class="token keyword">=></span>
          cdnResult<span class="token punctuation">.</span>fold <span class="token punctuation">{</span>
            handleFromHadoop<span class="token punctuation">(</span>r<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">(</span>Future<span class="token punctuation">.</span>successful<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">(</span>Future<span class="token punctuation">.</span>successful<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>And then:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala">handle<span class="token punctuation">(</span>HttpRequest<span class="token punctuation">(</span><span class="token string">"/memcached-boom"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// will throw IllegalArgumentException("Memcached Boom!")</span></code></pre></div>
<p>The call itself will throw an exception, but the “framework” code usually wraps it in <code class="language-text">try..catch</code>, so it will be handled correctly. Ok, this code works, but the implementation of the <code class="language-text">handle</code> method is eye-bleeding: imagine we have 10 caching layers (or just intermediate calculations that we would like to reuse), it would be a nesting hell. Instead it would be nice to have something like this:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">val</span> handlers<span class="token operator">:</span> List<span class="token punctuation">[</span>HttpRequest <span class="token keyword">=></span> Future<span class="token punctuation">[</span>Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> List<span class="token punctuation">(</span>
  handleFromMemcached<span class="token punctuation">,</span>
  handleFromCdn<span class="token punctuation">,</span>
  r <span class="token keyword">=></span> handleFromHadoop<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>Some<span class="token punctuation">.</span>apply<span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">def</span> handle<span class="token punctuation">(</span>r<span class="token operator">:</span> HttpRequest<span class="token punctuation">)</span><span class="token operator">:</span> Future<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  executeLazily<span class="token punctuation">(</span>handlers<span class="token punctuation">.</span>map<span class="token punctuation">(</span>handler <span class="token keyword">=></span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">=></span> handler<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span><span class="token keyword">throw</span> <span class="token keyword">new</span> IllegalStateException<span class="token punctuation">(</span><span class="token string">"Hadoop should always return Some!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">def</span> executeLazily<span class="token punctuation">(</span>list<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">=></span> Future<span class="token punctuation">[</span>Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Future<span class="token punctuation">[</span>Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">]</span></code></pre></div>
<p>Let’s implement this <code class="language-text">executeLazily</code> function in a generic manner:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">def</span> executeLazily<span class="token punctuation">[</span>Argument<span class="token punctuation">,</span> Return<span class="token punctuation">]</span><span class="token punctuation">(</span>argument<span class="token operator">:</span> Argument<span class="token punctuation">,</span>
                                    list<span class="token operator">:</span> List<span class="token punctuation">[</span>Argument <span class="token keyword">=></span> Future<span class="token punctuation">[</span>Option<span class="token punctuation">[</span>Return<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                                   <span class="token punctuation">(</span><span class="token keyword">implicit</span> ec<span class="token operator">:</span> ExecutionContext<span class="token punctuation">)</span><span class="token operator">:</span> Future<span class="token punctuation">[</span>Option<span class="token punctuation">[</span>Return<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">val</span> promise <span class="token operator">=</span> Promise<span class="token punctuation">[</span>Option<span class="token punctuation">[</span>Return<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">val</span> iterator <span class="token operator">=</span> list<span class="token punctuation">.</span>iterator

  <span class="token keyword">def</span> completeWith<span class="token punctuation">(</span>t<span class="token operator">:</span> Try<span class="token punctuation">[</span>Option<span class="token punctuation">[</span>Return<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> t <span class="token keyword">match</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> Success<span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token keyword">=></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>isDefined <span class="token operator">||</span> <span class="token operator">!</span>iterator<span class="token punctuation">.</span>hasNext<span class="token punctuation">)</span>
        promise<span class="token punctuation">.</span>success<span class="token punctuation">(</span>value<span class="token punctuation">)</span>
      <span class="token keyword">else</span>
        <span class="token comment">//             ↓ DANGER IS HERE</span>
        iterator<span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>apply<span class="token punctuation">(</span>argument<span class="token punctuation">)</span><span class="token punctuation">.</span>onComplete<span class="token punctuation">(</span>completeWith<span class="token punctuation">)</span>

    <span class="token keyword">case</span> Failure<span class="token punctuation">(</span>exception<span class="token punctuation">)</span> <span class="token keyword">=></span>
      promise<span class="token punctuation">.</span>failure<span class="token punctuation">(</span>exception<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  completeWith<span class="token punctuation">(</span>Success<span class="token punctuation">(</span>None<span class="token punctuation">)</span><span class="token punctuation">)</span>

  promise<span class="token punctuation">.</span>future
<span class="token punctuation">}</span></code></pre></div>
<p>Here we create a Promise and resolve it once we encounter an exception or the Some result. But the problem here is that we use <code class="language-text">onComplete</code> method, which means that we escape the boundaries of the execution lifecycle, and exception in a callback of the <code class="language-text">onComplete</code> method will be propagated to ExecutionContext, not to the instance of Future. And this is something that we should keep in mind. So, with this implementation this will lead to a biiig problem:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala">handle<span class="token punctuation">(</span>HttpRequest<span class="token punctuation">(</span><span class="token string">"/cdn-boom"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>And it’s quite severe, because the framework will get the Future from our <code class="language-text">handle</code> method, but this Future won’t be resolved ever. And this, depending on defined timeouts, throttling and load could lead to something really bad (OutOfMemory, elevated response times etc.)</p>
<h2 id="more-trivial-example" style="position:relative;"><a href="#more-trivial-example" aria-label="more trivial example permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>More Trivial Example</h2>
<p>Actually, there is a simpler case for showing why an async application shouldn’t throw exceptions but only return it as failed futures.</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">def</span> rpcCall<span class="token operator">:</span> Future<span class="token punctuation">[</span>Option<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span>
<span class="token keyword">def</span> reportException<span class="token punctuation">(</span>e<span class="token operator">:</span> Throwable<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> getUrlSafe<span class="token operator">:</span> Future<span class="token punctuation">[</span>Option<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  rpcCall<span class="token punctuation">.</span>recover <span class="token punctuation">{</span>
    <span class="token keyword">case</span> e<span class="token operator">:</span> Throwable <span class="token keyword">=></span>
      reportException<span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      None
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>As you may see, if the <code class="language-text">rpcCall</code> function will throw an exception, this method won’t work as expected. Instead of falling back to <code class="language-text">None</code> it will rethrow an exception. Most likely, at the end it will be properly wrapped in <code class="language-text">Future.failed</code> or handled by the framework. But the end result would be undesired.</p>
<h2 id="how-to-safely-create-futures" style="position:relative;"><a href="#how-to-safely-create-futures" aria-label="how to safely create futures permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How to safely create futures?</h2>
<p>There are couple solutions.</p>
<h3 id="train-alertness" style="position:relative;"><a href="#train-alertness" aria-label="train alertness permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Train Alertness</h3>
<p>One is to pay extra attention to places in your code, when execution is going outside of the Future’s execution context: whenever you’re using the <code class="language-text">onComplete</code> method or creating a <code class="language-text">Promise</code> that will be completed asynchronously, etc.</p>
<p>In our case, fix this line:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala">iterator<span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>apply<span class="token punctuation">(</span>argument<span class="token punctuation">)</span><span class="token punctuation">.</span>onComplete<span class="token punctuation">(</span>completeWith<span class="token punctuation">)</span></code></pre></div>
<p>To something like this:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">try</span> <span class="token punctuation">{</span>
  iterator<span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>apply<span class="token punctuation">(</span>argument<span class="token punctuation">)</span><span class="token punctuation">.</span>onComplete<span class="token punctuation">(</span>completeWith<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> NonFatal<span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token keyword">=></span> promise<span class="token punctuation">.</span>failure<span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>As you may see, we added <code class="language-text">try..catch</code> block here in order to prevent a possibility of an unhandled exception when we call <code class="language-text">apply</code> method: if it throws we’ll just resolve a <code class="language-text">Promise</code> with the exception and it will be propagated further.</p>
<h3 id="put-some-boilerplate-everywhere" style="position:relative;"><a href="#put-some-boilerplate-everywhere" aria-label="put some boilerplate everywhere permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Put some boilerplate everywhere</h3>
<p>Another angle to handle this problem is a kind of defensive programming: minimize possibility of raising an exception. By using an utility function we may wrap all functions that produces a <code class="language-text">Future</code>:</p>
<div class="gatsby-highlight" data-language="scala"><pre class="language-scala"><code class="language-scala"><span class="token keyword">def</span> safeFuture<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span>f<span class="token operator">:</span> <span class="token keyword">=></span> Future<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Future<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    f
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> NonFatal<span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token keyword">=></span> Future<span class="token punctuation">.</span>failed<span class="token punctuation">(</span>e<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">def</span> handleFromMemcached<span class="token punctuation">(</span>r<span class="token operator">:</span> HttpRequest<span class="token punctuation">)</span><span class="token operator">:</span> Future<span class="token punctuation">[</span>Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> safeFuture <span class="token punctuation">{</span>
  require<span class="token punctuation">(</span>r<span class="token punctuation">.</span>uri <span class="token operator">!=</span> <span class="token string">"/memcached-boom"</span><span class="token punctuation">,</span> <span class="token string">"Memcached Boom!"</span><span class="token punctuation">)</span>
  Future<span class="token punctuation">.</span>successful<span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>uri <span class="token operator">==</span> <span class="token string">"/memcached"</span><span class="token punctuation">)</span> Some<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span> <span class="token keyword">else</span> None<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>And now, this function will never throw an exception, but return a failed Future instead.</p>
<h2 id="conclusion" style="position:relative;"><a href="#conclusion" aria-label="conclusion permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conclusion</h2>
<p>As you may see, none of these approaches is error-prone, it’s very easy to forget to use <code class="language-text">safeFuture</code> or miss an <code class="language-text">onComplete</code> call somewhere in a codebase. Both compiler and IDE won’t help you to identify this problem.</p>
<p>It’s important to be very conscious about leaving safe boundaries of the application in terms of an exception handling. Whenever you use <code class="language-text">onComplete</code>/<code class="language-text">foreach</code> or <code class="language-text">Promise</code> (or some callback of a third party library), it’s a good indicator that you should be extra careful and pay attention.</p>
<p>Also, in my opinion, exceptions aren’t good (to say the least) for async programming specifically, as stack trace is mostly useless (I’ll back to this point in the next part), creation of an exception is a bit expensive and we don’t really utilize in Scala all its power. However, exceptions are embedded in JVM and <code class="language-text">Future</code>, so it’s just seems too much of a burden not to use it in given circumstances.</p>
<p>All code is available on <a href="https://github.com/dkomanov/stuff/tree/master/src/com/komanov/future">GitHub</a>. Originally posted on <a href="https://medium.com/@dkomanov/writing-async-app-in-scala-part-2-exception-handling-3fba8504c6fa">Medium</a>. <a href="https://pixabay.com/photos/building-control-panel-controls-1853330/">Image</a> by <a href="https://pixabay.com/users/Pexels-2286921/?utm_source=link-attribution&#x26;utm_medium=referral&#x26;utm_campaign=image&#x26;utm_content=1853330">Pexels</a> from <a href="https://pixabay.com/?utm_source=link-attribution&#x26;utm_medium=referral&#x26;utm_campaign=image&#x26;utm_content=1853330">Pixabay</a>.</p></div></div><div class="blog-post-meta"><ul class="tags"><li class="cf"><a href="/posts/scala">scala</a></li><li class="cf"><a href="/posts/async">async</a></li><li class="cf"><a href="/posts/exception">exception</a></li><li class="cf"><a href="/posts/error">error</a></li></ul><hr/><div class="share-buttons"><button aria-label="twitter" class="react-share__ShareButton share-button" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="24" height="24"><rect width="64" height="64" rx="0" ry="0" fill="#00aced"></rect><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></svg></button><button aria-label="facebook" class="react-share__ShareButton share-button" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="24" height="24"><rect width="64" height="64" rx="0" ry="0" fill="#3b5998"></rect><path d="M34.1,47V33.3h4.6l0.7-5.3h-5.3v-3.4c0-1.5,0.4-2.6,2.6-2.6l2.8,0v-4.8c-0.5-0.1-2.2-0.2-4.1-0.2 c-4.1,0-6.9,2.5-6.9,7V28H24v5.3h4.6V47H34.1z" fill="white"></path></svg></button></div></div></div><footer>All content ©<!-- --> <a href="mailto:dkomanov@gmail.com">Dmitry Komanov</a>,<!-- --> <a href="/powered">powered by...</a></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/p/writing-async-app-in-scala-part-2-exception-handling/";window.___webpackCompilationHash="b1fc2d9c79964ae3f6fe";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-f1d5be50dbe1d5fc9ecc.js"],"app":["/app-1125d9f16e02153a630b.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-99a953a5d5072d737c00.js"],"component---src-pages-404-js":["/component---src-pages-404-js-d44cf7e9bb2d0952e916.js"],"component---src-pages-charts-mysql-streaming-index-js":["/component---src-pages-charts-mysql-streaming-index-js-72c5e6e52b23a4a15e4c.js"],"component---src-pages-charts-offheap-array-index-tsx":["/component---src-pages-charts-offheap-array-index-tsx-689b09c4ba28987da516.js"],"component---src-pages-charts-read-lines-index-js":["/component---src-pages-charts-read-lines-index-js-e6cdb0747a14c2924012.js"],"component---src-pages-charts-read-utf-8-index-js":["/component---src-pages-charts-read-utf-8-index-js-d7e85260faff494b5c73.js"],"component---src-pages-charts-region-matches-index-tsx":["/component---src-pages-charts-region-matches-index-tsx-4cbfd529465bdaf97151.js"],"component---src-pages-charts-scala-serialization-index-js":["/component---src-pages-charts-scala-serialization-index-js-f9cbac41632bd6c2eb6e.js"],"component---src-pages-charts-scala-string-format-index-js":["/component---src-pages-charts-scala-string-format-index-js-820e39088937b968584a.js"],"component---src-pages-charts-set-map-java-vs-scala-index-tsx":["/component---src-pages-charts-set-map-java-vs-scala-index-tsx-1060dbf0e10300ab0eea.js"],"component---src-pages-index-js":["/component---src-pages-index-js-8fe38c0463f550eb8e69.js"],"component---src-templates-blog-by-tag-js":["/component---src-templates-blog-by-tag-js-8ae480b5dd789207d0ea.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-1650ae1603ee7f3fc229.js"],"component---src-templates-static-js":["/component---src-templates-static-js-140a67808cc96096b7ec.js"],"component---src-templates-what-i-listen-list-tsx":["/component---src-templates-what-i-listen-list-tsx-3db1c676da95f417dd87.js"],"component---src-templates-what-i-listen-single-episode-tsx":["/component---src-templates-what-i-listen-single-episode-tsx-c14377bb76c9f41543d9.js"],"component---src-templates-what-i-listen-tag-cloud-tsx":["/component---src-templates-what-i-listen-tag-cloud-tsx-9c9b40199aae5d0bf72a.js"],"component---src-templates-what-i-read-index-js":["/component---src-templates-what-i-read-index-js-eafa8980baa0072ad611.js"]};/*]]>*/</script><script src="/polyfill-f1d5be50dbe1d5fc9ecc.js" nomodule=""></script><script src="/app-1125d9f16e02153a630b.js" async=""></script><script src="/framework-bf670a827ae315f850d0.js" async=""></script><script src="/webpack-runtime-167d587010f616d5951b.js" async=""></script></body></html>