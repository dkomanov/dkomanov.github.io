{"componentChunkName":"component---src-templates-blog-post-js","path":"/p/scala-serialization/","webpackCompilationHash":"e9a3c8de1caff5b4a577","result":{"data":{"markdownRemark":{"id":"71287409-a699-5014-9ac5-22488ce7a236","excerpt":"UPD: Recent benchmark charts are here. It’s common to use JSON as the main format of serialized data.\nIt’s very convenient to use it both on client and server…","html":"<p><em>UPD</em>: Recent benchmark charts are <a href=\"/charts/scala-serialization/\">here</a>.</p>\n<p>It’s common to use <a href=\"http://json.org/\">JSON</a> as the main format of serialized data.\nIt’s very convenient to use it both on client and server. Obviously, it’s not\nthe best choice in terms of both data size and performance.</p>\n<p>This article mainly focused on data size/performance of binary serialization\nlibraries for <a href=\"http://www.scala-lang.org/\">Scala</a>. Java versions are used just to compare with.</p>\n<h2 id=\"tldr\"><a href=\"#tldr\" aria-label=\"tldr permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TL;DR</h2>\n<p>Protobuf is small and fast. Scala’s implementation — ScalaPB — is robust\nand convenient. Both for many small and big messages.</p>\n<h2 id=\"use-cases\"><a href=\"#use-cases\" aria-label=\"use cases permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use cases</h2>\n<p>Many performance tests suffers from a synthetic nature of data. This test is not\nan exception, but here I test existing almost-production like data models\n(simplified a bit, of course). One case is a rich <a href=\"https://en.wikipedia.org/wiki/Data_transfer_object\">DTO</a>\n(data transfer object), the second one is a list of small\n<a href=\"http://martinfowler.com/eaaDev/EventSourcing.html\">events</a> from which a rich DTO could be reconstructed.</p>\n<h2 id=\"tested-libraries\"><a href=\"#tested-libraries\" aria-label=\"tested libraries permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tested libraries</h2>\n<p>I chose several libraries for a testing:</p>\n<ul>\n<li><a href=\"https://github.com/trueaccord/ScalaPB\">ScalaPB</a>. A Google <a href=\"https://developers.google.com/protocol-buffers/\">Protocol Buffers</a>\ncompiler implementation for Scala. All data objects are case classes, all\nprotobuf features are supported.</li>\n<li><a href=\"https://github.com/scala/pickling\">Pickling</a>. Meant to be a Scala alternative to default\n<a href=\"https://docs.oracle.com/javase/8/docs/technotes/guides/serialization/index.html\">Java serialization</a>. Uses macros to generate\nserializers/parsers (picklers/unpicklers in its terminology).</li>\n<li><a href=\"https://github.com/ochrons/boopickle\">Boopickle</a>. Custom binary format without\nbackward-compatibility. Also uses macros.</li>\n<li><a href=\"https://github.com/twitter/chill\">Chill</a>. Twitter’s extension for <a href=\"https://github.com/EsotericSoftware/kryo\">Kryo</a>.</li>\n<li><a href=\"https://twitter.github.io/scrooge/\">Scrooge</a>. A <a href=\"https://thrift.apache.org/\">Thrift</a> compiler\nimplementation for Scala.</li>\n</ul>\n<p>For Protobuf and Thrift, I also used Java implementation to check compatibility\nand performance with the original. Also, I added to comparison a default\nJava Serialization (Serializable interface + ObjectInputStream).</p>\n<p>All libraries I checked against well-known JSON serialization\nlibrary — <a href=\"https://github.com/FasterXML/jackson\">Jackson</a>.</p>\n<p>It’s worth to mention couple libraries, that I decided not to include a comparison:</p>\n<ul>\n<li><a href=\"http://www.protostuff.io/\">Protostuff</a>. An interesting library, supports\nprotobuf and its own binary format, but… It’s hard to support Scala Collections\nthere (without changes inside library it’s impossible).</li>\n<li><a href=\"http://msgpack.org/index.html\">MsgPack</a>. Scala implementation of this library doesn’t\nsupport case classes. The idea is interesting — to replace quotes, colons etc.,\nbut the gain is ~25%. Doesn’t seem to be a big deal.</li>\n</ul>\n<p>Also, I want to promote an interesting\nresearch — <a href=\"https://github.com/eishay/jvm-serializers\">JVM Serializers</a>. It’s a good starting\npoint to pick your serialization library.</p>\n<h2 id=\"test-data-models\"><a href=\"#test-data-models\" aria-label=\"test data models permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Test data models</h2>\n<p>I tested libraries against two types of data objects:</p>\n<ol>\n<li>Site — a rich data transfer object with fields, lists etc.</li>\n<li>Events — a list of simple flat objects with at most 4 flat fields.</li>\n</ol>\n<h3 id=\"site\"><a href=\"#site\" aria-label=\"site permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Site</h3>\n<p>A <a href=\"https://github.com/dkomanov/scala-serialization/blob/master/src/main/scala/com/komanov/serialization/domain/Site.scala\">rich DTO</a> consists of several fields with simple\ndata types (<a href=\"https://docs.oracle.com/javase/7/docs/api/java/util/UUID.html\">UUID</a>, dates, strings, etc) and nested\nlists of other rich objects (without back-references). Also, there are couple\nrich objects with subclasses (see an example of EntryPoint).</p>\n<p>The Site represents a web-site: contains information about pages, meta tags,\nentry points and other meta information.</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">case</span> <span class=\"token keyword\">class</span> Site<span class=\"token punctuation\">(</span>id<span class=\"token operator\">:</span> UUID<span class=\"token punctuation\">,</span>\n                ownerId<span class=\"token operator\">:</span> UUID<span class=\"token punctuation\">,</span>\n                revision<span class=\"token operator\">:</span> <span class=\"token builtin\">Long</span><span class=\"token punctuation\">,</span>\n                siteType<span class=\"token operator\">:</span> SiteType<span class=\"token punctuation\">,</span>\n                flags<span class=\"token operator\">:</span> Seq<span class=\"token punctuation\">[</span>SiteFlag<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                name<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">,</span>\n                description<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">,</span>\n                domains<span class=\"token operator\">:</span> Seq<span class=\"token punctuation\">[</span>Domain<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                defaultMetaTags<span class=\"token operator\">:</span> Seq<span class=\"token punctuation\">[</span>MetaTag<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                pages<span class=\"token operator\">:</span> Seq<span class=\"token punctuation\">[</span>Page<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                entryPoints<span class=\"token operator\">:</span> Seq<span class=\"token punctuation\">[</span>EntryPoint<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                published<span class=\"token operator\">:</span> <span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">,</span>\n                dateCreated<span class=\"token operator\">:</span> Instant<span class=\"token punctuation\">,</span>\n                dateUpdated<span class=\"token operator\">:</span> Instant<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">sealed</span> <span class=\"token keyword\">trait</span> EntryPoint\n<span class=\"token keyword\">final</span> <span class=\"token keyword\">case</span> <span class=\"token keyword\">class</span> DomainEntryPoint<span class=\"token punctuation\">(</span>domain<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">,</span>\n                                  primary<span class=\"token operator\">:</span> <span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">extends</span> EntryPoint <span class=\"token punctuation\">{</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">final</span> <span class=\"token keyword\">case</span> <span class=\"token keyword\">class</span> FreeEntryPoint<span class=\"token punctuation\">(</span>userName<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">,</span>\n                                siteName<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">,</span>\n                                primary<span class=\"token operator\">:</span> <span class=\"token builtin\">Boolean</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">extends</span> EntryPoint <span class=\"token punctuation\">{</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"events\"><a href=\"#events\" aria-label=\"events permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Events</h3>\n<p>I’ve implemented as simple as possible <a href=\"https://github.com/dkomanov/scala-serialization/blob/master/src/main/scala/com/komanov/serialization/domain/Events.scala\">event model</a>\nfor building Site snapshot (as if it was event sourced). All events are very\nsmall, represents a single change in a model (very granular):</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">sealed</span> <span class=\"token keyword\">trait</span> SiteEvent\n\n<span class=\"token keyword\">case</span> <span class=\"token keyword\">class</span> SiteCreated<span class=\"token punctuation\">(</span>id<span class=\"token operator\">:</span> UUID<span class=\"token punctuation\">,</span> ownerId<span class=\"token operator\">:</span> UUID<span class=\"token punctuation\">,</span> siteType<span class=\"token operator\">:</span> SiteType<span class=\"token punctuation\">)</span> <span class=\"token keyword\">extends</span> SiteEvent\n\n<span class=\"token keyword\">case</span> <span class=\"token keyword\">class</span> SiteNameSet<span class=\"token punctuation\">(</span>name<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">extends</span> SiteEvent\n\n<span class=\"token keyword\">case</span> <span class=\"token keyword\">class</span> SiteDescriptionSet<span class=\"token punctuation\">(</span>description<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">extends</span> SiteEvent\n\n<span class=\"token keyword\">case</span> <span class=\"token keyword\">class</span> SiteRevisionSet<span class=\"token punctuation\">(</span>revision<span class=\"token operator\">:</span> <span class=\"token builtin\">Long</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">extends</span> SiteEvent\n\n<span class=\"token keyword\">case</span> <span class=\"token keyword\">class</span> SitePublished<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">extends</span> SiteEvent\n<span class=\"token comment\">// etc</span></code></pre></div>\n<p>Events come as a sequence, ordered by a timestamp. For example, in MySQL, it could be stored in such table:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> site_events <span class=\"token punctuation\">(</span>\n  id <span class=\"token keyword\">BINARY</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">timestamp</span> <span class=\"token keyword\">BIGINT</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  event_type <span class=\"token keyword\">INT</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  event_digest <span class=\"token keyword\">MEDIUMBLOB</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>An example of how to reconstruct a Site from events\n(<a href=\"https://github.com/dkomanov/scala-serialization/blob/master/src/main/scala/com/komanov/serialization/domain/EventProcessor.scala\">EventProcessor</a>):</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">def</span> apply<span class=\"token punctuation\">(</span>list<span class=\"token operator\">:</span> Seq<span class=\"token punctuation\">[</span>SiteEventData<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Site <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  list<span class=\"token punctuation\">.</span>foldLeft<span class=\"token punctuation\">(</span>emptySite<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> SiteEventData<span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">,</span> SiteRevisionSet<span class=\"token punctuation\">(</span>rev<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> dateUpdated<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">=></span>\n      s<span class=\"token punctuation\">.</span>copy<span class=\"token punctuation\">(</span>revision <span class=\"token operator\">=</span> rev<span class=\"token punctuation\">,</span> dateUpdated <span class=\"token operator\">=</span> dateUpdated<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">case</span> <span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> SiteEventData<span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">,</span> SiteNameSet<span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">=></span>\n      s<span class=\"token punctuation\">.</span>copy<span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<h2 id=\"tests\"><a href=\"#tests\" aria-label=\"tests permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tests</h2>\n<p>There are 5 objects (Site) to test: 1k, 2k, 4k, 8k, and 64k. This mnemonic means:\n1k is the object, that is present as approximately 1 kilobyte JSON;\n2k is ~2 kilobyte JSON etc.</p>\n<p>Events are produced from these 5 objects: 1k events are events from which may be\nreconstructed a 1k object, etc.</p>\n<h3 id=\"data-size\"><a href=\"#data-size\" aria-label=\"data size permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Data size</h3>\n<p>Sizes (in bytes) for Site (rich DTO):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Converter     1k    2k    4k    8k    64k\nJSON        1060  2076  4043  8173  65835\nBoopickle    544  1130  1855  2882  16290\nProtobuf     554  1175  1930  3058  27111\nThrift       712  1441  2499  4315  38289\nChill        908  1695  2507  3643  26261\nJava        2207  3311  4549  6615  43168\nPickling    1628  2883  5576 11762  97997</code></pre></div>\n<p>BooPickle is the leader (and this is understandable — this library doesn’t\nsupport backward compatibility, so, they don’t need to save field tags). Chill\ndemonstrates better results for the very big object. Thrift is not so good\n(maybe, it’s because of implementation for optional fields).</p>\n<p>Sizes (in bytes) for events (sum for all events in list):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Converter     1k    2k    4k    8k    64k\nJSON        1277  2499  5119 10961 109539\nBoopickle    593  1220  2117  3655  42150\nProtobuf     578  1192  2076  3604  42455\nThrift       700  1430  2639  4911  57029\nChill        588  1260  2397  3981  47048\nJava        2716  5078 11538 26228 240267\nPickling    1565  3023  6284 13462 128797</code></pre></div>\n<p>Now protobuf looks even better.</p>\n<p>Protobuf, thrift, chill and boopickle are almost 2.5 times more compact than JSON.\nBig object serializes better with Java Serialization than Pickling,\nand small objects — vice versa.</p>\n<h3 id=\"data-size-and-compression\"><a href=\"#data-size-and-compression\" aria-label=\"data size and compression permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Data size and compression</h3>\n<p>Another interesting topic about data size is the compression. A compression is\nwidely used in modern systems, from databases\n(i.e. “compress” row format in <a href=\"https://dev.mysql.com/doc/refman/5.6/en/innodb-compression.html\">MySQL</a>)\nto networks (<a href=\"https://en.wikipedia.org/wiki/HTTP_compression\">GZip over HTTP</a>). So, the data size\ncould be not so important to look at. The comparison table for gzipped and raw\nobject are pretty big, I will show a small part\n(an entire table available <a href=\"https://docs.google.com/spreadsheets/d/1BpI1GCMBfk1MbXwtlHbTi-DJK2ur-VEWn7m2laQ9gos/edit?usp=sharing\">here</a>).</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Converter        site 2k  events 2k  site 8k  events 8k\nJSON (raw)          2076       2499     8173      10961\nJSON (gz)           1137       2565     2677      11784\nProtobuf (raw)      1175       1192     3058       3604\nProtobuf (gz)        898       1463     2175       5552\nThrift (raw)        1441       1430     4315       4911\nThrift (gz)          966       1669     2256       6673</code></pre></div>\n<p>Important note: events are gzipped not together, but one by one, of course,\nif it would be gzipped together, result size would be much less. It shows an\nimportance of choosing the right storage/transfer mechanism.</p>\n<p>We may see, that on small objects (less that 2k) protobuf has almost the same\nsize as gzipped JSON (so, we can save some CPU cycles).</p>\n<h3 id=\"performance\"><a href=\"#performance\" aria-label=\"performance permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Performance</h3>\n<p>The next important thing is the performance of serialization and deserialization\n(parsing). Our tests are about serializing/deserializing the raw data to Scala\nobjects. In order to simplify this testing, I converted generated classes\nto “domain” classes, so, for protobuf and thrift there is also an addition of\nobject conversion (I don’t think that the effect of this addition is significant).</p>\n<p>I excluded Java Serialization and Pickling from this chart (and other charts also)\nbecause both of them are very slow. I will write about it afterward.</p>\n<p>The code for the performance tests is in <a href=\"https://github.com/dkomanov/scala-serialization/blob/master/src/test/scala/com/komanov/serialization/converters/BasePerfTest.scala\">BasePerfTest.scala</a>.</p>\n<h3 id=\"serialization-performance\"><a href=\"#serialization-performance\" aria-label=\"serialization performance permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Serialization performance</h3>\n<p>On the following chart you may see the serialisitezation times for Site object\n(measured in nano-seconds with <a href=\"https://docs.oracle.com/javase/7/docs/api/java/lang/System.html#nanoTime%28%29\">System.nanoTime</a> method).</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 600px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/73a3a0617535270b1af0f3f786620b86/34e8a/serialization-site.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABhklEQVQoz32Sy0rDQBSG8yy+gn0A8RHcieDCreBDuPMNXBSXSkEqgrbgZdMLWlKk1EvbtGkb24wlEjXNZDKZzMVJoi2ll5+QOWTOz/efmSgiFmMMQthut1utVqfT6fV6uq4bhtHtdgEAUQfnYk5Kskin7/uU0iAIwliEkMmbJ5IE2eo4nmk6EE7N0pZsLRPHmBMiC5zNgnS6BQBGaIYcp5sTYzIx93zXNrWRJQaq17i1fqCPPGUy81Iyl9+5CIVZOM5kC8N+TX087xsmmpgnZImRT0KMgCElYTAmrrA97Wj7IndXb4hS5TskUG5PZ5ZKQv9l4TyUWRgbvjxclRvCtLS99bPrYhRFsJnTRghhjGXhIfphcUFxs5S/UYcCgOeDjcx9XfSBtrV2mivF50IThPI/GKeSrzXVk8PbqiNq1dL+5mXFENXq004qW34T+uB1N5XJF0VkmyXHI3Lquu7onchb831oWzgglBD49SkLTplrW8jHC36ShRqPnbHrrmhYZV51f7F+AYotp0SNyMT6AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Serialization times for Site (rich DTO), nano-seconds\"\n        title=\"Serialization times for Site (rich DTO), nano-seconds\"\n        src=\"/static/73a3a0617535270b1af0f3f786620b86/34e8a/serialization-site.png\"\n        srcset=\"/static/73a3a0617535270b1af0f3f786620b86/d5c4a/serialization-site.png 185w,\n/static/73a3a0617535270b1af0f3f786620b86/04e89/serialization-site.png 370w,\n/static/73a3a0617535270b1af0f3f786620b86/34e8a/serialization-site.png 600w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n      />\n  </a>\n    </span></p>\n<p>ScalaPB is the pure winner, Java protobuf and Thrift goes after.\nBooPickle and Child are slightly slower for “small” objects, and a bit better\nfor bigger objects.</p>\n<p>The next chart is serialization times for events.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 600px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9faa8ce8fafe525b9e387de6ae06ce6b/34e8a/serialization-events.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABw0lEQVQoz32SQW/TMBTH+2F24L6JG2e+ABIXxIXLDpzZB+DOgdvgiAQMTUxsExMTGqBlUwdVQaOlStMmcze3a0qSpnbsxLH9cDIorVTtL0u2n97Pf79nV6CUUopS6jiObdudTsd1Xa8UQshswzAyOVprmFflajIk51xKmWVZ/k8yl0oqysgwxqAgGdT8cQtoSvFFTOl/2GDGfPZUqfJcCcgV5bH7u2UivvXkuHmgdj/i5+t2v58yNudc3F8rM4rUyeAiRsAFoYEX2CYyOHz64s0B4EbS2vcjyllSmdY8ddZQ1DYiJZxKmkQo7gLV3WermzvWuffjW3XzDGE2hafOqeBCZqbC4RifRx7kEDvbrl+HYWKv3d768On0F1gnUS6o0jM1m/6YBR6jiIfGcBShy+QMJLivH+1++Qq9YfvujVd7Vnk1NddtxljhrAEHnSgNgGbdncenyIG29/PBzY3PTUD99p2ll+9LWMurV/sLFwEA0WjU1x/WvRCq1aPVW+9OelCrfb+38tZqQrfXvL+8sXdYNmTe2XwAZXhCyCXmmdYpp8EozXIpBA3NQmipSOAzni74JAs1mcQTQq5JuA6efb+F+gNPXZ1YTUFAiwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Serialization times for events, nano-seconds\"\n        title=\"Serialization times for events, nano-seconds\"\n        src=\"/static/9faa8ce8fafe525b9e387de6ae06ce6b/34e8a/serialization-events.png\"\n        srcset=\"/static/9faa8ce8fafe525b9e387de6ae06ce6b/d5c4a/serialization-events.png 185w,\n/static/9faa8ce8fafe525b9e387de6ae06ce6b/04e89/serialization-events.png 370w,\n/static/9faa8ce8fafe525b9e387de6ae06ce6b/34e8a/serialization-events.png 600w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n      />\n  </a>\n    </span></p>\n<p>ScalaPB still is the winner. BooPickle is very slow in this contest. Apparently,\nmany small messages are not the proper scenario for it.</p>\n<p>In terms of <a href=\"https://docs.google.com/spreadsheets/d/1BpI1GCMBfk1MbXwtlHbTi-DJK2ur-VEWn7m2laQ9gos/edit?usp=sharing\">numbers</a>, ScalaPB is faster than JSON more\nthan 2 times for a single rich DTO, and more that 4 times faster than JSON for\na list of small events.</p>\n<h3 id=\"deserialization-parsing-performance\"><a href=\"#deserialization-parsing-performance\" aria-label=\"deserialization parsing performance permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deserialization (parsing) performance</h3>\n<p>The next chart is deserialization times for Site object:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 600px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4941db7b0a1985a270379d8b1d05ecdd/34e8a/deserialization-site.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABdUlEQVQoz32Sz07CQBDGeRffgPgI3jx6NDHevRrfwXcgxosHEsNJ5eINSwypJloIAm2llkKCCC67tNvtdtfprkAIf36H7SQ733yzM81JhRACY+w4TlsBgeu6cPq+b9s2QkjnyFVy+kMIiaKIc84UiUIHcKYApYLzTI3QLAgQIUsxyCBBbifFWMQxBLRU6hcKrX6fhuGKs+5tA1CdkJTFWXmvOms+Dn9JFM7+xali3VBQCl2pgMWDhtNkrl01n0tdLwgX4qVzOndL08wQ4zRJsmCMB1cXpuG91KVRQwkjcL18M9cOaqQCBLqRhCHfaTlCen7nNF8sG7rRlWmHYUihQwlDERPYC5l8W5bVkbL39XF+eG948rPXPtq7eagoA663lps/ToAvq781ri8r70zWjOrZwV0tkKb5epy/fbKk6zdO9ovlihRrzkJV4wRPB9044TAnPBpGMYO9k/GIxgksGf8Mw4hu+Ek2Mp2iKcY7EnaJt+1vwR9OuqoaXn6SUwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Deserialization times for Site (rich DTO), nano-seconds\"\n        title=\"Deserialization times for Site (rich DTO), nano-seconds\"\n        src=\"/static/4941db7b0a1985a270379d8b1d05ecdd/34e8a/deserialization-site.png\"\n        srcset=\"/static/4941db7b0a1985a270379d8b1d05ecdd/d5c4a/deserialization-site.png 185w,\n/static/4941db7b0a1985a270379d8b1d05ecdd/04e89/deserialization-site.png 370w,\n/static/4941db7b0a1985a270379d8b1d05ecdd/34e8a/deserialization-site.png 600w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n      />\n  </a>\n    </span></p>\n<p>ScalaPB is the winner. BooPickle looks much better, apparently, there are many\noptimizations during the serialization that costs a lot.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 600px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b1557d2343d5f7c34d9ed01264c09939/34e8a/deserialization-events.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABnElEQVQoz31S3UoCQRj1ZeoFgqD3sNugoAfputuuIoIuLAorIVCIoMytjMJ+TZRW3TVX1vwpZ5yZnd2Z6Zs1Mks8F7NnZr+zZ77zbUSFkFIihEzTLIUAUi6XLcsCYts2cErpoFD9QmTwwBjD6yAIeAjf9/UKW4w5YzwIBKWe59XbffWJcL0Oy1AMMiGE+geBsfR9zRhvO6Wds5KfSDob60XHYYSMOA/uPwR8FGPBuQDqqWZ2M3aYUW9P/cJxs4sp6X+LRYgfQ+0WbrUz5/rI/XDWlvaOjFrl/iYbr1p18iMeOguhDRESnqfD8ehHBz1bSJXt18WZg5PMY14Z112fY6gb9gwAQykCbUio5sBa3Up8NZbKKbtRnJ/aSV2EiYuRtAkhjDFJKaSs83FdMx0/f3HVbe45Oh03CqrqlKJT20kjzCWQ8pcYOgRH//bmYWvlsohV+tRYnktcVdXdXW5hdt/IK7OWX5jZTWXCSY86Q7QQKbTaa1iMC2gYd1oMJg2k/c48LgOB2k1C2ZifZCx6vc8eQhMKJon/zO8/vgCKeaFWvvxr+gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Deserialization times for events, nano-seconds\"\n        title=\"Deserialization times for events, nano-seconds\"\n        src=\"/static/b1557d2343d5f7c34d9ed01264c09939/34e8a/deserialization-events.png\"\n        srcset=\"/static/b1557d2343d5f7c34d9ed01264c09939/d5c4a/deserialization-events.png 185w,\n/static/b1557d2343d5f7c34d9ed01264c09939/04e89/deserialization-events.png 370w,\n/static/b1557d2343d5f7c34d9ed01264c09939/34e8a/deserialization-events.png 600w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n      />\n  </a>\n    </span></p>\n<p>For events, the fastest library is Java Protobuf\n(I don’t know why, but it confirmed after several runs).</p>\n<p>ScalaPB is ~3 times faster for rich DTO and ~3–4 times faster than JSON for\na list of small events. Numbers are 2 microseconds vs. 7 microseconds for 1k Site\nand 3 microseconds vs. 12 microseconds for 1k events.</p>\n<h3 id=\"java-serialization-and-pickling\"><a href=\"#java-serialization-and-pickling\" aria-label=\"java serialization and pickling permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Java Serialization and Pickling</h3>\n<p>Pickling performance is surprisingly bad. I think I missed something and did\nit wrong (I used all tips from its manual), but Pickling is the slowest\nlibrary in this test.</p>\n<p>Just to compare its performance. Serialization of a rich DTO:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Converter         1k     2k     4k     8k     64k\nJSON            4365   8437  16771  35164  270175\nSerializable   13156  21203  36457  79045  652942\nPickling       53991  83601 220440 589888 4162785</code></pre></div>\n<p>Deserialization of a rich DTO:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Converter        1k     2k     4k     8k     64k\nJSON           7670  12964  24804  51578  384623\nSerializable  61455  84196 102870 126839  575232\nPickling      40337  63840 165109 446043 3201348</code></pre></div>\n<h2 id=\"conclusion\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>As expected, binary serialization is faster and produce less data. ScalaPB showed\nvery good results (and the protobuf format in general).</p>\n<p>Nevertheless, performance and data size are not enough to make a decision to move\nfrom using JSON to protobuf. But, it’s important to know how much does it cost.</p>\n<p>Originally posted on <a href=\"https://medium.com/@dkomanov/scala-serialization-419d175c888a\">Medium</a>.</p>","fields":{"slug":"/p/scala-serialization/"},"frontmatter":{"rawDate":"2016-06-12T00:00:00.000Z","date":"June 12, 2016","title":"Scala Serialization","description":"Performance comparison of popular serialization libraries for Scala...","tags":["scala","serialization","benchmark","performance"],"canonicalUrl":"https://medium.com/@dkomanov/scala-serialization-419d175c888a","cover":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/p/scala-serialization/","previous":{"fields":{"slug":"/p/one-more-threat-of-mockito/"}},"next":{"fields":{"slug":"/p/scala-serialization-updated/"}}}}}