{"componentChunkName":"component---src-templates-blog-post-js","path":"/p/writing-async-app-in-scala-part-4-rewrite-blocking-app/","result":{"data":{"markdownRemark":{"id":"06125c06-1ba2-57f9-bca0-93c637d0478a","excerpt":"Part 1. Coding.  Part 2. Exception Handling.  Part 3. Threading Model.  Part 4. Rewriting Existing App.  Part 5. What’s next? It’s been a while since the last…","html":"<blockquote>\n<p><a href=\"/p/writing-async-app-in-scala-part-1-coding\">Part 1. Coding.</a> <br>\n<a href=\"/p/writing-async-app-in-scala-part-2-exception-handling\">Part 2. Exception Handling.</a> <br>\n<a href=\"/p/writing-async-app-in-scala-part-3-threading-model\">Part 3. Threading Model.</a> <br>\nPart 4. Rewriting Existing App. <br>\nPart 5. What’s next?</p>\n</blockquote>\n<p>It’s been a while since the last blog post. Now it’s time to cover one less technical but arguable more important topic: how to rewrite an existing blocking application to be async. As mentioned before, I leave the reasoning behind this rewrite behind, assuming this is what we need.</p>\n<p>This post is mostly about the mechanics of the rewrite: how to prepare code before rewrite, what’s need to be done to rewrite code in a safe manner, how to avoid code duplication, etc. Also, it’s not really related to Scala, all these principles apply to a rewrite for any language, however, it has a few examples in Scala, obviously.</p>\n<h2 id=\"the-goal\" style=\"position:relative;\"><a href=\"#the-goal\" aria-label=\"the goal permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Goal</h2>\n<p>TBD: explain the rewrite should be safe, code clean and experience nice.</p>\n<p>The goal of the rewrite</p>\n<h2 id=\"prepare-an-existing-app\" style=\"position:relative;\"><a href=\"#prepare-an-existing-app\" aria-label=\"prepare an existing app permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Prepare an Existing App</h2>\n<p>We know some software engineering principles like <a href=\"https://en.wikipedia.org/wiki/Separation_of_concerns\">Separation of Concerns</a> or <a href=\"https://blog.codinghorror.com/curlys-law-do-one-thing/\">Do One Thing</a> and <a href=\"https://www.d.umn.edu/~gshute/softeng/principles.html\">other</a>. All of them describe how to write code. However, it applies not only to code itself. It also may be applied to a process of writing code.</p>\n<p>How’d we apply it here? Well… What we want to do is to safely rewrite an application, minimizing amount of bugs. In order to do it, we need to avoid doing anything other than rewrite - separate concerns! It’s very important not to perform any refactoring along the way, leave it for the later stage.</p>\n<p>What is desirable to have before the rewrite:</p>\n<ul>\n<li>The design of an application should be more or less okay, so you don’t need to redesign it along the way.</li>\n<li>Test coverage should be sufficient. It’s necessary to be sure that nothing will break in a business logic during rewrite (it’s hard to predict what’s going to break in production from the technical point of view in an async application).</li>\n</ul>\n<p>If your existing application lacks tests or has some problems in its internal design, it’s better to fix those issues first, before the rewrite.</p>\n<p>You may ask, why is it bad to introduce some improvements in async version of the application? Personally, I am an advocate for the incremental changes: I do like to rewrite stuff from the scratch, however, it’s safer and more predictable in terms of timeline and efforts needed. Also, it allows to reuse tests, including unit tests.</p>\n<h2 id=\"what-were-going-to-rewrite\" style=\"position:relative;\"><a href=\"#what-were-going-to-rewrite\" aria-label=\"what were going to rewrite permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What we’re going to rewrite</h2>\n<p>For simplicity, our blocking application is an RPC server (just to avoid unnecessary details of protocol) connected to a database:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token comment\">// RPC</span>\n<span class=\"token keyword\">trait</span> MovieApi <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">def</span> rate<span class=\"token punctuation\">(</span>id<span class=\"token operator\">:</span> <span class=\"token builtin\">Long</span><span class=\"token punctuation\">,</span> rating<span class=\"token operator\">:</span> <span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Unit</span>\n  <span class=\"token keyword\">def</span> get<span class=\"token punctuation\">(</span>id<span class=\"token operator\">:</span> <span class=\"token builtin\">Long</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Movie\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">case</span> <span class=\"token keyword\">class</span> Movie<span class=\"token punctuation\">(</span>id<span class=\"token operator\">:</span> <span class=\"token builtin\">Long</span><span class=\"token punctuation\">,</span> title<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">,</span> year<span class=\"token operator\">:</span> <span class=\"token builtin\">Int</span><span class=\"token punctuation\">,</span> rating<span class=\"token operator\">:</span> <span class=\"token builtin\">Double</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// Database</span>\n<span class=\"token keyword\">trait</span> MovieDao <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">def</span> rate<span class=\"token punctuation\">(</span>id<span class=\"token operator\">:</span> <span class=\"token builtin\">Long</span><span class=\"token punctuation\">,</span> rating<span class=\"token operator\">:</span> <span class=\"token builtin\">Int</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Unit</span>\n  <span class=\"token keyword\">def</span> find<span class=\"token punctuation\">(</span>id<span class=\"token operator\">:</span> <span class=\"token builtin\">Long</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> MovieDto\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">case</span> <span class=\"token keyword\">class</span> MovieDto<span class=\"token punctuation\">(</span>id<span class=\"token operator\">:</span> <span class=\"token builtin\">Long</span><span class=\"token punctuation\">,</span> title<span class=\"token operator\">:</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">,</span> year<span class=\"token operator\">:</span> <span class=\"token builtin\">Int</span><span class=\"token punctuation\">,</span> ratingSum<span class=\"token operator\">:</span> <span class=\"token builtin\">Long</span><span class=\"token punctuation\">,</span> ratedCount<span class=\"token operator\">:</span> <span class=\"token builtin\">Long</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Essentially, we need to rewrite only this part and its implementation. What should be prepared in advance is infrastructure for an async application: async RPC server, async database driver (if exists, if not - we will use <a href=\"https://medium.com/wix-engineering/writing-async-app-in-scala-part-3-threading-model-ef9e9033bd33#0f07\">blocking</a> one) and other necessary parts like HTTP client, RPC client, etc.</p>\n<h2 id=\"where-to-start\" style=\"position:relative;\"><a href=\"#where-to-start\" aria-label=\"where to start permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Where to start?</h2>\n<p>Suppose, you already have a skeleton for a new service that just waits for the implementation of the async version of <code class=\"language-text\">MovieApi</code>. Now we need to understand, how to approach rewrite, which things</p>\n<p>We write a separate deployable.\nAll infrastructure should be prepared in advance (skipping this part, only introduce RequestContext).</p>\n<p>make sure that old service has more or less good design and coverage\ncycle:</p>\n<ul>\n<li>write async implementation</li>\n<li>use it in sync version and run all tests</li>\n<li>delete sync version, rewrite tests, rewire sync code</li>\n<li>commit it all in order to preserve history</li>\n</ul>","fields":{"slug":"/p/writing-async-app-in-scala-part-4-rewrite-blocking-app/"},"frontmatter":{"rawDate":"2020-07-17T00:00:00.000Z","date":"July 17, 2020","title":"Writing Async App in Scala. Part 4: Rewrite Blocking App","description":"TBD","tags":["scala","async","blocking","rewrite","refactoring"],"canonicalUrl":"TBD","cover":null}}},"pageContext":{"slug":"/p/writing-async-app-in-scala-part-4-rewrite-blocking-app/","previous":{"fields":{"slug":"/p/writing-async-app-in-scala-part-3-threading-model/"}},"next":{"fields":{"slug":"/p/benchmarking-batch-jdbc-queries/"}}}},"staticQueryHashes":["3675711862"]}